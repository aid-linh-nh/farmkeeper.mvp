<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thi·∫øt l·∫≠p Chi ti·∫øt C√¥ng vi·ªác & Chi ph√≠</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
            background: rgba(0, 0, 0, 0.5);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            line-height: 1.6;
        }
        
        .modal-container {
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 1200px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .header-left {
            flex: 1;
        }
        
        .header-left h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .header-left p {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        .header-stats {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .stat-item {
            text-align: center;
            min-width: 60px;
        }
        
        .stat-number {
            font-size: 1.25rem;
            font-weight: 700;
        }
        
        .stat-label {
            font-size: 0.7rem;
            opacity: 0.8;
        }
        
        .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.25rem;
            margin-left: 1rem;
            transition: all 0.2s ease;
        }
        
        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .modal-body {
            overflow-y: auto;
            flex: 1;
            padding: 1.5rem;
        }
        
        .section {
            margin-bottom: 1.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .section-header {
            background: #f9fafb;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-title {
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .section-cost {
            font-size: 0.875rem;
            font-weight: 700;
            color: #059669;
        }
        
        .section-icon {
            width: 20px;
            height: 20px;
            background: #10b981;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }
        
        .section-body {
            padding: 1rem;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
        }

        .form-grid-4 {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1.5fr;
            gap: 1rem;
        }

        .form-grid-5 {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr 1fr 1fr;
            gap: 1rem;
        }

        .form-grid-6 {
            display: grid;
            grid-template-columns: 1.5fr 0.8fr 1fr 0.8fr 1fr 1.2fr;
            gap: 1rem;
        }
        
        .form-group {
            position: relative;
        }
        
        .form-group.span-full {
            grid-column: 1 / -1;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
            font-size: 0.875rem;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 0.625rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            background: #ffffff;
        }

        input[readonly] {
            background: #f3f4f6;
            color: #6b7280;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.1);
        }
        
        textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .btn-calculate {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .btn-purple {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .btn-indigo {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        }
        
        .btn-sm {
            padding: 0.375rem 0.5rem;
            font-size: 0.75rem;
        }
        
        .condition-item, .material-item, .tool-item, .parameter-item, .labor-item, .service-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .item-title {
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
        }
        
        .item-badge {
            background: #10b981;
            color: white;
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 500;
            margin-right: 0.5rem;
        }

        .parameter-badge {
            background: #f59e0b;
        }

        .labor-badge {
            background: #8b5cf6;
        }

        .service-badge {
            background: #6366f1;
        }

        .cost-badge {
            background: #059669;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        
        .condition-types {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .condition-type {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        
        .condition-type:hover {
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        .condition-type.selected {
            border-color: #10b981;
            background: #ecfdf5;
        }
        
        .condition-type-icon {
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
        }
        
        .condition-type-title {
            font-weight: 600;
            color: #374151;
            font-size: 0.8rem;
            margin-bottom: 0.125rem;
        }
        
        .condition-type-desc {
            font-size: 0.7rem;
            color: #6b7280;
        }
        
        .environmental-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }
        
        .range-input {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .range-input input {
            flex: 1;
            min-width: 60px;
        }
        
        .range-input span {
            font-size: 0.75rem;
            color: #6b7280;
        }
        
        .quantity-input {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .quantity-input input {
            flex: 1;
        }
        
        .quantity-input select {
            width: 100px;
        }
        
        .file-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 6px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .file-upload-area:hover {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .file-upload-area.compact {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
        }
        
        .upload-icon {
            font-size: 1.5rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }
        
        .upload-text {
            color: #6b7280;
            font-size: 0.8rem;
        }
        
        .file-list {
            margin-top: 0.75rem;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem;
            background: #f3f4f6;
            border-radius: 4px;
            margin-bottom: 0.25rem;
            font-size: 0.8rem;
        }
        
        .safety-notes {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #f59e0b;
            border-radius: 6px;
            padding: 0.75rem;
        }
        
        .safety-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: #92400e;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .calculation-result {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 1px solid #3b82f6;
            border-radius: 6px;
            padding: 0.75rem;
            margin-top: 0.5rem;
            font-weight: 600;
            color: #1e40af;
        }

        .cost-summary {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 1px solid #10b981;
            border-radius: 6px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .cost-summary-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: #047857;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .cost-breakdown {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .cost-item {
            text-align: center;
            padding: 0.75rem;
            background: white;
            border-radius: 6px;
            border: 1px solid #d1fae5;
        }

        .cost-item-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #047857;
        }

        .cost-item-label {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .total-cost {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .total-cost-value {
            font-size: 1.875rem;
            font-weight: 800;
            margin-bottom: 0.25rem;
        }

        .total-cost-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .parameter-quick-templates {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .modal-footer {
            background: #f9fafb;
            padding: 1rem 1.5rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 1rem;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .progress-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .progress-bar {
            width: 120px;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            transition: width 0.3s ease;
        }
        
        .progress-text {
            font-size: 0.8rem;
            color: #6b7280;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.75rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            padding: 0.625rem 1.25rem;
            font-weight: 600;
        }
        
        .quick-templates {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .currency {
            color: #059669;
            font-weight: 600;
        }
        
        @media (max-width: 768px) {
            .modal-container {
                width: 95vw;
                max-height: 95vh;
            }
            
            .modal-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .header-stats {
                justify-content: center;
            }
            
            .form-grid,
            .form-grid-3,
            .form-grid-4,
            .form-grid-5,
            .form-grid-6 {
                grid-template-columns: 1fr;
            }
            
            .condition-types {
                flex-direction: column;
            }
            
            .environmental-grid {
                grid-template-columns: 1fr;
            }
            
            .cost-breakdown {
                grid-template-columns: 1fr;
            }
            
            .modal-footer {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .action-buttons {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="modal-container">
        <div class="modal-header">
            <div class="header-left">
                <h1>üîß Thi·∫øt l·∫≠p Chi ti·∫øt C√¥ng vi·ªác & Chi ph√≠</h1>
                <p><strong>L√†m ƒë·∫•t v√† b√≥n ph√¢n c∆° b·∫£n</strong> - Chu·∫©n b·ªã v√† x·ª≠ l√Ω ƒë·∫•t</p>
            </div>
            <div class="header-stats">
                <div class="stat-item">
                    <div class="stat-number" id="conditions-count">0</div>
                    <div class="stat-label">ƒêi·ªÅu ki·ªán</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="parameters-count">0</div>
                    <div class="stat-label">Tham s·ªë</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="materials-count">0</div>
                    <div class="stat-label">V·∫≠t t∆∞</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="tools-count">0</div>
                    <div class="stat-label">C√¥ng c·ª•</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="labor-count">0</div>
                    <div class="stat-label">Nh√¢n c√¥ng</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="total-cost">0</div>
                    <div class="stat-label">T·ªïng chi ph√≠</div>
                </div>
            </div>
            <button class="close-btn" onclick="closeModal()">‚úï</button>
        </div>
        
        <div class="modal-body">
            <!-- Quick Templates -->
            <div class="quick-templates">
                <button class="btn btn-sm btn-secondary" onclick="applyTemplate('soil-preparation')">üå± Chu·∫©n b·ªã ƒë·∫•t</button>
                <button class="btn btn-sm btn-secondary" onclick="applyTemplate('fertilizer-application')">üß™ B√≥n ph√¢n</button>
                <button class="btn btn-sm btn-secondary" onclick="applyTemplate('pest-control')">üêõ Ph√≤ng tr·ª´ s√¢u b·ªánh</button>
                <button class="btn btn-sm btn-secondary" onclick="applyTemplate('irrigation')">üíß T∆∞·ªõi n∆∞·ªõc</button>
            </div>

            <!-- T·ªïng quan chi ph√≠ -->
            <div class="cost-summary">
                <div class="cost-summary-title">
                    üí∞ T·ªïng quan chi ph√≠ c√¥ng vi·ªác
                </div>
                <div class="cost-breakdown">
                    <div class="cost-item">
                        <div class="cost-item-value" id="materials-total">0 VNƒê</div>
                        <div class="cost-item-label">V·∫≠t t∆∞</div>
                    </div>
                    <div class="cost-item">
                        <div class="cost-item-value" id="labor-total">0 VNƒê</div>
                        <div class="cost-item-label">Nh√¢n c√¥ng</div>
                    </div>
                    <div class="cost-item">
                        <div class="cost-item-value" id="tools-total">0 VNƒê</div>
                        <div class="cost-item-label">C√¥ng c·ª•</div>
                    </div>
                </div>
                <div class="total-cost">
                    <div class="total-cost-value" id="grand-total">0 VNƒê</div>
                    <div class="total-cost-label">T·ªïng chi ph√≠ c√¥ng vi·ªác</div>
                </div>
            </div>

            <!-- M√¥ t·∫£ v√† h∆∞·ªõng d·∫´n -->
            <div class="section">
                <div class="section-header">
                    <h3 class="section-title">
                        <span class="section-icon">üìù</span>
                        M√¥ t·∫£ v√† h∆∞·ªõng d·∫´n chi ti·∫øt
                    </h3>
                </div>
                <div class="section-body">
                    <div class="form-group span-full">
                        <label for="detailed-description">M√¥ t·∫£ chi ti·∫øt c√¥ng vi·ªác</label>
                        <textarea id="detailed-description" rows="3" placeholder="M√¥ t·∫£ chi ti·∫øt c√°ch th·ª±c hi·ªán c√¥ng vi·ªác..."></textarea>
                    </div>
                    
                    <div class="form-group span-full">
                        <label for="step-by-step">H∆∞·ªõng d·∫´n t·ª´ng b∆∞·ªõc</label>
                        <textarea id="step-by-step" rows="4" placeholder="B∆∞·ªõc 1: ...&#10;B∆∞·ªõc 2: ...&#10;B∆∞·ªõc 3: ..."></textarea>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="video-link">Link video h∆∞·ªõng d·∫´n</label>
                            <input type="url" id="video-link" placeholder="https://youtube.com/watch?v=...">
                        </div>
                        <div class="form-group">
                            <label for="reference-link">Link t√†i li·ªáu tham kh·∫£o</label>
                            <input type="url" id="reference-link" placeholder="https://...">
                        </div>
                    </div>
                    
                    <div class="form-group span-full">
                        <label>T√†i li·ªáu ƒë√≠nh k√®m</label>
                        <div class="file-upload-area" onclick="document.getElementById('file-input').click()">
                            <div class="upload-icon">üìé</div>
                            <div class="upload-text">
                                <strong>Ch·ªçn file</strong> ho·∫∑c k√©o th·∫£ (PDF, DOC, JPG, PNG, MP4 - max 10MB)
                            </div>
                            <input type="file" id="file-input" multiple style="display: none;" onchange="handleFileUpload(this)">
                        </div>
                        <div id="file-list" class="file-list"></div>
                    </div>
                </div>
            </div>

            <!-- Tham s·ªë k·ªπ thu·∫≠t -->
            <div class="section">
                <div class="section-header">
                    <h3 class="section-title">
                        <span class="section-icon">üìê</span>
                        Tham s·ªë k·ªπ thu·∫≠t v√† t√≠nh to√°n
                    </h3>
                </div>
                <div class="section-body">
                    <div class="parameter-quick-templates">
                        <button class="btn btn-sm btn-calculate" onclick="applyParameterTemplate('planting-spacing')">üå± Quy c√°ch tr·ªìng</button>
                        <button class="btn btn-sm btn-calculate" onclick="applyParameterTemplate('fertilizer-dosage')">üß™ Li·ªÅu l∆∞·ª£ng ph√¢n</button>
                        <button class="btn btn-sm btn-calculate" onclick="applyParameterTemplate('irrigation-rate')">üíß T·ªëc ƒë·ªô t∆∞·ªõi</button>
                        <button class="btn btn-sm btn-calculate" onclick="applyParameterTemplate('pest-concentration')">üêõ N·ªìng ƒë·ªô thu·ªëc</button>
                    </div>
                    
                    <div id="parameters-container"></div>
                    <button type="button" class="btn btn-sm btn-calculate" onclick="addParameter()">‚ûï Th√™m tham s·ªë</button>
                    <button type="button" class="btn btn-sm btn-primary" onclick="calculateAllParameters()">üßÆ T√≠nh to√°n t·∫•t c·∫£</button>
                </div>
            </div>

            <!-- ƒêi·ªÅu ki·ªán k√≠ch ho·∫°t -->
            <div class="section">
                <div class="section-header">
                    <h3 class="section-title">
                        <span class="section-icon">üîÑ</span>
                        ƒêi·ªÅu ki·ªán k√≠ch ho·∫°t ti·∫øn h√†nh
                    </h3>
                </div>
                <div class="section-body">
                    <div class="condition-types">
                        <div class="condition-type" onclick="selectConditionType('sequential')">
                            <div class="condition-type-icon">‚è≠Ô∏è</div>
                            <div class="condition-type-title">Tu·∫ßn t·ª±</div>
                            <div class="condition-type-desc">Sau c√¥ng vi·ªác kh√°c</div>
                        </div>
                        <div class="condition-type" onclick="selectConditionType('environmental')">
                            <div class="condition-type-icon">üå°Ô∏è</div>
                            <div class="condition-type-title">M√¥i tr∆∞·ªùng</div>
                            <div class="condition-type-desc">Th√¥ng s·ªë t·ª± nhi√™n</div>
                        </div>
                        <div class="condition-type" onclick="selectConditionType('field-assessment')">
                            <div class="condition-type-icon">üë®‚Äçüåæ</div>
                            <div class="condition-type-title">Th·ª±c ƒë·ªãa</div>
                            <div class="condition-type-desc">Quan s√°t KTV</div>
                        </div>
                    </div>
                    
                    <div id="conditions-container"></div>
                    <button type="button" class="btn btn-sm" onclick="addCondition()">‚ûï Th√™m ƒëi·ªÅu ki·ªán</button>
                </div>
            </div>

            <!-- V·∫≠t t∆∞ s·ª≠ d·ª•ng -->
            <div class="section">
                <div class="section-header">
                    <h3 class="section-title">
                        <span class="section-icon">üß™</span>
                        V·∫≠t t∆∞ s·ª≠ d·ª•ng
                    </h3>
                    <div class="section-cost" id="materials-section-cost">0 VNƒê</div>
                </div>
                <div class="section-body">
                    <div id="materials-container"></div>
                    <button type="button" class="btn btn-sm" onclick="addMaterial()">‚ûï Th√™m v·∫≠t t∆∞</button>
                </div>
            </div>

            <!-- C√¥ng c·ª• c·∫ßn thi·∫øt -->
            <div class="section">
                <div class="section-header">
                    <h3 class="section-title">
                        <span class="section-icon">üî®</span>
                        C√¥ng c·ª• c·∫ßn thi·∫øt
                    </h3>
                    <div class="section-cost" id="tools-section-cost">0 VNƒê</div>
                </div>
                <div class="section-body">
                    <div id="tools-container"></div>
                    <button type="button" class="btn btn-sm" onclick="addTool()">‚ûï Th√™m c√¥ng c·ª•</button>
                </div>
            </div>

            <!-- Nh√¢n c√¥ng -->
            <div class="section">
                <div class="section-header">
                    <h3 class="section-title">
                        <span class="section-icon">üë•</span>
                        Nh√¢n c√¥ng
                    </h3>
                    <div class="section-cost" id="labor-section-cost">0 VNƒê</div>
                </div>
                <div class="section-body">
                    <div id="labor-container"></div>
                    <button type="button" class="btn btn-sm btn-purple" onclick="addLabor()">‚ûï Th√™m nh√¢n c√¥ng</button>
                </div>
            </div>

            <!-- Thu√™ kho√°n d·ªãch v·ª• -->
            <div class="section">
                <div class="section-header">
                    <h3 class="section-title">
                        <span class="section-icon">üöõ</span>
                        Thu√™ kho√°n d·ªãch v·ª•
                    </h3>
                    <div class="section-cost" id="services-section-cost">0 VNƒê</div>
                </div>
                <div class="section-body">
                    <div id="services-container"></div>
                    <button type="button" class="btn btn-sm btn-indigo" onclick="addService()">‚ûï Th√™m d·ªãch v·ª•</button>
                </div>
            </div>

            <!-- Ghi ch√∫ an to√†n -->
            <div class="section">
                <div class="section-header">
                    <h3 class="section-title">
                        <span class="section-icon">‚ö†Ô∏è</span>
                        Ghi ch√∫ an to√†n
                    </h3>
                </div>
                <div class="section-body">
                    <div class="safety-notes">
                        <div class="safety-title">üõ°Ô∏è L∆∞u √Ω an to√†n quan tr·ªçng</div>
                        <textarea rows="3" placeholder="Nh·∫≠p c√°c l∆∞u √Ω an to√†n: s·ª≠ d·ª•ng ƒë·ªì b·∫£o h·ªô, tr√°nh h√≥a ch·∫•t, ki·ªÉm tra th·ªùi ti·∫øt..."></textarea>
                    </div>
                    
                    <div class="form-grid" style="margin-top: 0.75rem;">
                        <div class="form-group">
                            <label>Thi·∫øt b·ªã b·∫£o h·ªô b·∫Øt bu·ªôc</label>
                            <textarea rows="2" placeholder="GƒÉng tay, kh·∫©u trang, k√≠nh b·∫£o h·ªô..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>C·∫•m th·ª±c hi·ªán khi</label>
                            <textarea rows="2" placeholder="Tr·ªùi m∆∞a, gi√≥ l·ªõn, nhi·ªát ƒë·ªô >35¬∞C..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="modal-footer">
            <div class="progress-section">
                <div class="progress-bar">
                    <div class="progress-fill" id="completion-progress" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="completion-text">0% ho√†n th√†nh</div>
            </div>
            
            <div class="action-buttons">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">‚ùå H·ªßy</button>
                <button type="button" class="btn btn-secondary" onclick="saveAsDraft()">üíæ L∆∞u nh√°p</button>
                <button type="button" class="btn btn-calculate" onclick="exportCostReport()">üìä Xu·∫•t b√°o c√°o</button>
                <button type="button" class="btn btn-primary" onclick="saveDetails()">‚úÖ L∆∞u chi ti·∫øt</button>
            </div>
        </div>
    </div>

    <script>
        let conditionCounter = 0;
        let materialCounter = 0;
        let toolCounter = 0;
        let parameterCounter = 0;
        let laborCounter = 0;
        let serviceCounter = 0;
        let selectedConditionType = '';
        let uploadedFiles = [];

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount) + ' VNƒê';
        }

        function calculateTotalCosts() {
            let materialsCost = 0;
            let toolsCost = 0;
            let laborCost = 0;
            let servicesCost = 0;

            // T√≠nh t·ªïng chi ph√≠ v·∫≠t t∆∞
            document.querySelectorAll('.material-item').forEach(item => {
                const totalInput = item.querySelector('input[id*="material-total-"]');
                if (totalInput && totalInput.value) {
                    materialsCost += parseFloat(totalInput.value.replace(/[^\d]/g, '')) || 0;
                }
            });

            // T√≠nh t·ªïng chi ph√≠ c√¥ng c·ª•
            document.querySelectorAll('.tool-item').forEach(item => {
                const totalInput = item.querySelector('input[id*="tool-total-"]');
                if (totalInput && totalInput.value) {
                    toolsCost += parseFloat(totalInput.value.replace(/[^\d]/g, '')) || 0;
                }
            });

            // T√≠nh t·ªïng chi ph√≠ nh√¢n c√¥ng
            document.querySelectorAll('.labor-item').forEach(item => {
                const totalInput = item.querySelector('input[id*="labor-total-"]');
                if (totalInput && totalInput.value) {
                    laborCost += parseFloat(totalInput.value.replace(/[^\d]/g, '')) || 0;
                }
            });

            // T√≠nh t·ªïng chi ph√≠ d·ªãch v·ª•
            document.querySelectorAll('.service-item').forEach(item => {
                const totalInput = item.querySelector('input[id*="service-total-"]');
                if (totalInput && totalInput.value) {
                    servicesCost += parseFloat(totalInput.value.replace(/[^\d]/g, '')) || 0;
                }
            });

            const grandTotal = materialsCost + toolsCost + laborCost + servicesCost;

            // C·∫≠p nh·∫≠t UI
            document.getElementById('materials-total').textContent = formatCurrency(materialsCost);
            document.getElementById('labor-total').textContent = formatCurrency(laborCost);
            document.getElementById('tools-total').textContent = formatCurrency(toolsCost);
            document.getElementById('grand-total').textContent = formatCurrency(grandTotal);
            
            document.getElementById('materials-section-cost').textContent = formatCurrency(materialsCost);
            document.getElementById('tools-section-cost').textContent = formatCurrency(toolsCost);
            document.getElementById('labor-section-cost').textContent = formatCurrency(laborCost);
            document.getElementById('services-section-cost').textContent = formatCurrency(servicesCost);

            // C·∫≠p nh·∫≠t header stats
            document.getElementById('total-cost').textContent = Math.round(grandTotal / 1000) + 'k';
        }

        function calculateItemCost(itemType, id) {
            const item = document.getElementById(`${itemType}-${id}`);
            if (!item) return;

            const quantity = parseFloat(item.querySelector(`input[id*="${itemType}-quantity-${id}"]`)?.value) || 0;
            const price = parseFloat(item.querySelector(`input[id*="${itemType}-price-${id}"]`)?.value) || 0;
            
            const total = quantity * price;
            const totalInput = item.querySelector(`input[id*="${itemType}-total-${id}"]`);
            if (totalInput) {
                totalInput.value = formatCurrency(total);
            }

            calculateTotalCosts();
        }

        function selectConditionType(type) {
            selectedConditionType = type;
            document.querySelectorAll('.condition-type').forEach(el => el.classList.remove('selected'));
            event.target.closest('.condition-type').classList.add('selected');
        }

        function addParameter() {
            parameterCounter++;
            const container = document.getElementById('parameters-container');
            
            const parameterHtml = `
                <div class="parameter-item" id="parameter-${parameterCounter}">
                    <div class="item-header">
                        <div class="item-title">
                            <span class="item-badge parameter-badge">Tham s·ªë ${parameterCounter}</span>
                        </div>
                        <div>
                            <button class="btn btn-calculate btn-sm" onclick="calculateParameter(${parameterCounter})">üßÆ T√≠nh to√°n</button>
                            <button class="btn btn-danger btn-sm" onclick="removeParameter(${parameterCounter})">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="form-grid-4">
                        <div class="form-group">
                            <label>T√™n tham s·ªë</label>
                            <input type="text" id="param-name-${parameterCounter}" placeholder="Quy c√°ch tr·ªìng, Li·ªÅu ph√¢n...">
                        </div>
                        <div class="form-group">
                            <label>Gi√° tr·ªã tham s·ªë</label>
                            <input type="text" id="param-value-${parameterCounter}" placeholder="8x8, 100, 2.5...">
                        </div>
                        <div class="form-group">
                            <label>ƒê∆°n v·ªã t√≠nh</label>
                            <select id="param-unit-${parameterCounter}">
                                <option value="m">m (m√©t)</option>
                                <option value="kg/ha">kg/ha</option>
                                <option value="g/m2">g/m¬≤</option>
                                <option value="l/ha">l/ha</option>
                                <option value="c√¢y/ha">c√¢y/ha</option>
                                <option value="ml/l">ml/l</option>
                                <option value="%">% (ph·∫ßn trƒÉm)</option>
                                <option value="ng√†y">ng√†y</option>
                                <option value="tu·∫ßn">tu·∫ßn</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>K·∫øt qu·∫£ d·ª± to√°n</label>
                            <input type="text" id="param-result-${parameterCounter}" readonly placeholder="S·∫Ω t·ª± ƒë·ªông t√≠nh...">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Di·ªán t√≠ch √°p d·ª•ng (ha)</label>
                            <input type="number" id="param-area-${parameterCounter}" placeholder="1.0" step="0.1" min="0">
                        </div>
                        <div class="form-group">
                            <label>C√¥ng th·ª©c t√≠nh</label>
                            <select id="param-formula-${parameterCounter}" onchange="updateFormulaDescription(${parameterCounter})">
                                <option value="density">M·∫≠t ƒë·ªô tr·ªìng (c√¢y/ha)</option>
                                <option value="dosage">Li·ªÅu l∆∞·ª£ng (kg/ha ho·∫∑c l/ha)</option>
                                <option value="concentration">N·ªìng ƒë·ªô pha ch·∫ø (ml/l)</option>
                                <option value="time">Th·ªùi gian (ng√†y/tu·∫ßn)</option>
                                <option value="custom">T·ª± ƒë·ªãnh nghƒ©a</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>M√¥ t·∫£ c√¥ng th·ª©c</label>
                        <textarea id="param-description-${parameterCounter}" rows="2" placeholder="M√¥ t·∫£ c√°ch t√≠nh to√°n..."></textarea>
                    </div>
                    <div id="param-calculation-${parameterCounter}" class="calculation-result" style="display: none;">
                        <strong>K·∫øt qu·∫£ t√≠nh to√°n:</strong> <span id="param-calc-result-${parameterCounter}"></span>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', parameterHtml);
            updateStats();
        }

        function updateFormulaDescription(parameterId) {
            const formula = document.getElementById(`param-formula-${parameterId}`).value;
            const description = document.getElementById(`param-description-${parameterId}`);
            
            const descriptions = {
                'density': 'T√≠nh s·ªë l∆∞·ª£ng c√¢y tr√™n hecta d·ª±a tr√™n kho·∫£ng c√°ch tr·ªìng. V√≠ d·ª•: 8x8m = 10000/(8*8) = 156 c√¢y/ha',
                'dosage': 'T√≠nh l∆∞·ª£ng v·∫≠t t∆∞ c·∫ßn thi·∫øt cho di·ªán t√≠ch. V√≠ d·ª•: 100kg/ha * 2ha = 200kg',
                'concentration': 'T√≠nh n·ªìng ƒë·ªô pha ch·∫ø thu·ªëc. V√≠ d·ª•: 20ml thu·ªëc/1l n∆∞·ªõc = 2%',
                'time': 'T√≠nh th·ªùi gian th·ª±c hi·ªán d·ª±a tr√™n chu k·ª≥ v√† ƒëi·ªÅu ki·ªán',
                'custom': 'Nh·∫≠p c√¥ng th·ª©c t√≠nh to√°n t√πy ch·ªânh'
            };
            
            description.value = descriptions[formula] || '';
        }

        function calculateParameter(parameterId) {
            const name = document.getElementById(`param-name-${parameterId}`).value;
            const value = document.getElementById(`param-value-${parameterId}`).value;
            const unit = document.getElementById(`param-unit-${parameterId}`).value;
            const area = parseFloat(document.getElementById(`param-area-${parameterId}`).value) || 1;
            const formula = document.getElementById(`param-formula-${parameterId}`).value;
            
            let result = '';
            let calculationDisplay = '';
            
            try {
                if (formula === 'density' && value.includes('x')) {
                    const [spacing1, spacing2] = value.split('x').map(v => parseFloat(v.trim()));
                    const densityPerHa = 10000 / (spacing1 * spacing2);
                    const totalTrees = densityPerHa * area;
                    result = `${Math.round(totalTrees)} c√¢y`;
                    calculationDisplay = `${Math.round(densityPerHa)} c√¢y/ha √ó ${area}ha = ${Math.round(totalTrees)} c√¢y`;
                } else if (formula === 'dosage') {
                    const dosage = parseFloat(value);
                    const total = dosage * area;
                    result = `${total} ${unit}`;
                    calculationDisplay = `${dosage} ${unit} √ó ${area}ha = ${total} ${unit}`;
                } else if (formula === 'concentration') {
                    const concentration = parseFloat(value);
                    result = `${concentration}${unit}`;
                    calculationDisplay = `N·ªìng ƒë·ªô pha ch·∫ø: ${concentration}${unit}`;
                } else {
                    const numValue = parseFloat(value);
                    if (!isNaN(numValue)) {
                        const total = numValue * area;
                        result = `${total} ${unit}`;
                        calculationDisplay = `${numValue} ${unit} √ó ${area}ha = ${total} ${unit}`;
                    } else {
                        result = value;
                        calculationDisplay = `Gi√° tr·ªã: ${value}`;
                    }
                }
            } catch (error) {
                result = 'L·ªói t√≠nh to√°n';
                calculationDisplay = 'Vui l√≤ng ki·ªÉm tra l·∫°i d·ªØ li·ªáu nh·∫≠p';
            }
            
            document.getElementById(`param-result-${parameterId}`).value = result;
            document.getElementById(`param-calc-result-${parameterId}`).textContent = calculationDisplay;
            document.getElementById(`param-calculation-${parameterId}`).style.display = 'block';
        }

        function calculateAllParameters() {
            const parameterItems = document.querySelectorAll('.parameter-item');
            parameterItems.forEach(item => {
                const id = item.id.split('-')[1];
                calculateParameter(id);
            });
        }

        function removeParameter(id) {
            if (confirm('X√≥a tham s·ªë n√†y?')) {
                document.getElementById(`parameter-${id}`).remove();
                updateStats();
            }
        }

        function applyParameterTemplate(templateType) {
            const templates = {
                'planting-spacing': {
                    name: 'Quy c√°ch tr·ªìng',
                    value: '8x8',
                    unit: 'c√¢y/ha',
                    formula: 'density',
                    area: '1.0'
                },
                'fertilizer-dosage': {
                    name: 'Li·ªÅu l∆∞·ª£ng ph√¢n NPK',
                    value: '150',
                    unit: 'kg/ha',
                    formula: 'dosage',
                    area: '1.0'
                },
                'irrigation-rate': {
                    name: 'L∆∞·ª£ng n∆∞·ªõc t∆∞·ªõi',
                    value: '500',
                    unit: 'l/ha',
                    formula: 'dosage',
                    area: '1.0'
                },
                'pest-concentration': {
                    name: 'N·ªìng ƒë·ªô thu·ªëc tr·ª´ s√¢u',
                    value: '20',
                    unit: 'ml/l',
                    formula: 'concentration',
                    area: '1.0'
                }
            };
            
            const template = templates[templateType];
            if (template && confirm(`Th√™m template "${template.name}"?`)) {
                addParameter();
                const currentId = parameterCounter;
                
                document.getElementById(`param-name-${currentId}`).value = template.name;
                document.getElementById(`param-value-${currentId}`).value = template.value;
                document.getElementById(`param-unit-${currentId}`).value = template.unit;
                document.getElementById(`param-formula-${currentId}`).value = template.formula;
                document.getElementById(`param-area-${currentId}`).value = template.area;
                
                updateFormulaDescription(currentId);
                calculateParameter(currentId);
            }
        }

        function addCondition() {
            if (!selectedConditionType) {
                alert('Vui l√≤ng ch·ªçn lo·∫°i ƒëi·ªÅu ki·ªán tr∆∞·ªõc!');
                return;
            }

            conditionCounter++;
            const container = document.getElementById('conditions-container');
            
            let conditionHtml = '';
            if (selectedConditionType === 'sequential') {
                conditionHtml = `
                    <div class="condition-item" id="condition-${conditionCounter}">
                        <div class="item-header">
                            <div class="item-title">
                                <span class="item-badge">Tu·∫ßn t·ª±</span>
                                ƒêi·ªÅu ki·ªán ${conditionCounter}
                            </div>
                            <button class="btn btn-danger btn-sm" onclick="removeCondition(${conditionCounter})">üóëÔ∏è</button>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>C√¥ng vi·ªác ti√™n quy·∫øt</label>
                                <select>
                                    <option>Ph√¢n t√≠ch ƒë·∫•t</option>
                                    <option>L√†m ƒë·∫•t</option>
                                    <option>B√≥n v√¥i</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Th·ªùi gian ch·ªù</label>
                                <div class="quantity-input">
                                    <input type="number" placeholder="0" min="0">
                                    <select>
                                        <option>gi·ªù</option>
                                        <option>ng√†y</option>
                                        <option>tu·∫ßn</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (selectedConditionType === 'environmental') {
                conditionHtml = `
                    <div class="condition-item" id="condition-${conditionCounter}">
                        <div class="item-header">
                            <div class="item-title">
                                <span class="item-badge">M√¥i tr∆∞·ªùng</span>
                                ƒêi·ªÅu ki·ªán ${conditionCounter}
                            </div>
                            <button class="btn btn-danger btn-sm" onclick="removeCondition(${conditionCounter})">üóëÔ∏è</button>
                        </div>
                        <div class="environmental-grid">
                            <div class="form-group">
                                <label>üå°Ô∏è Nhi·ªát ƒë·ªô</label>
                                <div class="range-input">
                                    <input type="number" placeholder="Min">
                                    <span>-</span>
                                    <input type="number" placeholder="Max">
                                    <span>¬∞C</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>üíß ƒê·ªô ·∫©m</label>
                                <div class="range-input">
                                    <input type="number" placeholder="Min">
                                    <span>-</span>
                                    <input type="number" placeholder="Max">
                                    <span>%</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>G·ª£i √Ω ƒë√°nh gi√°</label>
                            <textarea placeholder="Nhi·ªát ƒë·ªô ·ªïn ƒë·ªãnh 25-30¬∞C trong 3 ng√†y..."></textarea>
                        </div>
                    </div>
                `;
            } else if (selectedConditionType === 'field-assessment') {
                conditionHtml = `
                    <div class="condition-item" id="condition-${conditionCounter}">
                        <div class="item-header">
                            <div class="item-title">
                                <span class="item-badge">Th·ª±c ƒë·ªãa</span>
                                ƒêi·ªÅu ki·ªán ${conditionCounter}
                            </div>
                            <button class="btn btn-danger btn-sm" onclick="removeCondition(${conditionCounter})">üóëÔ∏è</button>
                        </div>
                        <div class="form-group">
                            <label>Lo·∫°i d·∫•u hi·ªáu</label>
                            <select>
                                <option>üêõ Vi sinh v·∫≠t g√¢y h·∫°i</option>
                                <option>üçÉ D·∫•u hi·ªáu l√°</option>
                                <option>üåø D·∫•u hi·ªáu th√¢n</option>
                                <option>üå± D·∫•u hi·ªáu r·ªÖ</option>
                            </select>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>M·ª©c ƒë·ªô nghi√™m tr·ªçng</label>
                                <select>
                                    <option>Nh·∫π (1-25%)</option>
                                    <option>Trung b√¨nh (26-50%)</option>
                                    <option>N·∫∑ng (51-75%)</option>
                                    <option>R·∫•t n·∫∑ng (>75%)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Di·ªán t√≠ch ·∫£nh h∆∞·ªüng</label>
                                <div class="quantity-input">
                                    <input type="number" placeholder="0">
                                    <select>
                                        <option>%</option>
                                        <option>m¬≤</option>
                                        <option>ha</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.insertAdjacentHTML('beforeend', conditionHtml);
            updateStats();
        }

        function addMaterial() {
            materialCounter++;
            const container = document.getElementById('materials-container');
            
            const materialHtml = `
                <div class="material-item" id="material-${materialCounter}">
                    <div class="item-header">
                        <div class="item-title">
                            <span class="item-badge">V·∫≠t t∆∞ ${materialCounter}</span>
                            <span class="cost-badge" id="material-cost-${materialCounter}">0 VNƒê</span>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="removeMaterial(${materialCounter})">üóëÔ∏è</button>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>T√™n v·∫≠t t∆∞</label>
                            <input type="text" id="material-name-${materialCounter}" placeholder="Ph√¢n NPK, Thu·ªëc tr·ª´ s√¢u...">
                        </div>
                        <div class="form-group">
                            <label>Ho·∫°t ch·∫•t (Theo danh m·ª•c cho ph√©p)</label>
                            <input type="text" id="material-active-${materialCounter}" placeholder="Glyphosate 480g/l">
                        </div>
                    </div>
                    <div class="form-grid-6">
                        <div class="form-group">
                            <label>S·ªë l∆∞·ª£ng</label>
                            <input type="number" id="material-quantity-${materialCounter}" placeholder="0" min="0" step="0.1" 
                                   onchange="calculateItemCost('material', ${materialCounter})">
                        </div>
                        <div class="form-group">
                            <label>ƒê∆°n v·ªã t√≠nh</label>
                            <select id="material-unit-${materialCounter}">
                                <option>kg</option>
                                <option>l√≠t</option>
                                <option>gram</option>
                                <option>t√∫i</option>
                                <option>th√πng</option>
                                <option>chai</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ƒê∆°n gi√° (VNƒê)</label>
                            <input type="number" id="material-price-${materialCounter}" placeholder="0" min="0" 
                                   onchange="calculateItemCost('material', ${materialCounter})">
                        </div>
                        <div class="form-group">
                            <label>N·ªìng ƒë·ªô pha</label>
                            <input type="text" id="material-concentration-${materialCounter}" placeholder="1:1000">
                        </div>
                        <div class="form-group">
                            <label>T·ªïng ti·ªÅn</label>
                            <input type="text" id="material-total-${materialCounter}" readonly class="currency">
                        </div>
                        <div class="form-group">
                            <label>ƒê∆°n v·ªã cung c·∫•p</label>
                            <input type="text" id="material-supplier-${materialCounter}" placeholder="C√¥ng ty ABC">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Upload h√≥a ƒë∆°n</label>
                        <div class="file-upload-area compact" onclick="document.getElementById('material-invoice-${materialCounter}').click()">
                            <span class="upload-text">üìé Ch·ªçn h√≥a ƒë∆°n (PDF, JPG, PNG)</span>
                            <input type="file" id="material-invoice-${materialCounter}" style="display: none;" 
                                   accept=".pdf,.jpg,.jpeg,.png" onchange="handleInvoiceUpload(this, ${materialCounter}, 'material')">
                        </div>
                        <div id="material-invoice-list-${materialCounter}" class="file-list"></div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', materialHtml);
            updateStats();
        }

        function addTool() {
            toolCounter++;
            const container = document.getElementById('tools-container');
            
            const toolHtml = `
                <div class="tool-item" id="tool-${toolCounter}">
                    <div class="item-header">
                        <div class="item-title">
                            <span class="item-badge">C√¥ng c·ª• ${toolCounter}</span>
                            <span class="cost-badge" id="tool-cost-${toolCounter}">0 VNƒê</span>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="removeTool(${toolCounter})">üóëÔ∏è</button>
                    </div>
                    <div class="form-grid-5">
                        <div class="form-group">
                            <label>T√™n c√¥ng c·ª•</label>
                            <input type="text" id="tool-name-${toolCounter}" placeholder="M√°y phun, Cu·ªëc, X·∫ªng...">
                        </div>
                        <div class="form-group">
                            <label>S·ªë l∆∞·ª£ng</label>
                            <input type="number" id="tool-quantity-${toolCounter}" placeholder="1" min="1" 
                                   onchange="calculateItemCost('tool', ${toolCounter})">
                        </div>
                        <div class="form-group">
                            <label>Th√¥ng s·ªë</label>
                            <input type="text" id="tool-specs-${toolCounter}" placeholder="20L, 2HP...">
                        </div>
                        <div class="form-group">
                            <label>Chi ph√≠/Kh·∫•u hao (VNƒê)</label>
                            <input type="number" id="tool-price-${toolCounter}" placeholder="0" min="0" 
                                   onchange="calculateItemCost('tool', ${toolCounter})">
                        </div>
                        <div class="form-group">
                            <label>T·ªïng ti·ªÅn</label>
                            <input type="text" id="tool-total-${toolCounter}" readonly class="currency">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Ghi ch√∫</label>
                        <textarea id="tool-notes-${toolCounter}" rows="2" placeholder="Ghi ch√∫ v·ªÅ c√¥ng c·ª•, c√°ch s·ª≠ d·ª•ng..."></textarea>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', toolHtml);
            updateStats();
        }

        function addLabor() {
            laborCounter++;
            const container = document.getElementById('labor-container');
            
            const laborHtml = `
                <div class="labor-item" id="labor-${laborCounter}">
                    <div class="item-header">
                        <div class="item-title">
                            <span class="item-badge labor-badge">Nh√¢n c√¥ng ${laborCounter}</span>
                            <span class="cost-badge" id="labor-cost-${laborCounter}">0 VNƒê</span>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="removeLabor(${laborCounter})">üóëÔ∏è</button>
                    </div>
                    <div class="form-grid-5">
                        <div class="form-group">
                            <label>Lo·∫°i c√¥ng vi·ªác</label>
                            <input type="text" id="labor-type-${laborCounter}" placeholder="L√†m ƒë·∫•t, B√≥n ph√¢n, Thu ho·∫°ch...">
                        </div>
                        <div class="form-group">
                            <label>S·ªë l∆∞·ª£ng</label>
                            <input type="number" id="labor-quantity-${laborCounter}" placeholder="1" min="1" 
                                   onchange="calculateItemCost('labor', ${laborCounter})">
                        </div>
                        <div class="form-group">
                            <label>ƒê∆°n v·ªã t√≠nh</label>
                            <select id="labor-unit-${laborCounter}">
                                <option>Ng√†y c√¥ng</option>
                                <option>Gi·ªù</option>
                                <option>Theo di·ªán t√≠ch (ha)</option>
                                <option>Theo s·∫£n l∆∞·ª£ng (t·∫•n)</option>
                                <option>Kho√°n tr·ªçn</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Th√π lao (VNƒê)</label>
                            <input type="number" id="labor-price-${laborCounter}" placeholder="0" min="0" 
                                   onchange="calculateItemCost('labor', ${laborCounter})">
                        </div>
                        <div class="form-group">
                            <label>T·ªïng chi ph√≠</label>
                            <input type="text" id="labor-total-${laborCounter}" readonly class="currency">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>T√™n ng∆∞·ªùi lao ƒë·ªông</label>
                            <input type="text" id="labor-name-${laborCounter}" placeholder="H·ªç v√† t√™n...">
                        </div>
                        <div class="form-group">
                            <label>S·ªë ƒëi·ªán tho·∫°i</label>
                            <input type="tel" id="labor-phone-${laborCounter}" placeholder="0901234567">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Ghi ch√∫</label>
                        <textarea id="labor-notes-${laborCounter}" rows="2" placeholder="Kinh nghi·ªám, k·ªπ nƒÉng ƒë·∫∑c bi·ªát..."></textarea>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', laborHtml);
            updateStats();
        }

        function addService() {
            serviceCounter++;
            const container = document.getElementById('services-container');
            
            const serviceHtml = `
                <div class="service-item" id="service-${serviceCounter}">
                    <div class="item-header">
                        <div class="item-title">
                            <span class="item-badge service-badge">D·ªãch v·ª• ${serviceCounter}</span>
                            <span class="cost-badge" id="service-cost-${serviceCounter}">0 VNƒê</span>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="removeService(${serviceCounter})">üóëÔ∏è</button>
                    </div>
                    <div class="form-grid-5">
                        <div class="form-group">
                            <label>Lo·∫°i d·ªãch v·ª•</label>
                            <input type="text" id="service-type-${serviceCounter}" placeholder="C√†y b·ª´a, Phun thu·ªëc, V·∫≠n chuy·ªÉn...">
                        </div>
                        <div class="form-group">
                            <label>S·ªë l∆∞·ª£ng</label>
                            <input type="number" id="service-quantity-${serviceCounter}" placeholder="1" min="1" 
                                   onchange="calculateItemCost('service', ${serviceCounter})">
                        </div>
                        <div class="form-group">
                            <label>ƒê∆°n v·ªã t√≠nh</label>
                            <select id="service-unit-${serviceCounter}">
                                <option>Theo di·ªán t√≠ch (ha)</option>
                                <option>Theo ng√†y</option>
                                <option>Theo gi·ªù</option>
                                <option>Theo chuy·∫øn</option>
                                <option>Kho√°n tr·ªçn</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Th√π lao (VNƒê)</label>
                            <input type="number" id="service-price-${serviceCounter}" placeholder="0" min="0" 
                                   onchange="calculateItemCost('service', ${serviceCounter})">
                        </div>
                        <div class="form-group">
                            <label>T·ªïng chi ph√≠</label>
                            <input type="text" id="service-total-${serviceCounter}" readonly class="currency">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nh√† cung c·∫•p</label>
                            <input type="text" id="service-provider-${serviceCounter}" placeholder="C√¥ng ty/C√° nh√¢n cung c·∫•p d·ªãch v·ª•">
                        </div>
                        <div class="form-group">
                            <label>S·ªë ƒëi·ªán tho·∫°i</label>
                            <input type="tel" id="service-phone-${serviceCounter}" placeholder="0901234567">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>M√¥ t·∫£ d·ªãch v·ª•</label>
                        <textarea id="service-description-${serviceCounter}" rows="2" placeholder="M√¥ t·∫£ chi ti·∫øt d·ªãch v·ª•, y√™u c·∫ßu k·ªπ thu·∫≠t..."></textarea>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', serviceHtml);
            updateStats();
        }

        function removeCondition(id) {
            if (confirm('X√≥a ƒëi·ªÅu ki·ªán n√†y?')) {
                document.getElementById(`condition-${id}`).remove();
                updateStats();
            }
        }

        function removeMaterial(id) {
            if (confirm('X√≥a v·∫≠t t∆∞ n√†y?')) {
                document.getElementById(`material-${id}`).remove();
                updateStats();
                calculateTotalCosts();
            }
        }

        function removeTool(id) {
            if (confirm('X√≥a c√¥ng c·ª• n√†y?')) {
                document.getElementById(`tool-${id}`).remove();
                updateStats();
                calculateTotalCosts();
            }
        }

        function removeLabor(id) {
            if (confirm('X√≥a nh√¢n c√¥ng n√†y?')) {
                document.getElementById(`labor-${id}`).remove();
                updateStats();
                calculateTotalCosts();
            }
        }

        function removeService(id) {
            if (confirm('X√≥a d·ªãch v·ª• n√†y?')) {
                document.getElementById(`service-${id}`).remove();
                updateStats();
                calculateTotalCosts();
            }
        }

        function handleFileUpload(input) {
            const files = input.files;
            const fileList = document.getElementById('file-list');
            
            for (let file of files) {
                if (file.size > 10 * 1024 * 1024) {
                    alert(`File ${file.name} qu√° l·ªõn (>10MB)`);
                    continue;
                }
                
                uploadedFiles.push(file);
                
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <span>üìé ${file.name}</span>
                    <button class="btn btn-danger btn-sm" onclick="removeFile('${file.name}', this)">üóëÔ∏è</button>
                `;
                fileList.appendChild(fileItem);
            }
            
            updateStats();
        }

        function handleInvoiceUpload(input, itemId, itemType) {
            const files = input.files;
            const fileList = document.getElementById(`${itemType}-invoice-list-${itemId}`);
            
            for (let file of files) {
                if (file.size > 5 * 1024 * 1024) {
                    alert(`File ${file.name} qu√° l·ªõn (>5MB)`);
                    continue;
                }
                
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <span>üìé ${file.name}</span>
                    <button class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">üóëÔ∏è</button>
                `;
                fileList.appendChild(fileItem);
            }
        }

        function removeFile(fileName, button) {
            uploadedFiles = uploadedFiles.filter(f => f.name !== fileName);
            button.closest('.file-item').remove();
            updateStats();
        }

        function updateStats() {
            const conditionsCount = document.querySelectorAll('.condition-item').length;
            const parametersCount = document.querySelectorAll('.parameter-item').length;
            const materialsCount = document.querySelectorAll('.material-item').length;
            const toolsCount = document.querySelectorAll('.tool-item').length;
            const laborCount = document.querySelectorAll('.labor-item').length + document.querySelectorAll('.service-item').length;
            
            document.getElementById('conditions-count').textContent = conditionsCount;
            document.getElementById('parameters-count').textContent = parametersCount;
            document.getElementById('materials-count').textContent = materialsCount;
            document.getElementById('tools-count').textContent = toolsCount;
            document.getElementById('labor-count').textContent = laborCount;
            
            const totalFields = [
                document.getElementById('detailed-description').value,
                document.getElementById('step-by-step').value
            ].filter(v => v.trim()).length;
            
            const completion = Math.min(100, Math.round(((totalFields + parametersCount + conditionsCount + materialsCount + toolsCount + laborCount) / 12) * 100));
            
            document.getElementById('completion-progress').style.width = completion + '%';
            document.getElementById('completion-text').textContent = completion + '% ho√†n th√†nh';

            // Update cost badges
            document.querySelectorAll('.material-item').forEach((item, index) => {
                const id = item.id.split('-')[1];
                const totalInput = item.querySelector(`input[id*="material-total-${id}"]`);
                const badge = document.getElementById(`material-cost-${id}`);
                if (totalInput && badge) {
                    badge.textContent = totalInput.value || '0 VNƒê';
                }
            });
        }

        function applyTemplate(templateType) {
            const templates = {
                'soil-preparation': {
                    description: 'Chu·∫©n b·ªã ƒë·∫•t tr·ªìng, c·∫£i thi·ªán c·∫•u tr√∫c v√† ƒë·ªô ph√¨ nhi√™u',
                    steps: 'B∆∞·ªõc 1: L√†m s·∫°ch c·ªè d·∫°i\nB∆∞·ªõc 2: X·ªõi ƒë·∫•t s√¢u 20-30cm\nB∆∞·ªõc 3: B√≥n v√¥i c·∫£i thi·ªán pH\nB∆∞·ªõc 4: B√≥n ph√¢n chu·ªìng hoai m·ª•c'
                },
                'fertilizer-application': {
                    description: 'B√≥n ph√¢n ƒë·ªãnh k·ª≥ b·ªï sung dinh d∆∞·ª°ng cho c√¢y tr·ªìng',
                    steps: 'B∆∞·ªõc 1: Ki·ªÉm tra ƒë·ªô ·∫©m ƒë·∫•t\nB∆∞·ªõc 2: T√≠nh to√°n l∆∞·ª£ng ph√¢n\nB∆∞·ªõc 3: Pha ph√¢n theo t·ª∑ l·ªá\nB∆∞·ªõc 4: B√≥n quanh g·ªëc c√¢y'
                }
            };
            
            const template = templates[templateType];
            if (template && confirm(`√Åp d·ª•ng template "${templateType}"?`)) {
                document.getElementById('detailed-description').value = template.description;
                document.getElementById('step-by-step').value = template.steps;
                updateStats();
            }
        }

        function exportCostReport() {
            alert('üìä ƒêang t·∫°o b√°o c√°o chi ph√≠...\n\nB√°o c√°o s·∫Ω bao g·ªìm:\n- Chi ti·∫øt t·ª´ng kho·∫£n chi ph√≠\n- Bi·ªÉu ƒë·ªì ph√¢n b·ªë chi ph√≠\n- So s√°nh v·ªõi k·∫ø ho·∫°ch\n- Khuy·∫øn ngh·ªã t·ªëi ∆∞u h√≥a');
        }

        function closeModal() {
            if (confirm('ƒê√≥ng popup? C√°c thay ƒë·ªïi ch∆∞a l∆∞u s·∫Ω b·ªã m·∫•t.')) {
                document.body.style.display = 'none';
                alert('Quay v·ªÅ quy tr√¨nh ch√≠nh...');
            }
        }

        function saveAsDraft() {
            alert('üíæ ƒê√£ l∆∞u nh√°p th√†nh c√¥ng!');
        }

        function saveDetails() {
            const description = document.getElementById('detailed-description').value;
            const steps = document.getElementById('step-by-step').value;
            
            if (!description.trim() || !steps.trim()) {
                alert('‚ö†Ô∏è Vui l√≤ng ƒëi·ªÅn m√¥ t·∫£ v√† h∆∞·ªõng d·∫´n chi ti·∫øt!');
                return;
            }
            
            alert('‚úÖ ƒê√£ l∆∞u chi ti·∫øt c√¥ng vi·ªác v√† d·ª± to√°n chi ph√≠ th√†nh c√¥ng!');
            closeModal();
        }

        // Initialize
        document.addEventListener('input', updateStats);
        document.addEventListener('change', updateStats);
        
        // Sample data
        setTimeout(() => {
            selectConditionType('environmental');
            addCondition();
            applyParameterTemplate('planting-spacing');
            
            // Add sample material
            addMaterial();
            setTimeout(() => {
                document.getElementById('material-name-1').value = 'Ph√¢n NPK 16-16-8';
                document.getElementById('material-quantity-1').value = '50';
                document.getElementById('material-price-1').value = '25000';
                document.getElementById('material-supplier-1').value = 'C√¥ng ty TNHH Ph√¢n b√≥n Vi·ªát Nam';
                calculateItemCost('material', 1);
            }, 100);
            
            // Add sample tool
            addTool();
            setTimeout(() => {
                document.getElementById('tool-name-1').value = 'M√°y c√†y mini';
                document.getElementById('tool-quantity-1').value = '1';
                document.getElementById('tool-price-1').value = '200000';
                calculateItemCost('tool', 1);
            }, 200);
            
            // Add sample labor
            addLabor();
            setTimeout(() => {
                document.getElementById('labor-type-1').value = 'L√†m ƒë·∫•t v√† b√≥n ph√¢n';
                document.getElementById('labor-quantity-1').value = '2';
                document.getElementById('labor-price-1').value = '300000';
                calculateItemCost('labor', 1);
            }, 300);
            
        }, 500);
    </script>
</body>
</html>