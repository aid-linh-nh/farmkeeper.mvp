<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thiết lập Chi tiết Công việc & Chi phí</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      :root {
        --primary-color: #69bd70;
        --primary-dark: #5aa661;
        --secondary-color: #4b5563;
        --danger-color: #dc2626;
        --warning-color: #d97706;
        --purple-color: #7c3aed;
        --indigo-color: #4f46e5;
        --blue-color: #2563eb;
        --orange-color: #f39c12;
        --bg-light: #f9fafb;
        --bg-white: #ffffff;
        --border-color: #e5e7eb;
        --text-dark: #1f2937;
        --text-light: #6b7280;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -2px rgba(0, 0, 0, 0.1);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Noto Sans', sans-serif;
        background: rgba(0, 0, 0, 0.5);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        line-height: 1.6;
      }

      .modal-container {
        background: var(--bg-light);
        border-radius: 16px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        width: 100%;
        max-width: 1200px;
        max-height: 95vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .modal-header {
        background: linear-gradient(
          135deg,
          var(--primary-color) 0%,
          var(--primary-dark) 100%
        );
        color: white;
        padding: 1.25rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
      }

      .header-left h1 {
        font-size: 1.5rem;
        font-weight: 700;
      }

      .header-left p {
        font-size: 0.875rem;
        opacity: 0.9;
      }

      .close-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.25rem;
        margin-left: 1rem;
        transition: all 0.2s ease;
      }
      .close-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .modal-body {
        overflow-y: auto;
        flex: 1;
        padding: 1.5rem;
      }

      .section {
        margin-bottom: 1.5rem;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        overflow: hidden;
        background: var(--bg-white);
        box-shadow: var(--shadow);
      }

      .section-header {
        background: var(--bg-light);
        padding: 0.75rem 1.25rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .section-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-dark);
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .section-cost {
        font-size: 0.875rem;
        font-weight: 700;
        color: var(--primary-color);
      }

      .section-icon {
        font-size: 1.25rem;
        color: var(--primary-color);
      }

      .section-body {
        padding: 1.25rem;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
      }

      .form-group {
        position: relative;
      }

      .form-group.span-full {
        grid-column: 1 / -1;
      }

      label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--text-dark);
        font-size: 0.875rem;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 0.625rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        background: var(--bg-white);
        font-family: 'Noto Sans', sans-serif;
      }
      input[readonly] {
        background: #f3f4f6;
        color: var(--text-light);
        font-weight: 600;
      }
      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(105, 189, 112, 0.2);
      }

      textarea {
        resize: vertical;
        min-height: 80px;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1rem;
        border: none;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        color: white;
        box-shadow: var(--shadow);
      }
      .btn:hover {
        transform: translateY(-2px);
        filter: brightness(1.1);
      }

      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--primary-color) 0%,
          var(--primary-dark) 100%
        );
      }
      .btn-secondary {
        background: var(--secondary-color);
        color: white;
      }
      .btn-danger {
        background: var(--danger-color);
        color: white;
      }
      .btn-warning {
        background: var(--warning-color);
        color: white;
      }
      .btn-purple {
        background: var(--purple-color);
        color: white;
      }
      .btn-indigo {
        background: var(--indigo-color);
        color: white;
      }
      .btn-blue {
        background: var(--blue-color);
        color: white;
      }

      .btn-sm {
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
      }

      .item-card {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
      }

      .item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #e2e8f0;
      }

      .item-title {
        font-weight: 600;
        color: var(--text-dark);
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .item-badge {
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .cost-summary {
        background: linear-gradient(135deg, #f0fdf4, #e6f8f0);
        border: 1px solid var(--primary-color);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .cost-summary-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--primary-dark);
        margin-bottom: 1rem;
        text-align: center;
      }

      .cost-breakdown {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .cost-item {
        text-align: center;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 8px;
      }

      .cost-item-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--primary-dark);
      }

      .cost-item-label {
        font-size: 0.8rem;
        color: var(--text-light);
        margin-top: 0.25rem;
      }

      .total-cost {
        background: linear-gradient(
          135deg,
          var(--primary-dark) 0%,
          #4d8e53 100%
        );
        color: white;
        padding: 1rem;
        border-radius: 8px;
        text-align: center;
      }

      .total-cost-value {
        font-size: 2rem;
        font-weight: 800;
      }

      .total-cost-label {
        font-size: 0.875rem;
        opacity: 0.9;
      }

      .modal-footer {
        background: var(--bg-light);
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        align-items: center;
        flex-shrink: 0;
        gap: 0.75rem;
      }

      /* Styles for new sections */
      .parameter-body-layout {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 1rem;
      }
      .parameter-body-layout .grid-col-span-2 {
        grid-column: span 2;
      }
      .parameter-body-layout .grid-col-span-3 {
        grid-column: span 3;
      }
      .parameter-body-layout .grid-col-span-6 {
        grid-column: span 6;
      }

      .result-display {
        background-color: #eef2ff;
        color: #4338ca;
        border: 1px solid #a5b4fc;
        border-radius: 8px;
        padding: 1rem;
        font-weight: 600;
        grid-column: 1 / -1;
        margin-top: 0.5rem;
      }

      .condition-body-layout {
        display: grid;
        gap: 1rem;
        grid-template-columns: 1fr 1fr;
      }
      .condition-body-layout .grid-col-span-2 {
        grid-column: span 2;
      }

      .range-input-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .range-input-group span {
        color: var(--text-light);
      }

      .input-with-unit {
        display: flex;
      }
      .input-with-unit input {
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
        border-right: none;
      }
      .input-with-unit select {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
        flex-shrink: 0;
        width: 80px;
      }
      .item-tag {
        color: white;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
      }
      .item-tag.tag-orange {
        background-color: var(--orange-color);
      }
      .item-tag.tag-green {
        background-color: var(--primary-color);
      }
      .item-tag.tag-blue {
        background-color: var(--blue-color);
      }

      .file-upload-area {
        border: 2px dashed var(--border-color);
        border-radius: 8px;
        padding: 1.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-top: 1rem;
      }
      .file-upload-area:hover {
        border-color: var(--primary-color);
        background: #f0fdf4;
      }
      .file-list {
        margin-top: 1rem;
      }
      .file-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem;
        background: #f3f4f6;
        border-radius: 4px;
        margin-bottom: 0.5rem;
        font-size: 0.8rem;
      }
    </style>
  </head>
  <body>
    <div class="modal-container">
      <header class="modal-header">
        <div class="header-left">
          <h1>
            <i class="fa-solid fa-screwdriver-wrench"></i> Thiết lập Chi tiết
            Công việc & Chi phí
          </h1>
          <p><strong>Công việc:</strong> Làm đất và bón phân cơ bản</p>
        </div>
        <button class="close-btn" onclick="closeModal()">✕</button>
      </header>

      <div class="modal-body">
        <div class="section">
          <div class="section-header">
            <h3 class="section-title">
              <i class="section-icon fa-solid fa-sack-dollar"></i> Tổng quan chi
              phí công việc
            </h3>
          </div>
          <div class="section-body">
            <div
              class="cost-summary"
              style="margin: 0; padding: 0; border: none; background: none"
            >
              <div class="cost-breakdown">
                <div class="cost-item">
                  <div class="cost-item-value" id="materials-total-cost">
                    0 VNĐ
                  </div>
                  <div class="cost-item-label">Vật tư</div>
                </div>
                <div class="cost-item">
                  <div class="cost-item-value" id="labor-total-cost">0 VNĐ</div>
                  <div class="cost-item-label">Nhân công</div>
                </div>
                <div class="cost-item">
                  <div class="cost-item-value" id="tools-total-cost">0 VNĐ</div>
                  <div class="cost-item-label">Công cụ</div>
                </div>
                <div class="cost-item">
                  <div class="cost-item-value" id="services-total-cost">
                    0 VNĐ
                  </div>
                  <div class="cost-item-label">Dịch vụ</div>
                </div>
              </div>
              <div class="total-cost">
                <div class="total-cost-value" id="grand-total-cost">0 VNĐ</div>
                <div class="total-cost-label">TỔNG CHI PHÍ DỰ KIẾN</div>
              </div>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <h3 class="section-title">
              <i class="section-icon fa-solid fa-file-lines"></i> Mô tả và hướng
              dẫn chi tiết
            </h3>
          </div>
          <div class="section-body">
            <div class="form-group span-full">
              <label for="detailed-description">Mô tả chi tiết công việc</label>
              <textarea
                id="detailed-description"
                rows="3"
                placeholder="Mô tả chi tiết cách thực hiện công việc..."
              ></textarea>
            </div>
            <div class="form-group span-full">
              <label for="step-by-step">Hướng dẫn từng bước</label>
              <textarea
                id="step-by-step"
                rows="4"
                placeholder="Bước 1: ...&#10;Bước 2: ...&#10;Bước 3: ..."
              ></textarea>
            </div>
            <div class="form-grid" style="margin-top: 1rem">
              <div class="form-group">
                <label for="video-link">Link video hướng dẫn</label>
                <input
                  type="url"
                  id="video-link"
                  placeholder="https://youtube.com/watch?v=..."
                />
              </div>
              <div class="form-group">
                <label for="reference-link">Link tài liệu tham khảo</label>
                <input
                  type="url"
                  id="reference-link"
                  placeholder="https://..."
                />
              </div>
            </div>
            <div class="form-group span-full">
              <label>Tài liệu đính kèm</label>
              <div
                class="file-upload-area"
                onclick="document.getElementById('file-input').click()"
              >
                <i
                  class="fa-solid fa-cloud-arrow-up"
                  style="font-size: 1.5rem; color: var(--text-light)"
                ></i>
                <p style="color: var(--text-light); margin-top: 0.5rem">
                  Chọn file hoặc kéo thả (PDF, DOC, JPG, PNG, MP4 - max 10MB)
                </p>
                <input
                  type="file"
                  id="file-input"
                  multiple
                  hidden
                  onchange="handleFileUpload(this.files)"
                />
              </div>
              <div class="file-list" id="file-list-container"></div>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <h3 class="section-title">
              <i class="section-icon fa-solid fa-ruler-combined"></i> Tham số kỹ
              thuật và tính toán
            </h3>
          </div>
          <div class="section-body">
            <div id="parameters-container">
              <div class="item-card">
                <div class="item-header">
                  <h4 class="item-title">Tham số 1</h4>
                  <button
                    class="btn btn-sm btn-danger"
                    onclick="this.closest('.item-card').remove()"
                  >
                    <i class="fa-solid fa-trash-can"></i>
                  </button>
                </div>
                <div class="parameter-body-layout">
                  <div class="form-group grid-col-span-2">
                    <label>Tên tham số</label
                    ><input type="text" value="Lượng phân bón lót" />
                  </div>
                  <div class="form-group grid-col-span-2">
                    <label>Giá trị</label><input type="text" value="500" />
                  </div>
                  <div class="form-group grid-col-span-2">
                    <label>Đơn vị</label
                    ><select>
                      <option>m</option>
                      <option selected>kg/ha</option>
                    </select>
                  </div>
                  <div class="form-group grid-col-span-3">
                    <label>Diện tích áp dụng (ha)</label
                    ><input type="number" value="2.5" />
                  </div>
                  <div class="form-group grid-col-span-3">
                    <label>Công thức tính</label
                    ><select>
                      <option selected>Tổng lượng bón</option>
                    </select>
                  </div>
                  <div class="form-group grid-col-span-6">
                    <label>Mô tả công thức tính</label>
                    <textarea
                      rows="2"
                      placeholder="Ví dụ: Lượng bón = [Giá trị] * [Diện tích]"
                    ></textarea>
                  </div>
                  <div class="result-display grid-col-span-6">
                    Kết quả tính toán: 1250 kg
                  </div>
                </div>
              </div>
            </div>
            <button type="button" class="btn btn-sm btn-primary">
              <i class="fa-solid fa-plus"></i> Thêm tham số
            </button>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <h3 class="section-title">
              <i class="section-icon fa-solid fa-arrow-right-arrow-left"></i>
              Điều kiện kích hoạt tiến hành
            </h3>
          </div>
          <div class="section-body">
            <div id="conditions-container">
              <div class="item-card">
                <div class="item-header" style="border-bottom: none">
                  <div class="item-title">
                    <span class="item-tag tag-orange">Tuần tự</span>
                  </div>
                  <button
                    class="btn btn-sm btn-danger"
                    onclick="this.closest('.item-card').remove()"
                  >
                    <i class="fa-solid fa-trash-can"></i>
                  </button>
                </div>
                <div class="condition-body-layout">
                  <div class="form-group">
                    <label>Công việc tiên quyết</label
                    ><select>
                      <option selected>Bón vôi</option>
                      <option>Cày đất</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Thời gian chờ</label>
                    <div class="input-with-unit">
                      <input type="number" value="7" /><select>
                        <option>giờ</option>
                        <option selected>ngày</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
              <div class="item-card">
                <div class="item-header" style="border-bottom: none">
                  <div class="item-title">
                    <span class="item-tag tag-green">Môi trường</span>
                  </div>
                  <button
                    class="btn btn-sm btn-danger"
                    onclick="this.closest('.item-card').remove()"
                  >
                    <i class="fa-solid fa-trash-can"></i>
                  </button>
                </div>
                <div class="condition-body-layout">
                  <div class="form-group">
                    <label>Nhiệt độ (°C)</label>
                    <div class="range-input-group">
                      <input type="number" placeholder="Từ" value="22" /><span
                        >-</span
                      ><input type="number" placeholder="Đến" value="32" />
                    </div>
                  </div>
                  <div class="form-group">
                    <label>Độ ẩm đất (%)</label>
                    <div class="range-input-group">
                      <input type="number" placeholder="Từ" value="60" /><span
                        >-</span
                      ><input type="number" placeholder="Đến" value="75" />
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <button type="button" class="btn btn-sm btn-primary">
              <i class="fa-solid fa-plus"></i> Thêm điều kiện
            </button>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <h3 class="section-title">
              <i class="section-icon fa-solid fa-flask-vial"></i> Vật tư sử dụng
            </h3>
            <div class="section-cost" id="materials-section-cost">0 VNĐ</div>
          </div>
          <div class="section-body">
            <div id="materials-container"></div>
            <button
              type="button"
              class="btn btn-sm btn-primary"
              onclick="addMaterial()"
            >
              <i class="fa-solid fa-plus"></i> Thêm vật tư
            </button>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <h3 class="section-title">
              <i class="section-icon fa-solid fa-helmet-safety"></i> Công cụ cần
              thiết
            </h3>
            <div class="section-cost" id="tools-section-cost">0 VNĐ</div>
          </div>
          <div class="section-body">
            <div id="tools-container"></div>
            <button
              type="button"
              class="btn btn-sm btn-primary"
              onclick="addTool()"
            >
              <i class="fa-solid fa-plus"></i> Thêm công cụ
            </button>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <h3 class="section-title">
              <i class="section-icon fa-solid fa-users"></i> Nhân công
            </h3>
            <div class="section-cost" id="labor-section-cost">0 VNĐ</div>
          </div>
          <div class="section-body">
            <div id="labor-container"></div>
            <button
              type="button"
              class="btn btn-sm btn-purple"
              onclick="addLabor()"
            >
              <i class="fa-solid fa-plus"></i> Thêm nhân công
            </button>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <h3 class="section-title">
              <i class="section-icon fa-solid fa-truck-fast"></i> Thuê khoán
              dịch vụ
            </h3>
            <div class="section-cost" id="services-section-cost">0 VNĐ</div>
          </div>
          <div class="section-body">
            <div id="services-container"></div>
            <button
              type="button"
              class="btn btn-sm btn-indigo"
              onclick="addService()"
            >
              <i class="fa-solid fa-plus"></i> Thêm dịch vụ
            </button>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <h3 class="section-title">
              <i class="section-icon fa-solid fa-triangle-exclamation"></i> Ghi
              chú an toàn
            </h3>
          </div>
          <div class="section-body">
            <div
              class="form-group span-full"
              style="
                background: #fffbeb;
                border: 1px solid #fde68a;
                padding: 1rem;
                border-radius: 8px;
              "
            >
              <label style="color: #b45309; font-weight: 600"
                >Lưu ý an toàn quan trọng</label
              >
              <textarea
                rows="3"
                placeholder="Nhập các lưu ý an toàn: sử dụng đồ bảo hộ, tránh hóa chất, kiểm tra thời tiết..."
                style="
                  background: transparent;
                  border: none;
                  padding: 0.5rem 0 0 0;
                "
              ></textarea>
            </div>
            <div class="form-grid" style="margin-top: 1rem">
              <div class="form-group">
                <label>Thiết bị bảo hộ bắt buộc</label>
                <textarea
                  rows="3"
                  placeholder="Găng tay, khẩu trang, kính bảo hộ..."
                ></textarea>
              </div>
              <div class="form-group">
                <label>Cấm thực hiện khi</label>
                <textarea
                  rows="3"
                  placeholder="Trời mưa, gió lớn, nhiệt độ >35°C..."
                ></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">
          Hủy
        </button>
        <button type="button" class="btn btn-primary" onclick="saveDetails()">
          <i class="fa-solid fa-check"></i> Lưu chi tiết
        </button>
      </div>
    </div>

    <script>
      // Counters for unique IDs
      let itemCounters = {
        material: 0,
        tool: 0,
        labor: 0,
        service: 0,
      };

      /**
       * Formats a number as Vietnamese currency.
       * @param {number} amount - The number to format.
       * @returns {string} The formatted currency string.
       */
      function formatCurrency(amount) {
        if (isNaN(amount)) return '0 VNĐ';
        return new Intl.NumberFormat('vi-VN', {
          style: 'currency',
          currency: 'VND',
        }).format(amount);
      }

      /**
       * Calculates the total cost for an individual item and updates the UI.
       * @param {string} itemType - The type of item (e.g., 'material', 'tool').
       * @param {number} id - The unique ID of the item.
       */
      function calculateItemCost(itemType, id) {
        const itemElement = document.getElementById(`${itemType}-${id}`);
        if (!itemElement) return;

        const quantity =
          parseFloat(
            itemElement.querySelector(`[data-field="quantity"]`)?.value
          ) || 0;
        const price =
          parseFloat(
            itemElement.querySelector(`[data-field="price"]`)?.value
          ) || 0;
        const total = quantity * price;

        const totalInput = itemElement.querySelector(`[data-field="total"]`);
        if (totalInput) {
          totalInput.value = formatCurrency(total);
        }

        calculateAllCosts();
      }

      /**
       * Calculates the total cost for all categories and updates the summary UI.
       */
      function calculateAllCosts() {
        const costs = {
          material: 0,
          tool: 0,
          labor: 0,
          service: 0,
        };

        for (const itemType in costs) {
          document.querySelectorAll(`.${itemType}-item`).forEach((item) => {
            const totalInput = item.querySelector('[data-field="total"]');
            if (totalInput && totalInput.value) {
              costs[itemType] +=
                parseFloat(totalInput.value.replace(/[^0-9]/g, '')) || 0;
            }
          });
        }

        const grandTotal =
          costs.material + costs.tool + costs.labor + costs.service;

        // Update section headers
        document.getElementById('materials-section-cost').textContent =
          formatCurrency(costs.material);
        document.getElementById('tools-section-cost').textContent =
          formatCurrency(costs.tool);
        document.getElementById('labor-section-cost').textContent =
          formatCurrency(costs.labor);
        document.getElementById('services-section-cost').textContent =
          formatCurrency(costs.service);

        // Update main cost overview
        document.getElementById('materials-total-cost').textContent =
          formatCurrency(costs.material);
        document.getElementById('tools-total-cost').textContent =
          formatCurrency(costs.tool);
        document.getElementById('labor-total-cost').textContent =
          formatCurrency(costs.labor);
        document.getElementById('services-total-cost').textContent =
          formatCurrency(costs.service);
        document.getElementById('grand-total-cost').textContent =
          formatCurrency(grandTotal);
      }

      /**
       * Removes an item card from the DOM and recalculates costs.
       * @param {string} itemType - The type of item to remove.
       * @param {number} id - The unique ID of the item to remove.
       */
      function removeItem(itemType, id) {
        if (confirm(`Bạn có chắc chắn muốn xóa mục này không?`)) {
          document.getElementById(`${itemType}-${id}`)?.remove();
          calculateAllCosts();
        }
      }

      /**
       * Adds a new material item card to the container.
       */
      function addMaterial() {
        itemCounters.material++;
        const id = itemCounters.material;
        const container = document.getElementById('materials-container');
        const html = `
                <div class="item-card material-item" id="material-${id}">
                    <div class="item-header">
                        <h4 class="item-title"><span class="item-badge btn-primary">Vật tư ${id}</span></h4>
                        <button class="btn btn-sm btn-danger" onclick="removeItem('material', ${id})"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                    <div class="form-grid" style="grid-template-columns: 2fr 2fr 1fr;">
                        <div class="form-group"><label>Tên vật tư</label><input type="text" placeholder="Phân NPK, Thuốc trừ sâu..."></div>
                        <div class="form-group"><label>Hoạt chất/Quy cách</label><input type="text" placeholder="N:16, P:16, K:8..."></div>
                        <div class="form-group"><label>Đơn vị cung cấp</label><input type="text" placeholder="Công ty ABC"></div>
                    </div>
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
                        <div class="form-group"><label>Số lượng</label><input type="number" data-field="quantity" placeholder="0" min="0" oninput="calculateItemCost('material', ${id})"></div>
                        <div class="form-group"><label>Đơn vị</label><select><option>kg</option><option>lít</option><option>túi</option><option>thùng</option></select></div>
                        <div class="form-group"><label>Đơn giá (VNĐ)</label><input type="number" data-field="price" placeholder="0" min="0" oninput="calculateItemCost('material', ${id})"></div>
                        <div class="form-group"><label>Tổng tiền</label><input type="text" data-field="total" readonly></div>
                    </div>
                </div>
            `;
        container.insertAdjacentHTML('beforeend', html);
      }

      /**
       * Adds a new tool item card to the container.
       */
      function addTool() {
        itemCounters.tool++;
        const id = itemCounters.tool;
        const container = document.getElementById('tools-container');
        const html = `
                <div class="item-card tool-item" id="tool-${id}">
                    <div class="item-header">
                        <h4 class="item-title"><span class="item-badge btn-primary">Công cụ ${id}</span></h4>
                        <button class="btn btn-sm btn-danger" onclick="removeItem('tool', ${id})"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                    <div class="form-grid" style="grid-template-columns: 2fr 1fr 1fr 1fr;">
                        <div class="form-group"><label>Tên công cụ</label><input type="text" placeholder="Máy cày, Bình phun..."></div>
                        <div class="form-group"><label>Số lượng</label><input type="number" data-field="quantity" placeholder="0" min="0" oninput="calculateItemCost('tool', ${id})"></div>
                        <div class="form-group"><label>Chi phí/Khấu hao (VNĐ)</label><input type="number" data-field="price" placeholder="0" min="0" oninput="calculateItemCost('tool', ${id})"></div>
                        <div class="form-group"><label>Tổng tiền</label><input type="text" data-field="total" readonly></div>
                    </div>
                    <div class="form-group"><label>Ghi chú</label><textarea rows="2" placeholder="Ghi chú về công cụ, tình trạng..."></textarea></div>
                </div>
            `;
        container.insertAdjacentHTML('beforeend', html);
      }

      /**
       * Adds a new labor item card to the container.
       */
      function addLabor() {
        itemCounters.labor++;
        const id = itemCounters.labor;
        const container = document.getElementById('labor-container');
        const html = `
                <div class="item-card labor-item" id="labor-${id}">
                    <div class="item-header">
                        <h4 class="item-title"><span class="item-badge btn-purple">Nhân công ${id}</span></h4>
                        <button class="btn btn-sm btn-danger" onclick="removeItem('labor', ${id})"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                    <div class="form-grid" style="grid-template-columns: 2fr 2fr;">
                        <div class="form-group"><label>Tên người lao động</label><input type="text" placeholder="Nguyễn Văn A"></div>
                        <div class="form-group"><label>Loại công việc</label><input type="text" placeholder="Làm đất, bón phân..."></div>
                    </div>
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
                        <div class="form-group"><label>Số lượng</label><input type="number" data-field="quantity" placeholder="0" min="0" oninput="calculateItemCost('labor', ${id})"></div>
                        <div class="form-group"><label>Đơn vị</label><select><option>Ngày công</option><option>Giờ</option><option>Khoán</option></select></div>
                        <div class="form-group"><label>Thù lao (VNĐ)</label><input type="number" data-field="price" placeholder="0" min="0" oninput="calculateItemCost('labor', ${id})"></div>
                        <div class="form-group"><label>Tổng chi phí</label><input type="text" data-field="total" readonly></div>
                    </div>
                </div>
            `;
        container.insertAdjacentHTML('beforeend', html);
      }

      /**
       * Adds a new outsourced service item card to the container.
       */
      function addService() {
        itemCounters.service++;
        const id = itemCounters.service;
        const container = document.getElementById('services-container');
        const html = `
                <div class="item-card service-item" id="service-${id}">
                    <div class="item-header">
                        <h4 class="item-title"><span class="item-badge btn-indigo">Dịch vụ ${id}</span></h4>
                        <button class="btn btn-sm btn-danger" onclick="removeItem('service', ${id})"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                     <div class="form-grid" style="grid-template-columns: 2fr 2fr;">
                        <div class="form-group"><label>Tên dịch vụ</label><input type="text" placeholder="Thuê máy cày, phun thuốc..."></div>
                        <div class="form-group"><label>Nhà cung cấp</label><input type="text" placeholder="Hợp tác xã XYZ"></div>
                    </div>
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
                        <div class="form-group"><label>Số lượng</label><input type="number" data-field="quantity" placeholder="0" min="0" oninput="calculateItemCost('service', ${id})"></div>
                        <div class="form-group"><label>Đơn vị</label><select><option>ha</option><option>Chuyến</option><option>Lần</option><option>Khoán</option></select></div>
                        <div class="form-group"><label>Đơn giá (VNĐ)</label><input type="number" data-field="price" placeholder="0" min="0" oninput="calculateItemCost('service', ${id})"></div>
                        <div class="form-group"><label>Tổng chi phí</label><input type="text" data-field="total" readonly></div>
                    </div>
                </div>
            `;
        container.insertAdjacentHTML('beforeend', html);
      }

      function closeModal() {
        if (confirm('Đóng cửa sổ? Các thay đổi chưa lưu sẽ bị mất.')) {
          // In a real app, you would destroy or hide the modal.
          // For this example, we'll just make it disappear.
          document.querySelector('.modal-container').style.display = 'none';
          document.body.style.background = 'transparent';
        }
      }

      function saveDetails() {
        alert('Lưu chi tiết thành công!');
        // Here you would typically gather all data and send to a server.
      }

      function handleFileUpload(files) {
        const container = document.getElementById('file-list-container');
        for (const file of files) {
          const fileItem = document.createElement('div');
          fileItem.className = 'file-item';
          fileItem.innerHTML = `
                    <span><i class="fa-solid fa-file"></i> ${file.name}</span>
                    <button class="btn btn-sm btn-danger" onclick="this.parentElement.remove()"><i class="fa-solid fa-trash-can"></i></button>
                `;
          container.appendChild(fileItem);
        }
      }

      // Initial setup
      document.addEventListener('DOMContentLoaded', () => {
        // Giữ lại thông tin mô tả và hướng dẫn từ trước
        document.getElementById('detailed-description').value =
          'Công việc này bao gồm các bước chuẩn bị đất trồng ban đầu, bao gồm cày xới, làm phẳng bề mặt và bón lót các loại phân hữu cơ cần thiết để cải tạo đất và cung cấp dinh dưỡng cho cây trồng giai đoạn đầu.';
        document.getElementById('step-by-step').value =
          'Bước 1: Sử dụng máy cày để xới sâu đất khoảng 20-30cm.\nBước 2: Dùng cào để làm phẳng bề mặt đất, loại bỏ các cục đất to.\nBước 3: Rải đều phân hữu cơ đã chuẩn bị lên bề mặt.';

        // Hiển thị sẵn một form trống cho mỗi loại chi phí khi tải trang
        addMaterial();
        addTool();
        addLabor();
        addService();
      });
    </script>
  </body>
</html>
