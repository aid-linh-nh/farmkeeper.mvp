<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farmkeeper - Đánh giá & Báo cáo</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="60" r="1.5" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="80" r="1" fill="rgba(255,255,255,0.1)"/></svg>');
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .header .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .form-container {
            padding: 40px;
        }

        .form-grid {
            display: grid;
            gap: 25px;
        }

        .form-group {
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2E7D32;
            font-size: 16px;
        }

        .form-group label i {
            margin-right: 8px;
            color: #4CAF50;
        }

        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .form-control:focus {
            outline: none;
            border-color: #4CAF50;
            background: white;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        select.form-control {
            cursor: pointer;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 120px;
        }

        .evidence-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border: 2px dashed #ddd;
            transition: all 0.3s ease;
        }

        .evidence-section:hover {
            border-color: #4CAF50;
            background: #f0f8f0;
        }

        .evidence-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .upload-area {
            border: 2px dashed #4CAF50;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            background: #f0f8f0;
            transform: translateY(-2px);
        }

        .document-upload {
            border-color: #2196F3;
        }

        .document-upload i {
            color: #2196F3;
            font-size: 48px;
        }

        .document-upload:hover {
            background: #f0f4ff;
            border-color: #1976D2;
        }

        .document-upload .upload-btn {
            background: #2196F3;
        }

        .document-upload .upload-btn:hover {
            background: #1976D2;
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
        }

        .file-types {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            font-style: italic;
        }

        .upload-area i {
            font-size: 48px;
            color: #4CAF50;
            margin-bottom: 15px;
            display: block;
        }

        .upload-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .upload-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .rating-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .rating-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
        }

        .rating-stars {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .star {
            font-size: 24px;
            color: #ddd;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .star:hover,
        .star.active {
            color: #FFD700;
            transform: scale(1.1);
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #f0f0f0;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-draft {
            background: #fff;
            color: #6c757d;
            border: 2px solid #6c757d;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .progress-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #6c757d;
        }

        .progress-step.active {
            color: #4CAF50;
            font-weight: 600;
        }

        .progress-step i {
            font-size: 20px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .form-container {
                padding: 20px;
            }

            .evidence-grid {
                grid-template-columns: 1fr;
            }

            .upload-area {
                min-height: 120px;
            }

            .rating-section {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .progress-indicator {
                flex-direction: column;
                gap: 10px;
            }
        }

        .file-preview {
            margin-top: 15px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #ddd;
            display: none;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 5px;
        }

        .file-item i {
            color: #4CAF50;
            width: 20px;
            text-align: center;
        }

        .file-item.document i {
            color: #2196F3;
        }

        .file-item.video i {
            color: #FF5722;
        }

        .file-item .file-info {
            flex: 1;
        }

        .file-item .file-name {
            font-weight: 600;
            color: #333;
        }

        .file-item .file-size {
            font-size: 12px;
            color: #666;
        }

        .file-item .remove-btn {
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-item .remove-btn:hover {
            background: #cc0000;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .measurement-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e0e0e0;
        }

        .measurement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .measurement-field {
            display: flex;
            flex-direction: column;
        }

        .measurement-field label {
            font-size: 14px;
            font-weight: 600;
            color: #2E7D32;
            margin-bottom: 5px;
        }

        .measurement-field input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .measurement-field input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
        }

        .measurement-field .unit {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        .calculation-result {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #4CAF50;
        }

        .calculation-result h4 {
            color: #2E7D32;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .alert-danger {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .measurement-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .measurement-section h4 {
            color: #2E7D32;
            margin-bottom: 15px;
            font-size: 16px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 5px;
        }

        .add-field-section {
            margin-top: 20px;
            padding: 20px;
            background: #f0f8f0;
            border-radius: 12px;
            border: 2px dashed #4CAF50;
            text-align: center;
        }

        .add-field-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .add-field-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .quick-add-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .quick-add-btn {
            background: white;
            border: 2px solid #4CAF50;
            color: #4CAF50;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .quick-add-btn:hover {
            background: #4CAF50;
            color: white;
        }

        .custom-field {
            position: relative;
            border: 2px solid #e8f5e8;
            border-radius: 8px;
            background: #f9fff9;
        }

        .custom-field .remove-field {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .custom-field .remove-field:hover {
            background: #cc0000;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            position: relative;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-header h3 {
            color: #2E7D32;
            margin: 0;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .close-modal:hover {
            color: #ff4444;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .btn-modal {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-modal.primary {
            background: #4CAF50;
            color: white;
        }

        .btn-modal.secondary {
            background: #6c757d;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-seedling"></i> Farmkeeper</h1>
            <div class="subtitle">Hệ thống quản lý sản xuất nông nghiệp thông minh</div>
        </div>

        <div class="form-container">
            <div class="progress-indicator">
                <div class="progress-step">
                    <i class="fas fa-tasks"></i>
                    <span>Lập kế hoạch</span>
                </div>
                <div class="progress-step">
                    <i class="fas fa-play"></i>
                    <span>Thực hiện</span>
                </div>
                <div class="progress-step active">
                    <i class="fas fa-clipboard-check"></i>
                    <span>Đánh giá & Báo cáo</span>
                </div>
                <div class="progress-step">
                    <i class="fas fa-chart-line"></i>
                    <span>Phân tích kết quả</span>
                </div>
            </div>

            <form id="evaluationForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="taskType">
                            <i class="fas fa-hammer"></i>
                            Công việc thực hiện
                        </label>
                        <select id="taskType" class="form-control" required>
                            <option value="">-- Chọn loại công việc --</option>
                            <option value="soil-improvement">Cải tạo đất</option>
                            <option value="seed-preparation">Chuẩn bị cây/con giống</option>
                            <option value="planting">Trồng cây con</option>
                            <option value="fertilizing">Bón phân</option>
                            <option value="watering">Tưới nước</option>
                            <option value="pest-control">Phòng trừ sâu bệnh</option>
                            <option value="harvesting">Thu hoạch</option>
                            <option value="yield-assessment">Đánh giá sản lượng</option>
                            <option value="livestock-care">Chăm sóc gia súc</option>
                            <option value="feeding">Cho ăn</option>
                            <option value="vaccination">Tiêm phòng</option>
                            <option value="other">Khác</option>
                        </select>
                    </div>

                    <div class="rating-section">
                        <div class="rating-group">
                            <label>
                                <i class="fas fa-check-circle"></i>
                                Tiêu chuẩn đạt được
                            </label>
                            <textarea class="form-control" placeholder="Mô tả các tiêu chuẩn đã đạt được theo quy trình..."></textarea>
                        </div>

                        <div class="rating-group">
                            <label>
                                <i class="fas fa-exclamation-triangle"></i>
                                Tiêu chuẩn chưa đạt
                            </label>
                            <textarea class="form-control" placeholder="Mô tả các tiêu chuẩn chưa đạt, vấn đề gặp phải..."></textarea>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>
                            <i class="fas fa-clipboard-list"></i>
                            Phương án đánh giá và Bằng chứng
                        </label>
                        <div class="evidence-section">
                            <div class="evidence-grid">
                                <div class="upload-area" onclick="document.getElementById('imageUpload').click()">
                                    <i class="fas fa-camera"></i>
                                    <div>Chụp ảnh bằng chứng</div>
                                    <button type="button" class="upload-btn">
                                        <i class="fas fa-camera"></i> Chụp ảnh
                                    </button>
                                    <input type="file" id="imageUpload" accept="image/*" capture="camera" style="display: none;" multiple>
                                </div>
                                
                                <div class="upload-area" onclick="document.getElementById('videoUpload').click()">
                                    <i class="fas fa-video"></i>
                                    <div>Quay video minh chứng</div>
                                    <button type="button" class="upload-btn">
                                        <i class="fas fa-video"></i> Quay video
                                    </button>
                                    <input type="file" id="videoUpload" accept="video/*" capture="camera" style="display: none;">
                                </div>
                                
                                <div class="upload-area document-upload" onclick="document.getElementById('documentUpload').click()">
                                    <i class="fas fa-certificate"></i>
                                    <div><strong>Tài liệu chứng nhận kiểm nghiệm</strong></div>
                                    <div style="font-size: 14px; color: #666; margin: 8px 0;">Giấy chứng nhận chất lượng, kết quả phân tích...</div>
                                    <button type="button" class="upload-btn">
                                        <i class="fas fa-upload"></i> Upload tài liệu
                                    </button>
                                    <input type="file" id="documentUpload" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png" style="display: none;" multiple>
                                    <div class="file-types">PDF, DOC, EXCEL, Image</div>
                                </div>
                            </div>

                            <div class="file-preview" id="filePreview"></div>

                            <div class="form-group">
                                <label>Kết quả đo lường và mô tả chi tiết:</label>
                                
                                <!-- Dynamic measurement fields based on task type -->
                                <div id="measurementFields" class="measurement-container">
                                    <div class="default-measurement">
                                        <textarea class="form-control" placeholder="Nhập các số liệu đo được, quan sát chi tiết về chất lượng, tình trạng cây trồng/vật nuôi..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>
                            <i class="fas fa-star"></i>
                            Điểm đánh giá chi tiết
                        </label>
                        <div class="rating-group">
                            <div style="margin-bottom: 15px;">
                                <strong>Chất lượng thực hiện:</strong>
                                <div class="rating-stars" data-rating="quality">
                                    <span class="star" data-value="1">★</span>
                                    <span class="star" data-value="2">★</span>
                                    <span class="star" data-value="3">★</span>
                                    <span class="star" data-value="4">★</span>
                                    <span class="star" data-value="5">★</span>
                                </div>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <strong>Tiến độ hoàn thành:</strong>
                                <div class="rating-stars" data-rating="progress">
                                    <span class="star" data-value="1">★</span>
                                    <span class="star" data-value="2">★</span>
                                    <span class="star" data-value="3">★</span>
                                    <span class="star" data-value="4">★</span>
                                    <span class="star" data-value="5">★</span>
                                </div>
                            </div>
                            <div>
                                <strong>Hiệu quả đạt được:</strong>
                                <div class="rating-stars" data-rating="effectiveness">
                                    <span class="star" data-value="1">★</span>
                                    <span class="star" data-value="2">★</span>
                                    <span class="star" data-value="3">★</span>
                                    <span class="star" data-value="4">★</span>
                                    <span class="star" data-value="5">★</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>
                            <i class="fas fa-lightbulb"></i>
                            Khuyến nghị cho giai đoạn tiếp theo
                        </label>
                        <textarea class="form-control" placeholder="Đưa ra các khuyến nghị, điều chỉnh cho công việc tiếp theo trong quy trình sản xuất..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>
                            <i class="fas fa-sticky-note"></i>
                            Ghi chú bổ sung
                        </label>
                        <textarea class="form-control" placeholder="Các thông tin bổ sung, lưu ý đặc biệt..."></textarea>
                    </div>
                </div>

                <div class="action-buttons">
                    <button type="button" class="btn btn-draft">
                        <i class="fas fa-save"></i>
                        Lưu nháp
                    </button>
                    <button type="button" class="btn btn-secondary">
                        <i class="fas fa-eye"></i>
                        Xem trước
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check"></i>
                        Hoàn thành báo cáo
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span>Báo cáo đã được lưu thành công!</span>
    </div>

    <!-- Add Field Modal -->
    <div id="addFieldModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-plus-circle"></i> Thêm trường đo lường</h3>
                <button class="close-modal" onclick="closeAddFieldModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addFieldForm">
                    <div class="form-group">
                        <label>Tên trường đo lường:</label>
                        <input type="text" id="fieldLabel" class="form-control" placeholder="Ví dụ: Độ dày vỏ quả" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Loại dữ liệu:</label>
                        <select id="fieldType" class="form-control" required>
                            <option value="">-- Chọn loại --</option>
                            <option value="number">Số (có đơn vị)</option>
                            <option value="text">Văn bản</option>
                            <option value="select">Lựa chọn</option>
                            <option value="date">Ngày tháng</option>
                            <option value="rating">Đánh giá (1-5 sao)</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="unitGroup" style="display: none;">
                        <label>Đơn vị đo:</label>
                        <input type="text" id="fieldUnit" class="form-control" placeholder="Ví dụ: mm, cm, kg, %">
                    </div>
                    
                    <div class="form-group" id="optionsGroup" style="display: none;">
                        <label>Các lựa chọn (mỗi dòng một lựa chọn):</label>
                        <textarea id="fieldOptions" class="form-control" placeholder="Tốt&#10;Khá&#10;Trung bình&#10;Kém"></textarea>
                    </div>
                    
                    <div class="form-group" id="rangeGroup" style="display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label>Giá trị tối thiểu:</label>
                                <input type="number" id="fieldMin" class="form-control" placeholder="0">
                            </div>
                            <div>
                                <label>Giá trị tối đa:</label>
                                <input type="number" id="fieldMax" class="form-control" placeholder="100">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Mô tả (tùy chọn):</label>
                        <textarea id="fieldDescription" class="form-control" placeholder="Mô tả cách đo lường, ý nghĩa của chỉ số..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-modal secondary" onclick="closeAddFieldModal()">Hủy</button>
                <button type="button" class="btn-modal primary" onclick="addCustomField()">Thêm trường</button>
            </div>
        </div>
    </div>

    <script>
        // Rating stars functionality
        document.querySelectorAll('.rating-stars').forEach(ratingGroup => {
            const stars = ratingGroup.querySelectorAll('.star');
            
            stars.forEach((star, index) => {
                star.addEventListener('click', () => {
                    const rating = index + 1;
                    const ratingType = ratingGroup.dataset.rating;
                    
                    // Update visual state
                    stars.forEach((s, i) => {
                        if (i < rating) {
                            s.classList.add('active');
                        } else {
                            s.classList.remove('active');
                        }
                    });
                    
                    // Store rating value
                    ratingGroup.dataset.value = rating;
                });
                
                star.addEventListener('mouseenter', () => {
                    const rating = index + 1;
                    stars.forEach((s, i) => {
                        if (i < rating) {
                            s.style.color = '#FFD700';
                        } else {
                            s.style.color = '#ddd';
                        }
                    });
                });
            });
            
            ratingGroup.addEventListener('mouseleave', () => {
                const currentRating = ratingGroup.dataset.value || 0;
                stars.forEach((s, i) => {
                    if (i < currentRating) {
                        s.style.color = '#FFD700';
                    } else {
                        s.style.color = '#ddd';
                    }
                });
            });
        });

        // File upload functionality
        function handleFileUpload(input, type) {
            input.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                const preview = document.getElementById('filePreview');
                
                if (files.length > 0) {
                    preview.style.display = 'block';
                    
                    files.forEach((file, index) => {
                        const fileItem = document.createElement('div');
                        fileItem.className = `file-item ${type}`;
                        fileItem.dataset.fileId = `${type}_${Date.now()}_${index}`;
                        
                        let icon = 'fas fa-file';
                        if (type === 'image') {
                            icon = 'fas fa-image';
                        } else if (type === 'video') {
                            icon = 'fas fa-video';
                        } else if (type === 'document') {
                            const ext = file.name.split('.').pop().toLowerCase();
                            if (ext === 'pdf') icon = 'fas fa-file-pdf';
                            else if (['doc', 'docx'].includes(ext)) icon = 'fas fa-file-word';
                            else if (['xls', 'xlsx'].includes(ext)) icon = 'fas fa-file-excel';
                            else if (['jpg', 'jpeg', 'png'].includes(ext)) icon = 'fas fa-image';
                            else icon = 'fas fa-file-alt';
                        }
                        
                        fileItem.innerHTML = `
                            <i class="${icon}"></i>
                            <div class="file-info">
                                <div class="file-name">${file.name}</div>
                                <div class="file-size">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                            </div>
                            <button type="button" class="remove-btn" onclick="removeFile(this)">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        
                        preview.appendChild(fileItem);
                    });
                    
                    let typeLabel = type === 'image' ? 'ảnh' : 
                                   type === 'video' ? 'video' : 'tài liệu';
                    showNotification(`Đã tải lên ${files.length} ${typeLabel}`);
                }
            });
        }

        function removeFile(button) {
            const fileItem = button.closest('.file-item');
            const preview = document.getElementById('filePreview');
            
            fileItem.remove();
            
            // Hide preview if no files left
            if (preview.children.length === 0) {
                preview.style.display = 'none';
            }
            
            showNotification('Đã xóa file');
        }

        handleFileUpload(document.getElementById('imageUpload'), 'image');
        handleFileUpload(document.getElementById('videoUpload'), 'video');
        handleFileUpload(document.getElementById('documentUpload'), 'document');

        // Form submission
        document.getElementById('evaluationForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            // Collect all form data
            const formData = new FormData(e.target);
            const ratings = {};
            
            document.querySelectorAll('.rating-stars').forEach(ratingGroup => {
                const ratingType = ratingGroup.dataset.rating;
                const value = ratingGroup.dataset.value || 0;
                ratings[ratingType] = value;
            });
            
            console.log('Form submitted with ratings:', ratings);
            showNotification('Báo cáo đánh giá đã được gửi thành công!');
        });

        // Show notification
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.querySelector('span').textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Task type change handler
        document.getElementById('taskType').addEventListener('change', (e) => {
            const taskType = e.target.value;
            renderMeasurementFields(taskType);
            console.log('Task type changed to:', taskType);
        });

        // Measurement field configurations for different task types
        const measurementConfigs = {
            'planting': {
                title: 'Đánh giá Trồng cây',
                sections: [
                    {
                        name: 'Thống kê cây trồng',
                        fields: [
                            { id: 'total_planted', label: 'Tổng số cây trồng', type: 'number', unit: 'cây' },
                            { id: 'trees_alive', label: 'Số cây sống', type: 'number', unit: 'cây' },
                            { id: 'trees_dead', label: 'Số cây chết', type: 'number', unit: 'cây' },
                            { id: 'survival_rate', label: 'Tỷ lệ sống', type: 'number', unit: '%', readonly: true },
                            { id: 'replanting_needed', label: 'Cần trồng lại', type: 'number', unit: 'cây', readonly: true }
                        ]
                    },
                    {
                        name: 'Tình trạng sinh trưởng',
                        fields: [
                            { id: 'avg_height', label: 'Chiều cao trung bình', type: 'number', step: '0.1', unit: 'cm' },
                            { id: 'leaf_condition', label: 'Tình trạng lá (1-5)', type: 'number', min: 1, max: 5 },
                            { id: 'root_condition', label: 'Tình trạng rễ (1-5)', type: 'number', min: 1, max: 5 },
                            { id: 'spacing_adequate', label: 'Khoảng cách phù hợp', type: 'select', options: ['Tốt', 'Chấp nhận được', 'Cần điều chỉnh'] }
                        ]
                    }
                ]
            },
            'harvesting': {
                title: 'Đánh giá Thu hoạch',
                sections: [
                    {
                        name: 'Sản lượng thực tế',
                        fields: [
                            { id: 'total_fruits', label: 'Tổng số trái', type: 'number', unit: 'trái' },
                            { id: 'total_weight', label: 'Tổng trọng lượng', type: 'number', step: '0.1', unit: 'kg' },
                            { id: 'avg_weight', label: 'Trọng lượng TB/trái', type: 'number', step: '0.01', unit: 'kg', readonly: true },
                            { id: 'yield_per_tree', label: 'Sản lượng/cây', type: 'number', step: '0.1', unit: 'kg/cây', readonly: true }
                        ]
                    },
                    {
                        name: 'Chất lượng sản phẩm',
                        fields: [
                            { id: 'grade_a', label: 'Loại A (xuất khẩu)', type: 'number', unit: 'kg' },
                            { id: 'grade_b', label: 'Loại B (thị trường nội địa)', type: 'number', unit: 'kg' },
                            { id: 'grade_c', label: 'Loại C (chế biến)', type: 'number', unit: 'kg' },
                            { id: 'damaged', label: 'Hư hỏng/loại bỏ', type: 'number', unit: 'kg' }
                        ]
                    }
                ]
            },
            'fertilizing': {
                title: 'Đánh giá Bón phân',
                sections: [
                    {
                        name: 'Lượng phân sử dụng',
                        fields: [
                            { id: 'fertilizer_type', label: 'Loại phân', type: 'select', options: ['NPK', 'Hữu cơ', 'Vi sinh', 'Lá', 'Khác'] },
                            { id: 'quantity_used', label: 'Lượng sử dụng', type: 'number', step: '0.1', unit: 'kg' },
                            { id: 'area_covered', label: 'Diện tích bón', type: 'number', step: '0.1', unit: 'm²' },
                            { id: 'dosage_per_m2', label: 'Liều lượng/m²', type: 'number', step: '0.01', unit: 'kg/m²', readonly: true }
                        ]
                    },
                    {
                        name: 'Hiệu quả bón phân',
                        fields: [
                            { id: 'leaf_color', label: 'Màu sắc lá (1-5)', type: 'number', min: 1, max: 5 },
                            { id: 'growth_response', label: 'Phản ứng sinh trưởng (1-5)', type: 'number', min: 1, max: 5 },
                            { id: 'soil_ph', label: 'pH đất', type: 'number', step: '0.1', min: 0, max: 14 },
                            { id: 'next_fertilizing', label: 'Dự kiến bón tiếp theo', type: 'date' }
                        ]
                    }
                ]
            },
            'pest-control': {
                title: 'Đánh giá Phòng trừ sâu bệnh',
                sections: [
                    {
                        name: 'Tình trạng sâu bệnh',
                        fields: [
                            { id: 'pest_type', label: 'Loại sâu bệnh', type: 'text' },
                            { id: 'affected_area', label: 'Diện tích bị ảnh hưởng', type: 'number', step: '0.1', unit: 'm²' },
                            { id: 'severity_level', label: 'Mức độ nghiêm trọng (1-5)', type: 'number', min: 1, max: 5 },
                            { id: 'infection_rate', label: 'Tỷ lệ nhiễm bệnh', type: 'number', step: '0.1', unit: '%' }
                        ]
                    },
                    {
                        name: 'Biện pháp xử lý',
                        fields: [
                            { id: 'treatment_method', label: 'Phương pháp xử lý', type: 'select', options: ['Thuốc bảo vệ thực vật', 'Sinh học', 'Cơ học', 'Tổng hợp'] },
                            { id: 'chemical_used', label: 'Tên thuốc/chế phẩm', type: 'text' },
                            { id: 'dosage_applied', label: 'Liều lượng sử dụng', type: 'number', step: '0.1', unit: 'ml/l' },
                            { id: 'effectiveness', label: 'Hiệu quả xử lý (1-5)', type: 'number', min: 1, max: 5 }
                        ]
                    }
                ]
            },
            'livestock-care': {
                title: 'Đánh giá Chăm sóc gia súc',
                sections: [
                    {
                        name: 'Thống kê đàn',
                        fields: [
                            { id: 'total_animals', label: 'Tổng số con', type: 'number', unit: 'con' },
                            { id: 'healthy_animals', label: 'Số con khỏe mạnh', type: 'number', unit: 'con' },
                            { id: 'sick_animals', label: 'Số con ốm', type: 'number', unit: 'con' },
                            { id: 'health_rate', label: 'Tỷ lệ khỏe mạnh', type: 'number', unit: '%', readonly: true }
                        ]
                    },
                    {
                        name: 'Tình trạng sức khỏe',
                        fields: [
                            { id: 'avg_weight', label: 'Trọng lượng TB', type: 'number', step: '0.1', unit: 'kg' },
                            { id: 'weight_gain', label: 'Tăng trọng TB/ngày', type: 'number', step: '0.01', unit: 'kg/ngày' },
                            { id: 'appetite_score', label: 'Tình trạng ăn uống (1-5)', type: 'number', min: 1, max: 5 },
                            { id: 'activity_score', label: 'Hoạt động (1-5)', type: 'number', min: 1, max: 5 }
                        ]
                    }
                ]
            },
            'soil-improvement': {
                title: 'Đánh giá Cải tạo đất',
                sections: [
                    {
                        name: 'Tính chất đất',
                        fields: [
                            { id: 'soil_ph', label: 'pH đất', type: 'number', step: '0.1', min: 0, max: 14 },
                            { id: 'organic_matter', label: 'Chất hữu cơ', type: 'number', step: '0.1', unit: '%' },
                            { id: 'soil_moisture', label: 'Độ ẩm đất', type: 'number', step: '0.1', unit: '%' },
                            { id: 'soil_texture', label: 'Kết cấu đất', type: 'select', options: ['Cát', 'Thịt', 'Sét', 'Pha cát', 'Pha thịt', 'Pha sét'] }
                        ]
                    },
                    {
                        name: 'Chất lượng sau cải tạo',
                        fields: [
                            { id: 'drainage_quality', label: 'Thoát nước (1-5)', type: 'number', min: 1, max: 5 },
                            { id: 'aeration_quality', label: 'Thoáng khí (1-5)', type: 'number', min: 1, max: 5 },
                            { id: 'nutrient_level', label: 'Mức dinh dưỡng (1-5)', type: 'number', min: 1, max: 5 },
                            { id: 'ready_for_planting', label: 'Sẵn sàng trồng trọt', type: 'select', options: ['Đã sẵn sàng', 'Cần thêm thời gian', 'Cần cải tạo thêm'] }
                        ]
                    }
                ]
            }
        };

        function renderMeasurementFields(taskType) {
            const container = document.getElementById('measurementFields');
            
            if (!taskType || !measurementConfigs[taskType]) {
                container.innerHTML = `
                    <div class="default-measurement">
                        <textarea class="form-control" placeholder="Nhập các số liệu đo được, quan sát chi tiết về chất lượng, tình trạng cây trồng/vật nuôi..."></textarea>
                    </div>
                    <div class="add-field-section">
                        <button type="button" class="add-field-btn" onclick="showAddFieldModal()">
                            <i class="fas fa-plus-circle"></i>
                            Thêm trường đo lường
                        </button>
                        <div class="quick-add-buttons"></div>
                    </div>
                `;
                return;
            }

            const config = measurementConfigs[taskType];
            let html = `<h4 style="color: #2E7D32; margin-bottom: 20px;">${config.title}</h4>`;

            config.sections.forEach(section => {
                html += `
                    <div class="measurement-section">
                        <h4>${section.name}</h4>
                        <div class="measurement-grid">
                `;

                section.fields.forEach(field => {
                    let inputHtml = '';
                    
                    if (field.type === 'select') {
                        inputHtml = `
                            <select id="${field.id}" class="form-control" ${field.readonly ? 'disabled' : ''}>
                                <option value="">-- Chọn --</option>
                                ${field.options.map(option => `<option value="${option}">${option}</option>`).join('')}
                            </select>
                        `;
                    } else {
                        inputHtml = `
                            <input 
                                type="${field.type}" 
                                id="${field.id}" 
                                class="form-control"
                                ${field.step ? `step="${field.step}"` : ''}
                                ${field.min !== undefined ? `min="${field.min}"` : ''}
                                ${field.max !== undefined ? `max="${field.max}"` : ''}
                                ${field.readonly ? 'readonly' : ''}
                                placeholder="Nhập ${field.label.toLowerCase()}"
                            />
                        `;
                    }

                    html += `
                        <div class="measurement-field">
                            <label for="${field.id}">${field.label}</label>
                            ${inputHtml}
                            ${field.unit ? `<div class="unit">${field.unit}</div>` : ''}
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            // Add custom fields section
            html += `<div id="customFieldsContainer"></div>`;

            // Add calculation results section
            html += `
                <div id="calculationResults" class="calculation-result" style="display: none;">
                    <h4><i class="fas fa-calculator"></i> Kết quả tính toán</h4>
                    <div id="calculationContent"></div>
                </div>
            `;

            // Add CTA section
            html += `
                <div class="add-field-section">
                    <button type="button" class="add-field-btn" onclick="showAddFieldModal()">
                        <i class="fas fa-plus-circle"></i>
                        Thêm trường đo lường
                    </button>
                    <div class="quick-add-buttons" id="quickAddButtons"></div>
                </div>
            `;

            // Add general description field
            html += `
                <div class="measurement-section">
                    <h4>Mô tả chi tiết bổ sung</h4>
                    <textarea class="form-control" placeholder="Nhập các quan sát, nhận xét chi tiết khác..."></textarea>
                </div>
            `;

            container.innerHTML = html;

            // Add event listeners for calculations
            addCalculationListeners(taskType);
            
            // Render quick add buttons
            renderQuickAddButtons(taskType);
        }

        function addCalculationListeners(taskType) {
            const inputs = document.querySelectorAll('#measurementFields input, #measurementFields select');
            
            inputs.forEach(input => {
                input.addEventListener('input', () => calculateResults(taskType));
            });
        }

        function calculateResults(taskType) {
            const resultsDiv = document.getElementById('calculationResults');
            const contentDiv = document.getElementById('calculationContent');
            let calculations = [];
            let alerts = [];

            switch(taskType) {
                case 'planting':
                    const totalPlanted = parseFloat(document.getElementById('total_planted')?.value) || 0;
                    const treesAlive = parseFloat(document.getElementById('trees_alive')?.value) || 0;
                    const treesDead = parseFloat(document.getElementById('trees_dead')?.value) || 0;
                    
                    if (totalPlanted > 0) {
                        const survivalRate = ((treesAlive / totalPlanted) * 100).toFixed(1);
                        const replantiongNeeded = Math.max(0, totalPlanted - treesAlive);
                        
                        document.getElementById('survival_rate').value = survivalRate;
                        document.getElementById('replanting_needed').value = replantiongNeeded;
                        
                        calculations.push(`Tỷ lệ sống: ${survivalRate}%`);
                        calculations.push(`Cần trồng lại: ${replantiongNeeded} cây`);
                        
                        if (survivalRate < 80) {
                            alerts.push({
                                type: 'danger',
                                message: `Tỷ lệ sống thấp (${survivalRate}%). Cần kiểm tra nguyên nhân và có biện pháp khắc phục.`
                            });
                        } else if (survivalRate < 90) {
                            alerts.push({
                                type: 'warning', 
                                message: `Tỷ lệ sống chấp nhận được (${survivalRate}%). Theo dõi thêm.`
                            });
                        }
                    }
                    break;

                case 'harvesting':
                    const totalFruits = parseFloat(document.getElementById('total_fruits')?.value) || 0;
                    const totalWeight = parseFloat(document.getElementById('total_weight')?.value) || 0;
                    
                    if (totalFruits > 0 && totalWeight > 0) {
                        const avgWeight = (totalWeight / totalFruits).toFixed(3);
                        document.getElementById('avg_weight').value = avgWeight;
                        calculations.push(`Trọng lượng TB/trái: ${avgWeight} kg`);
                    }
                    
                    const gradeA = parseFloat(document.getElementById('grade_a')?.value) || 0;
                    const gradeB = parseFloat(document.getElementById('grade_b')?.value) || 0;
                    const gradeC = parseFloat(document.getElementById('grade_c')?.value) || 0;
                    const damaged = parseFloat(document.getElementById('damaged')?.value) || 0;
                    
                    if (totalWeight > 0) {
                        const gradeAPercent = ((gradeA / totalWeight) * 100).toFixed(1);
                        calculations.push(`Tỷ lệ loại A: ${gradeAPercent}%`);
                        
                        if (gradeAPercent < 60) {
                            alerts.push({
                                type: 'warning',
                                message: `Tỷ lệ loại A thấp (${gradeAPercent}%). Cần cải thiện chất lượng.`
                            });
                        }
                    }
                    break;

                case 'fertilizing':
                    const quantityUsed = parseFloat(document.getElementById('quantity_used')?.value) || 0;
                    const areaCovered = parseFloat(document.getElementById('area_covered')?.value) || 0;
                    
                    if (quantityUsed > 0 && areaCovered > 0) {
                        const dosagePerM2 = (quantityUsed / areaCovered).toFixed(3);
                        document.getElementById('dosage_per_m2').value = dosagePerM2;
                        calculations.push(`Liều lượng: ${dosagePerM2} kg/m²`);
                    }
                    break;

                case 'livestock-care':
                    const totalAnimals = parseFloat(document.getElementById('total_animals')?.value) || 0;
                    const healthyAnimals = parseFloat(document.getElementById('healthy_animals')?.value) || 0;
                    
                    if (totalAnimals > 0) {
                        const healthRate = ((healthyAnimals / totalAnimals) * 100).toFixed(1);
                        document.getElementById('health_rate').value = healthRate;
                        calculations.push(`Tỷ lệ khỏe mạnh: ${healthRate}%`);
                        
                        if (healthRate < 90) {
                            alerts.push({
                                type: 'danger',
                                message: `Tỷ lệ khỏe mạnh thấp (${healthRate}%). Cần kiểm tra sức khỏe đàn.`
                            });
                        }
                    }
                    break;
            }

            if (calculations.length > 0 || alerts.length > 0) {
                let content = '';
                
                if (calculations.length > 0) {
                    content += calculations.map(calc => `<div>✓ ${calc}</div>`).join('');
                }
                
                alerts.forEach(alert => {
                    content += `<div class="alert-${alert.type}"><i class="fas fa-exclamation-triangle"></i> ${alert.message}</div>`;
                });
                
                contentDiv.innerHTML = content;
                resultsDiv.style.display = 'block';
            } else {
                resultsDiv.style.display = 'none';
            }
        }

        // Quick add button suggestions for different task types
        const quickAddSuggestions = {
            'planting': [
                { label: 'Độ pH đất', type: 'number', unit: 'pH' },
                { label: 'Độ ẩm đất', type: 'number', unit: '%' },
                { label: 'Nhiệt độ', type: 'number', unit: '°C' },
                { label: 'Thời tiết', type: 'select', options: ['Nắng', 'Mưa', 'Âm u', 'Gió'] }
            ],
            'harvesting': [
                { label: 'Độ ngọt Brix', type: 'number', unit: '°Bx' },
                { label: 'Độ cứng quả', type: 'rating' },
                { label: 'Màu sắc', type: 'select', options: ['Xanh', 'Vàng', 'Đỏ', 'Tím'] },
                { label: 'Thời gian bảo quản', type: 'number', unit: 'ngày' }
            ],
            'fertilizing': [
                { label: 'Nhiệt độ môi trường', type: 'number', unit: '°C' },
                { label: 'Độ ẩm không khí', type: 'number', unit: '%' },
                { label: 'Tình trạng thời tiết', type: 'select', options: ['Khô ráo', 'Ẩm ướt', 'Mưa'] }
            ],
            'pest-control': [
                { label: 'Tốc độ gió', type: 'number', unit: 'm/s' },
                { label: 'Nhiệt độ phun', type: 'number', unit: '°C' },
                { label: 'Thời gian sau phun', type: 'number', unit: 'giờ' }
            ],
            'livestock-care': [
                { label: 'Nhiệt độ chuồng', type: 'number', unit: '°C' },
                { label: 'Độ ẩm chuồng', type: 'number', unit: '%' },
                { label: 'Chất lượng thức ăn', type: 'rating' }
            ],
            'soil-improvement': [
                { label: 'Lượng nước tưới', type: 'number', unit: 'lít/m²' },
                { label: 'Thời gian ủ phân', type: 'number', unit: 'ngày' },
                { label: 'Độ xốp đất', type: 'rating' }
            ]
        };

        function renderQuickAddButtons(taskType) {
            const container = document.getElementById('quickAddButtons');
            if (!container || !quickAddSuggestions[taskType]) return;

            const suggestions = quickAddSuggestions[taskType];
            container.innerHTML = suggestions.map(suggestion => 
                `<button type="button" class="quick-add-btn" onclick="quickAddField('${JSON.stringify(suggestion).replace(/'/g, "\\'")}')">
                    <i class="fas fa-plus"></i> ${suggestion.label}
                </button>`
            ).join('');
        }

        function quickAddField(suggestionStr) {
            const suggestion = JSON.parse(suggestionStr);
            addCustomFieldFromData(suggestion);
        }

        // Modal functions
        function showAddFieldModal() {
            document.getElementById('addFieldModal').style.display = 'block';
        }

        function closeAddFieldModal() {
            document.getElementById('addFieldModal').style.display = 'none';
            document.getElementById('addFieldForm').reset();
            toggleModalGroups();
        }

        // Handle field type change in modal
        document.getElementById('fieldType').addEventListener('change', function() {
            toggleModalGroups();
        });

        function toggleModalGroups() {
            const fieldType = document.getElementById('fieldType').value;
            const unitGroup = document.getElementById('unitGroup');
            const optionsGroup = document.getElementById('optionsGroup');
            const rangeGroup = document.getElementById('rangeGroup');

            // Hide all groups first
            unitGroup.style.display = 'none';
            optionsGroup.style.display = 'none';
            rangeGroup.style.display = 'none';

            // Show relevant groups based on field type
            if (fieldType === 'number') {
                unitGroup.style.display = 'block';
                rangeGroup.style.display = 'block';
            } else if (fieldType === 'select') {
                optionsGroup.style.display = 'block';
            }
        }

        function addCustomField() {
            const label = document.getElementById('fieldLabel').value.trim();
            const type = document.getElementById('fieldType').value;
            const unit = document.getElementById('fieldUnit').value.trim();
            const options = document.getElementById('fieldOptions').value.trim();
            const min = document.getElementById('fieldMin').value;
            const max = document.getElementById('fieldMax').value;
            const description = document.getElementById('fieldDescription').value.trim();

            if (!label || !type) {
                showNotification('Vui lòng nhập đầy đủ tên trường và loại dữ liệu');
                return;
            }

            const fieldData = {
                label: label,
                type: type,
                unit: unit,
                description: description
            };

            if (type === 'select' && options) {
                fieldData.options = options.split('\n').map(opt => opt.trim()).filter(opt => opt);
            }

            if (type === 'number') {
                if (min) fieldData.min = parseFloat(min);
                if (max) fieldData.max = parseFloat(max);
            }

            addCustomFieldFromData(fieldData);
            closeAddFieldModal();
        }

        function addCustomFieldFromData(fieldData) {
            const container = document.getElementById('customFieldsContainer');
            const fieldId = 'custom_' + Date.now();
            
            let inputHtml = '';
            
            if (fieldData.type === 'select' && fieldData.options) {
                inputHtml = `
                    <select id="${fieldId}" class="form-control">
                        <option value="">-- Chọn --</option>
                        ${fieldData.options.map(option => `<option value="${option}">${option}</option>`).join('')}
                    </select>
                `;
            } else if (fieldData.type === 'rating') {
                inputHtml = `
                    <div class="rating-stars custom-rating" data-rating="${fieldId}">
                        <span class="star" data-value="1">★</span>
                        <span class="star" data-value="2">★</span>
                        <span class="star" data-value="3">★</span>
                        <span class="star" data-value="4">★</span>
                        <span class="star" data-value="5">★</span>
                    </div>
                `;
            } else {
                inputHtml = `
                    <input 
                        type="${fieldData.type}" 
                        id="${fieldId}" 
                        class="form-control"
                        ${fieldData.min !== undefined ? `min="${fieldData.min}"` : ''}
                        ${fieldData.max !== undefined ? `max="${fieldData.max}"` : ''}
                        placeholder="Nhập ${fieldData.label.toLowerCase()}"
                    />
                `;
            }

            const customFieldSection = document.createElement('div');
            customFieldSection.className = 'measurement-section custom-field';
            customFieldSection.innerHTML = `
                <button type="button" class="remove-field" onclick="removeCustomField(this)">
                    <i class="fas fa-times"></i>
                </button>
                <h4>${fieldData.label} (Tùy chỉnh)</h4>
                ${fieldData.description ? `<p style="font-size: 14px; color: #666; margin-bottom: 15px;">${fieldData.description}</p>` : ''}
                <div class="measurement-grid">
                    <div class="measurement-field">
                        <label for="${fieldId}">${fieldData.label}</label>
                        ${inputHtml}
                        ${fieldData.unit ? `<div class="unit">${fieldData.unit}</div>` : ''}
                    </div>
                </div>
            `;

            container.appendChild(customFieldSection);

            // Add rating functionality if it's a rating field
            if (fieldData.type === 'rating') {
                initializeRating(customFieldSection.querySelector('.custom-rating'));
            }

            showNotification(`Đã thêm trường "${fieldData.label}"`);
        }

        function removeCustomField(button) {
            const fieldSection = button.closest('.custom-field');
            const fieldName = fieldSection.querySelector('h4').textContent.replace(' (Tùy chỉnh)', '');
            fieldSection.remove();
            showNotification(`Đã xóa trường "${fieldName}"`);
        }

        function initializeRating(ratingElement) {
            const stars = ratingElement.querySelectorAll('.star');
            
            stars.forEach((star, index) => {
                star.addEventListener('click', () => {
                    const rating = index + 1;
                    
                    stars.forEach((s, i) => {
                        if (i < rating) {
                            s.classList.add('active');
                        } else {
                            s.classList.remove('active');
                        }
                    });
                    
                    ratingElement.dataset.value = rating;
                });
                
                star.addEventListener('mouseenter', () => {
                    const rating = index + 1;
                    stars.forEach((s, i) => {
                        if (i < rating) {
                            s.style.color = '#FFD700';
                        } else {
                            s.style.color = '#ddd';
                        }
                    });
                });
            });
            
            ratingElement.addEventListener('mouseleave', () => {
                const currentRating = ratingElement.dataset.value || 0;
                stars.forEach((s, i) => {
                    if (i < currentRating) {
                        s.style.color = '#FFD700';
                    } else {
                        s.style.color = '#ddd';
                    }
                });
            });
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('addFieldModal');
            if (event.target === modal) {
                closeAddFieldModal();
            }
        });

        // Prevent form submission on button clicks
        document.querySelectorAll('.btn').forEach(btn => {
            if (btn.type !== 'submit') {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const action = btn.textContent.trim();
                    showNotification(`Đã ${action.toLowerCase()}`);
                });
            }
        });
    </script>
</body>
</html>