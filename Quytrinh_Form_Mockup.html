<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FarmKeeper - Quy trình Sản xuất Nông nghiệp Thông minh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #059669;
            --secondary-color: #0d9488;
            --accent-color: #f59e0b;
            --surface-color: #ffffff;
            --background-color: #f8fafc;
        }
        
        .main-container {
            background: linear-gradient(135deg, var(--background-color) 0%, #e2e8f0 100%);
            min-height: 100vh;
        }
        
        .card-modern {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(226, 232, 240, 0.5);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }
        
        .template-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border-radius: 16px 16px 0 0;
            padding: 2rem;
        }
        
        .phase-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            background: white;
            position: relative;
            overflow: hidden;
        }
        
        .phase-card.setup-phase {
            border-left: 6px solid #6366f1;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.02) 0%, rgba(99, 102, 241, 0.01) 100%);
        }
        
        .phase-card.recurring-phase {
            border-left: 6px solid var(--primary-color);
            background: linear-gradient(135deg, rgba(5, 150, 105, 0.02) 0%, rgba(5, 150, 105, 0.01) 100%);
        }
        
        .phase-header {
            color: white;
            padding: 1.25rem 1.5rem;
            border-radius: 10px 10px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }
        
        .phase-header.phase-1 { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); }
        .phase-header.phase-2 { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
        .phase-header.phase-3 { background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); }
        .phase-header.phase-4 { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); }
        .phase-header.phase-5 { background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%); }
        .phase-header.phase-6 { background: linear-gradient(135deg, var(--accent-color) 0%, #d97706 100%); }
        .phase-header.phase-7 { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        
        .cycle-indicator {
            position: absolute;
            top: -10px;
            right: 20px;
            background: white;
            color: var(--primary-color);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            border: 2px solid var(--primary-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .setup-indicator {
            background: white;
            color: #6366f1;
            border-color: #6366f1;
        }
        
        .phase-content {
            padding: 1.5rem;
        }
        
        .task-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .task-card:hover {
            background: #f1f5f9;
            border-color: var(--primary-color);
            transform: translateX(6px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.1);
        }
        
        .task-card.completed {
            background: #f0fdf4;
            border-color: var(--primary-color);
            border-width: 2px;
        }
        
        .add-task-btn {
            border: 2px dashed #cbd5e1;
            background: #f8fafc;
            border-radius: 10px;
            padding: 1.25rem;
            text-align: center;
            color: #64748b;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .add-task-btn:hover {
            border-color: var(--primary-color);
            background: #f0fdf4;
            color: var(--primary-color);
        }
        
        .cycle-divider {
            border: 3px dashed var(--primary-color);
            border-radius: 16px;
            background: linear-gradient(135deg, rgba(5, 150, 105, 0.08) 0%, rgba(5, 150, 105, 0.03) 100%);
            margin: 2.5rem 0;
            padding: 2rem;
            text-align: center;
            position: relative;
        }
        
        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-size: 0.875rem;
            background: white;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(5, 150, 105, 0.1);
            background: #fafafa;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 0.875rem 1.5rem;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(5, 150, 105, 0.3);
        }
        
        .btn-secondary {
            background: #f8fafc;
            color: #475569;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
        }
        
        .btn-secondary:hover {
            background: #f1f5f9;
            border-color: var(--primary-color);
            color: var(--primary-color);
            transform: translateY(-1px);
        }
        
        .resource-tag {
            background: #dbeafe;
            color: #1e40af;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 0.75rem;
            margin: 2px 4px 2px 0;
            display: inline-flex;
            align-items: center;
            font-weight: 500;
        }
        
        .skill-tag {
            background: #fef3c7;
            color: #92400e;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 1200px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        .tab-btn {
            padding: 0.75rem 1rem;
            border: none;
            background: transparent;
            color: #6b7280;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-btn:hover {
            color: var(--primary-color);
            background: #f9fafb;
        }
        
        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: #f0fdf4;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .material-item, .risk-item {
            transition: all 0.3s ease;
        }
        
        .material-item:hover, .risk-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .form-section {
            border-bottom: 1px solid #f1f5f9;
            padding: 1.5rem;
        }
        
        .form-section:last-child {
            border-bottom: none;
        }
        
        .sidebar-info {
            position: sticky;
            top: 20px;
        }
        
        .config-panel {
            background: linear-gradient(135deg, rgba(5, 150, 105, 0.08) 0%, rgba(13, 148, 136, 0.05) 100%);
            border: 2px solid rgba(5, 150, 105, 0.15);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .template-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-gap { background: #dcfce7; color: #166534; }
        .badge-vietgap { background: #dbeafe; color: #1e40af; }
        .badge-export { background: #fef3c7; color: #92400e; }
        .badge-organic { background: #f3e8ff; color: #7c3aed; }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }
        
        .quick-actions {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 100;
        }
        
        .fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border: none;
            box-shadow: 0 8px 24px rgba(5, 150, 105, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 12px;
        }
        
        .fab:hover {
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 12px 32px rgba(5, 150, 105, 0.4);
        }
        
        .progress-bar {
            height: 8px;
            background: #f1f5f9;
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        @media (max-width: 1024px) {
            .sidebar-info {
                position: static;
            }
            
            .quick-actions {
                bottom: 16px;
                right: 16px;
            }
        }
        
        .compact-mode .phase-content {
            padding: 1rem;
        }
        
        .compact-mode .task-card {
            padding: 1rem;
            margin-bottom: 0.75rem;
        }
    </style>
</head>
<body class="main-container">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Template Header -->
        <div class="card-modern mb-6">
            <div class="template-header">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <div class="flex-1 min-w-0">
                        <h1 class="text-2xl lg:text-3xl font-bold mb-2" id="process-title">
                            Quy trình Sản xuất Nông nghiệp Thông minh
                        </h1>
                        <p class="text-white/90 text-sm lg:text-base" id="process-subtitle">
                            Template tùy chỉnh cho mọi đối tượng sản xuất
                        </p>
                        <div class="flex flex-wrap gap-2 mt-3" id="standards-badges">
                            <span class="template-badge badge-gap">
                                <i class="fas fa-certificate mr-1"></i>GAP
                            </span>
                            <span class="template-badge badge-vietgap">
                                <i class="fas fa-globe mr-1"></i>VietGAP
                            </span>
                            <span class="template-badge badge-export">
                                <i class="fas fa-shipping-fast mr-1"></i>Xuất khẩu
                            </span>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button class="btn-secondary" onclick="exportTemplate()">
                            <i class="fas fa-download mr-2"></i>Xuất
                        </button>
                        <button class="btn-secondary" onclick="importTemplate()">
                            <i class="fas fa-upload mr-2"></i>Nhập
                        </button>
                        <button class="btn-primary" onclick="publishProcess()">
                            <i class="fas fa-rocket mr-2"></i>Xuất bản
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Main Content -->
            <div class="lg:col-span-3 space-y-6">
                <!-- Template Configuration -->
                <div class="config-panel">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800 flex items-center">
                            <i class="fas fa-cogs mr-2 text-emerald-600"></i>
                            Cấu hình Template
                        </h3>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600">Chế độ gọn:</label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only" onchange="toggleCompactMode()">
                                <div class="relative">
                                    <div class="block bg-gray-200 w-10 h-6 rounded-full"></div>
                                    <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Loại sản xuất</label>
                            <select class="form-input text-sm" id="production-type" onchange="updateProductionType()">
                                <option value="crops">Cây trồng</option>
                                <option value="livestock">Chăn nuôi</option>
                                <option value="aquaculture">Thủy sản</option>
                                <option value="mixed">Hỗn hợp</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Đối tượng cụ thể</label>
                            <select class="form-input text-sm" id="specific-object" onchange="updateSpecificObject()">
                                <option value="durian">Sầu riêng</option>
                                <option value="mango">Xoài</option>
                                <option value="coffee">Cà phê</option>
                                <option value="rice">Lúa gạo</option>
                                <option value="pig">Heo</option>
                                <option value="chicken">Gà</option>
                                <option value="fish">Cá</option>
                                <option value="shrimp">Tôm</option>
                                <option value="custom">Tùy chỉnh</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Giống/Loại</label>
                            <select class="form-input text-sm" id="variety">
                                <option value="dona">Dona (Thái)</option>
                                <option value="ri6">Ri 6</option>
                                <option value="monthong">Monthong</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Quy mô</label>
                            <select class="form-input text-sm" id="scale">
                                <option value="small">Nhỏ (<5ha)</option>
                                <option value="medium">Trung bình (5-20ha)</option>
                                <option value="large">Lớn (>20ha)</option>
                                <option value="industrial">Công nghiệp</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mô tả quy trình</label>
                        <textarea class="form-input text-sm" rows="2" id="process-description" 
                                placeholder="Nhập mô tả ngắn gọn về quy trình này...">Quy trình sản xuất tối ưu với tiêu chuẩn chất lượng cao, áp dụng công nghệ tiên tiến và phương pháp bền vững.</textarea>
                    </div>
                </div>

                <!-- Cycle Configuration -->
                <div class="card-modern">
                    <div class="p-4 border-b border-gray-100">
                        <h3 class="text-lg font-bold text-gray-800 flex items-center">
                            <i class="fas fa-sync-alt mr-2 text-emerald-600"></i>
                            Cấu hình Chu kỳ
                        </h3>
                    </div>
                    <div class="p-4">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Loại chu kỳ</label>
                                <select class="form-input text-sm" id="cycle-type" onchange="updateCycleType()">
                                    <option value="annual">Hàng năm</option>
                                    <option value="seasonal">Theo mùa</option>
                                    <option value="quarterly">Theo quý</option>
                                    <option value="monthly">Hàng tháng</option>
                                    <option value="custom">Tùy chỉnh</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Thời gian</label>
                                <div class="flex items-center space-x-2">
                                    <input type="number" class="form-input text-sm w-16" value="12" min="1">
                                    <select class="form-input text-sm flex-1">
                                        <option value="months">Tháng</option>
                                        <option value="weeks">Tuần</option>
                                        <option value="days">Ngày</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Bắt đầu lặp</label>
                                <select class="form-input text-sm" id="start-recurring">
                                    <option value="3">Giai đoạn 3</option>
                                    <option value="4" selected>Giai đoạn 4</option>
                                    <option value="5">Giai đoạn 5</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Trạng thái</label>
                                <div class="flex items-center justify-center h-10">
                                    <label class="inline-flex items-center cursor-pointer">
                                        <input type="checkbox" class="sr-only" checked onchange="toggleRecurringCycle()">
                                        <div class="relative">
                                            <div class="block bg-emerald-200 w-12 h-6 rounded-full"></div>
                                            <div class="dot absolute right-1 top-1 bg-emerald-600 w-4 h-4 rounded-full transition"></div>
                                        </div>
                                        <span class="ml-2 text-sm text-gray-700">Kích hoạt</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Setup Phases -->
                <div class="card-modern">
                    <div class="p-4 border-b border-gray-100">
                        <h2 class="text-xl font-bold text-indigo-700 flex items-center">
                            <i class="fas fa-rocket mr-2"></i>
                            Giai đoạn Thiết lập (Một lần)
                        </h2>
                    </div>
                    <div class="p-4 space-y-4" id="setup-phases">
                        <!-- Phase 1: Survey & Planning -->
                        <div class="phase-card setup-phase" data-phase="1">
                            <div class="cycle-indicator setup-indicator">Một lần</div>
                            <div class="phase-header phase-1">
                                <div class="flex items-center flex-1">
                                    <i class="fas fa-search mr-3 text-xl"></i>
                                    <div>
                                        <h3 class="text-base font-bold">Giai đoạn 1: Khảo sát và Lập kế hoạch</h3>
                                        <p class="text-sm opacity-90">Đánh giá điều kiện và thiết kế quy hoạch sản xuất</p>
                                    </div>
                                </div>
                                <div class="flex space-x-1">
                                    <button class="text-white hover:text-indigo-200 p-2 text-sm" onclick="editPhase(1)">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="text-white hover:text-red-200 p-2 text-sm" onclick="duplicatePhase(1)">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <button class="text-white hover:text-red-200 p-2 text-sm" onclick="deletePhase(1)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="phase-content">
                                <div class="task-card" onclick="editTask(1, 1)">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800 text-sm">Khảo sát địa hình và thổ nhưỡng</h4>
                                            <p class="text-xs text-gray-600 mt-1">Đo đạc, phân tích đất, đánh giá nguồn nước và điều kiện khí hậu</p>
                                            
                                            <div class="flex flex-wrap mt-2">
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-map mr-1"></i>GPS, máy đo
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-vial mr-1"></i>Kit phân tích đất
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-users mr-1"></i>2-3 chuyên gia
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="skill-tag text-xs">Chuyên gia</span>
                                            <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="task-card" onclick="editTask(1, 2)">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800 text-sm">Lập kế hoạch quy hoạch sản xuất</h4>
                                            <p class="text-xs text-gray-600 mt-1">Thiết kế layout, phân vùng sản xuất và hệ thống hạ tầng</p>
                                            
                                            <div class="flex flex-wrap mt-2">
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-drafting-compass mr-1"></i>Phần mềm thiết kế
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-calculator mr-1"></i>Tính toán diện tích
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="skill-tag text-xs">Nâng cao</span>
                                            <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="task-card" onclick="editTask(1, 3)">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800 text-sm">Xin phép và thủ tục pháp lý</h4>
                                            <p class="text-xs text-gray-600 mt-1">Hoàn tất giấy phép sản xuất, chứng nhận đất đai và các thủ tục liên quan</p>
                                            
                                            <div class="flex flex-wrap mt-2">
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-file-alt mr-1"></i>Hồ sơ pháp lý
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-stamp mr-1"></i>Phí thủ tục
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="skill-tag text-xs">Trung bình</span>
                                            <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="task-card" onclick="editTask(1, 4)">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800 text-sm">Lập dự toán chi phí đầu tư</h4>
                                            <p class="text-xs text-gray-600 mt-1">Tính toán chi phí xây dựng, thiết bị, vật tư và vận hành</p>
                                            
                                            <div class="flex flex-wrap mt-2">
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-chart-line mr-1"></i>Bảng tính Excel
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-money-bill mr-1"></i>Báo giá thị trường
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="skill-tag text-xs">Nâng cao</span>
                                            <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="add-task-btn" onclick="addTask(1)">
                                    <i class="fas fa-plus mr-2"></i>
                                    <span class="text-sm">Thêm công việc</span>
                                </div>
                            </div>
                        </div>

                        <!-- Phase 2: Infrastructure -->
                        <div class="phase-card setup-phase" data-phase="2">
                            <div class="cycle-indicator setup-indicator">Một lần</div>
                            <div class="phase-header phase-2">
                                <div class="flex items-center flex-1">
                                    <i class="fas fa-hammer mr-3 text-xl"></i>
                                    <div>
                                        <h3 class="text-base font-bold">Giai đoạn 2: Xây dựng Cơ sở hạ tầng</h3>
                                        <p class="text-sm opacity-90">Xây dựng và lắp đặt các hệ thống cần thiết</p>
                                    </div>
                                </div>
                                <div class="flex space-x-1">
                                    <button class="text-white hover:text-purple-200 p-2 text-sm" onclick="editPhase(2)">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="text-white hover:text-red-200 p-2 text-sm" onclick="duplicatePhase(2)">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <button class="text-white hover:text-red-200 p-2 text-sm" onclick="deletePhase(2)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="phase-content">
                                <div class="task-card" onclick="editTask(2, 1)">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800 text-sm">Chuẩn bị mặt bằng</h4>
                                            <p class="text-xs text-gray-600 mt-1">San ủi, dọn dẹp thực bì và chuẩn bị nền móng</p>
                                            
                                            <div class="flex flex-wrap mt-2">
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-bulldozer mr-1"></i>Máy san ủi
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-truck mr-1"></i>Xe vận chuyển
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-users mr-1"></i>5-8 người</span>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="skill-tag text-xs">Cơ bản</span>
                                            <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="task-card" onclick="editTask(2, 2)">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800 text-sm">Xây dựng hệ thống tưới tiêu</h4>
                                            <p class="text-xs text-gray-600 mt-1">Lắp đặt ống nước, máy bơm, hệ thống phun và thoát nước</p>
                                            
                                            <div class="flex flex-wrap mt-2">
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-pipe mr-1"></i>Ống PVC, PE
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-pump-soap mr-1"></i>Máy bơm nước
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-users mr-1"></i>3-5 thợ</span>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="skill-tag text-xs">Nâng cao</span>
                                            <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="task-card" onclick="editTask(2, 3)">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800 text-sm">Xây dựng nhà kho và công trình</h4>
                                            <p class="text-xs text-gray-600 mt-1">Xây nhà kho, nhà làm việc, hàng rào và đường nội bộ</p>
                                            
                                            <div class="flex flex-wrap mt-2">
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-warehouse mr-1"></i>Vật liệu xây dựng
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-users mr-1"></i>8-12 thợ
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="skill-tag text-xs">Chuyên gia</span>
                                            <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="task-card" onclick="editTask(2, 4)">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800 text-sm">Lắp đặt điện và hệ thống điều khiển</h4>
                                            <p class="text-xs text-gray-600 mt-1">Kéo điện, lắp đặt tủ điều khiển và hệ thống tự động</p>
                                            
                                            <div class="flex flex-wrap mt-2">
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-bolt mr-1"></i>Thiết bị điện
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-microchip mr-1"></i>Hệ thống điều khiển
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="skill-tag text-xs">Chuyên gia</span>
                                            <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="add-task-btn" onclick="addTask(2)">
                                    <i class="fas fa-plus mr-2"></i>
                                    <span class="text-sm">Thêm công việc</span>
                                </div>
                            </div>
                        </div>

                        <!-- Phase 3: Initial Setup -->
                        <div class="phase-card setup-phase" data-phase="3">
                            <div class="cycle-indicator setup-indicator">Một lần</div>
                            <div class="phase-header phase-1">
                                <div class="flex items-center flex-1">
                                    <i class="fas fa-seedling mr-3 text-xl"></i>
                                    <div>
                                        <h3 class="text-base font-bold">Giai đoạn 3: Thiết lập Ban đầu</h3>
                                        <p class="text-sm opacity-90">Gieo trồng/Nhập giống và thiết lập môi trường sản xuất</p>
                                    </div>
                                </div>
                                <div class="flex space-x-1">
                                    <button class="text-white hover:text-indigo-200 p-2 text-sm" onclick="editPhase(3)">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="text-white hover:text-red-200 p-2 text-sm" onclick="duplicatePhase(3)">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <button class="text-white hover:text-red-200 p-2 text-sm" onclick="deletePhase(3)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="phase-content">
                                <div class="task-card" onclick="editTask(3, 1)">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800 text-sm">Chọn và mua giống/con giống chất lượng</h4>
                                            <p class="text-xs text-gray-600 mt-1">Lựa chọn nhà cung cấp uy tín, kiểm tra chất lượng giống</p>
                                            
                                            <div class="flex flex-wrap mt-2">
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-certificate mr-1"></i>Chứng nhận giống
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-search mr-1"></i>Kiểm tra chất lượng
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="skill-tag text-xs">Chuyên gia</span>
                                            <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="task-card" onclick="editTask(3, 2)">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800 text-sm">Chuẩn bị môi trường sản xuất</h4>
                                            <p class="text-xs text-gray-600 mt-1">Khử trùng, chuẩn bị đất/ao/chuồng theo tiêu chuẩn</p>
                                            
                                            <div class="flex flex-wrap mt-2">
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-spray-can mr-1"></i>Hóa chất khử trùng
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-thermometer mr-1"></i>Kiểm soát nhiệt độ
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="skill-tag text-xs">Nâng cao</span>
                                            <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="task-card" onclick="editTask(3, 3)">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800 text-sm">Thực hiện gieo trồng/nhập giống</h4>
                                            <p class="text-xs text-gray-600 mt-1">Gieo trồng hoặc thả giống theo đúng kỹ thuật và mật độ</p>
                                            
                                            <div class="flex flex-wrap mt-2">
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-hands mr-1"></i>Thao tác cẩn thận
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-calendar mr-1"></i>Đúng thời vụ
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="skill-tag text-xs">Nâng cao</span>
                                            <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="add-task-btn" onclick="addTask(3)">
                                    <i class="fas fa-plus mr-2"></i>
                                    <span class="text-sm">Thêm công việc</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recurring Cycle Divider -->
                <div class="cycle-divider">
                    <div class="flex items-center justify-center space-x-4">
                        <i class="fas fa-sync-alt text-2xl text-emerald-600"></i>
                        <div class="text-center">
                            <h3 class="text-lg font-bold text-emerald-800">Chu kỳ Sản xuất</h3>
                            <p class="text-emerald-700 text-sm">Các giai đoạn lặp lại theo chu kỳ</p>
                        </div>
                        <i class="fas fa-sync-alt text-2xl text-emerald-600"></i>
                    </div>
                </div>

                <!-- Production Phases -->
                <div class="card-modern">
                    <div class="p-4 border-b border-gray-100">
                        <h2 class="text-xl font-bold text-emerald-700 flex items-center">
                            <i class="fas fa-sync-alt mr-2"></i>
                            Chu kỳ Sản xuất (Lặp lại)
                        </h2>
                    </div>
                    <div class="p-4 space-y-4" id="recurring-phases">
                        <!-- Phase 4: Growing/Development -->
                        <div class="phase-card recurring-phase" data-phase="4">
                            <div class="cycle-indicator">Lặp lại</div>
                            <div class="phase-header phase-3">
                                <div class="flex items-center flex-1">
                                    <i class="fas fa-chart-line mr-3 text-xl"></i>
                                    <div>
                                        <h3 class="text-base font-bold">Giai đoạn 4: Tăng trưởng và Phát triển</h3>
                                        <p class="text-sm opacity-90">Chăm sóc, nuôi dưỡng trong giai đoạn phát triển</p>
                                    </div>
                                </div>
                                <div class="flex space-x-1">
                                    <button class="text-white hover:text-emerald-200 p-2 text-sm" onclick="editPhase(4)">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="text-white hover:text-red-200 p-2 text-sm" onclick="duplicatePhase(4)">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <button class="text-white hover:text-red-200 p-2 text-sm" onclick="deletePhase(4)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="phase-content">
                                <div class="task-card" onclick="editTask(4, 1)">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800 text-sm">Cung cấp dinh dưỡng định kỳ</h4>
                                            <p class="text-xs text-gray-600 mt-1">Bón phân/cho ăn theo lịch trình và nhu cầu dinh dưỡng</p>
                                            
                                            <div class="flex flex-wrap mt-2">
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-leaf mr-1"></i>Phân hữu cơ/thức ăn
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-calendar mr-1"></i>Theo lịch trình
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-users mr-1"></i>2-3 người
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="skill-tag text-xs">Trung bình</span>
                                            <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="task-card" onclick="editTask(4, 2)">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800 text-sm">Quản lý nước và môi trường</h4>
                                            <p class="text-xs text-gray-600 mt-1">Tưới nước, kiểm soát độ ẩm, nhiệt độ và chất lượng môi trường</p>
                                            
                                            <div class="flex flex-wrap mt-2">
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-tint mr-1"></i>Hệ thống tưới
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-thermometer mr-1"></i>Cảm biến môi trường
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="skill-tag text-xs">Cơ bản</span>
                                            <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="task-card" onclick="editTask(4, 3)">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800 text-sm">Phòng trừ sâu bệnh</h4>
                                            <p class="text-xs text-gray-600 mt-1">Giám sát, phòng ngừa và xử lý sâu bệnh hại theo GAP</p>
                                            
                                            <div class="flex flex-wrap mt-2">
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-bug mr-1"></i>Thuốc sinh học
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-shield-alt mr-1"></i>IPM</span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-users mr-1"></i>2 người
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="skill-tag text-xs">Nâng cao</span>
                                            <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="task-card" onclick="editTask(4, 4)">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800 text-sm">Giám sát tăng trưởng</h4>
                                            <p class="text-xs text-gray-600 mt-1">Đo đạc, theo dõi và ghi nhận chỉ số phát triển</p>
                                            
                                            <div class="flex flex-wrap mt-2">
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-ruler mr-1"></i>Thước đo
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-clipboard mr-1"></i>Nhật ký theo dõi
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="skill-tag text-xs">Trung bình</span>
                                            <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="add-task-btn" onclick="addTask(4)">
                                    <i class="fas fa-plus mr-2"></i>
                                    <span class="text-sm">Thêm công việc</span>
                                </div>
                            </div>
                        </div>

                        <!-- Phase 5: Reproductive/Flowering -->
                        <div class="phase-card recurring-phase" data-phase="5">
                            <div class="cycle-indicator">Lặp lại</div>
                            <div class="phase-header phase-4">
                                <div class="flex items-center flex-1">
                                    <i class="fas fa-flower mr-3 text-xl"></i>
                                    <div>
                                        <h3 class="text-base font-bold">Giai đoạn 5: Sinh sản/Ra hoa</h3>
                                        <p class="text-sm opacity-90">Giai đoạn quan trọng cho sinh sản và ra hoa quả</p>
                                    </div>
                                </div>
                                <div class="flex space-x-1">
                                    <button class="text-white hover:text-blue-200 p-2 text-sm" onclick="editPhase(5)">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="text-white hover:text-red-200 p-2 text-sm" onclick="duplicatePhase(5)">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <button class="text-white hover:text-red-200 p-2 text-sm" onclick="deletePhase(5)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="phase-content">
                                <div class="task-card" onclick="editTask(5, 1)">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800 text-sm">Kích thích ra hoa/phối giống</h4>
                                            <p class="text-xs text-gray-600 mt-1">Áp dụng kỹ thuật kích thích ra hoa hoặc phối giống</p>
                                            
                                            <div class="flex flex-wrap mt-2">
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-magic mr-1"></i>Hormone kích thích
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-dna mr-1"></i>Kỹ thuật phối giống
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="skill-tag text-xs">Chuyên gia</span>
                                            <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="task-card" onclick="editTask(5, 2)">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800 text-sm">Chăm sóc đặc biệt</h4>
                                            <p class="text-xs text-gray-600 mt-1">Điều chỉnh dinh dưỡng và môi trường cho giai đoạn sinh sản</p>
                                            
                                            <div class="flex flex-wrap mt-2">
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-heart mr-1"></i>Chăm sóc đặc biệt
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-thermometer mr-1"></i>Điều khiển môi trường
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="skill-tag text-xs">Nâng cao</span>
                                            <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="task-card" onclick="editTask(5, 3)">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800 text-sm">Hỗ trợ thụ phấn/sinh sản</h4>
                                            <p class="text-xs text-gray-600 mt-1">Thụ phấn nhân tạo hoặc tạo điều kiện sinh sản tự nhiên</p>
                                            
                                            <div class="flex flex-wrap mt-2">
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-hand mr-1"></i>Thụ phấn nhân tạo
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-bee mr-1"></i>Ong thụ phấn
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="skill-tag text-xs">Chuyên gia</span>
                                            <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="add-task-btn" onclick="addTask(5)">
                                    <i class="fas fa-plus mr-2"></i>
                                    <span class="text-sm">Thêm công việc</span>
                                </div>
                            </div>
                        </div>

                        <!-- Phase 6: Fruit/Product Development -->
                        <div class="phase-card recurring-phase" data-phase="6">
                            <div class="cycle-indicator">Lặp lại</div>
                            <div class="phase-header phase-5">
                                <div class="flex items-center flex-1">
                                    <i class="fas fa-apple-alt mr-3 text-xl"></i>
                                    <div>
                                        <h3 class="text-base font-bold">Giai đoạn 6: Phát triển Sản phẩm</h3>
                                        <p class="text-sm opacity-90">Nuôi dưỡng và phát triển sản phẩm đến khi thu hoạch</p>
                                    </div>
                                </div>
                                <div class="flex space-x-1">
                                    <button class="text-white hover:text-purple-200 p-2 text-sm" onclick="editPhase(6)">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="text-white hover:text-red-200 p-2 text-sm" onclick="duplicatePhase(6)">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <button class="text-white hover:text-red-200 p-2 text-sm" onclick="deletePhase(6)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="phase-content">
                                <div class="task-card" onclick="editTask(6, 1)">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800 text-sm">Tỉa quả/Chọn lọc sản phẩm</h4>
                                            <p class="text-xs text-gray-600 mt-1">Loại bỏ sản phẩm kém chất lượng, giữ lại sản phẩm tốt nhất</p>
                                            
                                            <div class="flex flex-wrap mt-2">
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-cut mr-1"></i>Dụng cụ tỉa
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-star mr-1"></i>Tiêu chí chất lượng
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="skill-tag text-xs">Nâng cao</span>
                                            <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="task-card" onclick="editTask(6, 2)">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800 text-sm">Bón phân nuôi quả/sản phẩm</h4>
                                            <p class="text-xs text-gray-600 mt-1">Cung cấp dinh dưỡng đặc biệt cho giai đoạn phát triển sản phẩm</p>
                                            
                                            <div class="flex flex-wrap mt-2">
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-flask mr-1"></i>Phân chuyên dụng
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-balance-scale mr-1"></i>Liều lượng chính xác
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="skill-tag text-xs">Trung bình</span>
                                            <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="task-card" onclick="editTask(6, 3)">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800 text-sm">Bảo vệ sản phẩm</h4>
                                            <p class="text-xs text-gray-600 mt-1">Bao bọc, che chắn để bảo vệ sản phẩm khỏi tác động xấu</p>
                                            
                                            <div class="flex flex-wrap mt-2">
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-shield-alt mr-1"></i>Vật liệu bảo vệ
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-umbrella mr-1"></i>Che chắn
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="skill-tag text-xs">Trung bình</span>
                                            <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="task-card" onclick="editTask(6, 4)">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800 text-sm">Theo dõi độ chín/phẩm chất</h4>
                                            <p class="text-xs text-gray-600 mt-1">Kiểm tra định kỳ để xác định thời điểm thu hoạch tối ưu</p>
                                            
                                            <div class="flex flex-wrap mt-2">
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-search mr-1"></i>Kiểm tra chất lượng
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-calendar-check mr-1"></i>Lịch thu hoạch
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="skill-tag text-xs">Nâng cao</span>
                                            <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="add-task-btn" onclick="addTask(6)">
                                    <i class="fas fa-plus mr-2"></i>
                                    <span class="text-sm">Thêm công việc</span>
                                </div>
                            </div>
                        </div>

                        <!-- Phase 7: Harvest & Processing -->
                        <div class="phase-card recurring-phase" data-phase="7">
                            <div class="cycle-indicator">Lặp lại</div>
                            <div class="phase-header phase-6">
                                <div class="flex items-center flex-1">
                                    <i class="fas fa-warehouse mr-3 text-xl"></i>
                                    <div>
                                        <h3 class="text-base font-bold">Giai đoạn 7: Thu hoạch và Chế biến</h3>
                                        <p class="text-sm opacity-90">Thu hoạch đúng thời điểm và xử lý sơ bộ</p>
                                    </div>
                                </div>
                                <div class="flex space-x-1">
                                    <button class="text-white hover:text-orange-200 p-2 text-sm" onclick="editPhase(7)">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="text-white hover:text-red-200 p-2 text-sm" onclick="duplicatePhase(7)">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <button class="text-white hover:text-red-200 p-2 text-sm" onclick="deletePhase(7)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="phase-content">
                                <div class="task-card" onclick="editTask(7, 1)">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800 text-sm">Thu hoạch đúng kỹ thuật</h4>
                                            <p class="text-xs text-gray-600 mt-1">Thực hiện thu hoạch đúng thời điểm và phương pháp để đảm bảo chất lượng</p>
                                            
                                            <div class="flex flex-wrap mt-2">
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-tools mr-1"></i>Dụng cụ thu hoạch
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-clock mr-1"></i>Đúng thời điểm
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-users mr-1"></i>4-6 người
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="skill-tag text-xs">Nâng cao</span>
                                            <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="task-card" onclick="editTask(7, 2)">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800 text-sm">Phân loại và đóng gói</h4>
                                            <p class="text-xs text-gray-600 mt-1">Phân loại theo tiêu chuẩn chất lượng và đóng gói phù hợp</p>
                                            
                                            <div class="flex flex-wrap mt-2">
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-sort mr-1"></i>Tiêu chuẩn phân loại
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-box mr-1"></i>Vật liệu đóng gói
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="skill-tag text-xs">Trung bình</span>
                                            <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="task-card" onclick="editTask(7, 3)">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800 text-sm">Bảo quản và vận chuyển</h4>
                                            <p class="text-xs text-gray-600 mt-1">Bảo quản đúng cách và chuẩn bị vận chuyển đến thị trường</p>
                                            
                                            <div class="flex flex-wrap mt-2">
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-snowflake mr-1"></i>Kho lạnh
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-truck mr-1"></i>Vận chuyển
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="skill-tag text-xs">Chuyên gia</span>
                                            <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="add-task-btn" onclick="addTask(7)">
                                    <i class="fas fa-plus mr-2"></i>
                                    <span class="text-sm">Thêm công việc</span>
                                </div>
                            </div>
                        </div>

                        <!-- Phase 8: Cleanup & Preparation -->
                        <div class="phase-card recurring-phase" data-phase="8">
                            <div class="cycle-indicator">Lặp lại</div>
                            <div class="phase-header phase-7">
                                <div class="flex items-center flex-1">
                                    <i class="fas fa-broom mr-3 text-xl"></i>
                                    <div>
                                        <h3 class="text-base font-bold">Giai đoạn 8: Dọn dẹp và Chuẩn bị chu kỳ mới</h3>
                                        <p class="text-sm opacity-90">Vệ sinh, đánh giá và chuẩn bị cho chu kỳ tiếp theo</p>
                                    </div>
                                </div>
                                <div class="flex space-x-1">
                                    <button class="text-white hover:text-red-200 p-2 text-sm" onclick="editPhase(8)">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="text-white hover:text-red-200 p-2 text-sm" onclick="duplicatePhase(8)">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <button class="text-white hover:text-red-200 p-2 text-sm" onclick="deletePhase(8)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="phase-content">
                                <div class="task-card" onclick="editTask(8, 1)">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800 text-sm">Vệ sinh và khử trùng</h4>
                                            <p class="text-xs text-gray-600 mt-1">Làm sạch toàn bộ khu vực sản xuất và khử trùng triệt để</p>
                                            
                                            <div class="flex flex-wrap mt-2">
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-spray-can mr-1"></i>Chất khử trùng
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-broom mr-1"></i>Dụng cụ vệ sinh
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-users mr-1"></i>3-4 người
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="skill-tag text-xs">Cơ bản</span>
                                            <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="task-card" onclick="editTask(8, 2)">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800 text-sm">Đánh giá hiệu quả chu kỳ</h4>
                                            <p class="text-xs text-gray-600 mt-1">Phân tích năng suất, chất lượng và hiệu quả kinh tế của chu kỳ vừa qua</p>
                                            
                                            <div class="flex flex-wrap mt-2">
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-chart-bar mr-1"></i>Báo cáo phân tích
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-calculator mr-1"></i>Tính toán hiệu quả
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="skill-tag text-xs">Chuyên gia</span>
                                            <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="task-card" onclick="editTask(8, 3)">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800 text-sm">Bảo trì thiết bị và hệ thống</h4>
                                            <p class="text-xs text-gray-600 mt-1">Kiểm tra, bảo trì và sửa chữa các thiết bị, hệ thống</p>
                                            
                                            <div class="flex flex-wrap mt-2">
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-wrench mr-1"></i>Công cụ sửa chữa
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-cog mr-1"></i>Phụ tụng thay thế
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="skill-tag text-xs">Nâng cao</span>
                                            <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="task-card" onclick="editTask(8, 4)">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-gray-800 text-sm">Lập kế hoạch chu kỳ tiếp theo</h4>
                                            <p class="text-xs text-gray-600 mt-1">Rút kinh nghiệm và lập kế hoạch cải tiến cho chu kỳ sản xuất tiếp theo</p>
                                            
                                            <div class="flex flex-wrap mt-2">
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-clipboard mr-1"></i>Kế hoạch cải tiến
                                                </span>
                                                <span class="resource-tag text-xs">
                                                    <i class="fas fa-lightbulb mr-1"></i>Ý tưởng mới
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="skill-tag text-xs">Nâng cao</span>
                                            <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="add-task-btn" onclick="addTask(8)">
                                    <i class="fas fa-plus mr-2"></i>
                                    <span class="text-sm">Thêm công việc</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add New Phase -->
                <div class="card-modern">
                    <div class="p-6 text-center">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button class="btn-primary" onclick="addNewPhase('setup')">
                                <i class="fas fa-plus mr-2"></i>Thêm Giai đoạn Thiết lập
                            </button>
                            <button class="btn-primary" onclick="addNewPhase('recurring')">
                                <i class="fas fa-sync-alt mr-2"></i>Thêm Giai đoạn Lặp lại
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="lg:col-span-1">
                <div class="sidebar-info space-y-4">
                    <!-- Process Progress -->
                    <div class="card-modern">
                        <div class="p-4">
                            <h3 class="font-bold text-gray-800 mb-3 text-sm">Tiến độ Quy trình</h3>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 85%"></div>
                            </div>
                            <p class="text-xs text-gray-600 mt-2">85% hoàn thành</p>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="stat-card">
                        <h3 class="font-bold text-gray-800 mb-3 text-sm">Thống kê</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600 text-xs">Tổng giai đoạn:</span>
                                <span class="font-bold text-emerald-600" id="total-phases">8</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600 text-xs">Thiết lập:</span>
                                <span class="font-bold text-indigo-600" id="setup-phases-count">3</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600 text-xs">Lặp lại:</span>
                                <span class="font-bold text-emerald-600" id="recurring-phases-count">5</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600 text-xs">Tổng công việc:</span>
                                <span class="font-bold text-blue-600" id="task-count">32</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Tools -->
                    <div class="card-modern">
                        <div class="p-4">
                            <h3 class="font-bold text-gray-800 mb-3 text-sm">Công cụ nhanh</h3>
                            <div class="space-y-2">
                                <button class="w-full btn-secondary text-xs" onclick="autoGeneratePhases()">
                                    <i class="fas fa-magic mr-2"></i>Tự động tạo giai đoạn
                                </button>
                                <button class="w-full btn-secondary text-xs" onclick="validateProcess()">
                                    <i class="fas fa-check-double mr-2"></i>Kiểm tra quy trình
                                </button>
                                <button class="w-full btn-secondary text-xs" onclick="previewProcess()">
                                    <i class="fas fa-eye mr-2"></i>Xem trước
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Template Library -->
                    <div class="card-modern">
                        <div class="p-4">
                            <h3 class="font-bold text-gray-800 mb-3 text-sm">Thư viện Template</h3>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between p-2 bg-gray-50 rounded text-xs hover:bg-gray-100 cursor-pointer" onclick="loadTemplate('durian-dona')">
                                    <span><i class="fas fa-leaf mr-1 text-green-600"></i>Sầu riêng Dona</span>
                                    <i class="fas fa-download text-emerald-600"></i>
                                </div>
                                <div class="flex items-center justify-between p-2 bg-gray-50 rounded text-xs hover:bg-gray-100 cursor-pointer" onclick="loadTemplate('coffee-arabica')">
                                    <span><i class="fas fa-coffee mr-1 text-brown-600"></i>Cà phê Arabica</span>
                                    <i class="fas fa-download text-emerald-600"></i>
                                </div>
                                <div class="flex items-center justify-between p-2 bg-gray-50 rounded text-xs hover:bg-gray-100 cursor-pointer" onclick="loadTemplate('rice-organic')">
                                    <span><i class="fas fa-seedling mr-1 text-yellow-600"></i>Lúa hữu cơ</span>
                                    <i class="fas fa-download text-emerald-600"></i>
                                </div>
                                <div class="flex items-center justify-between p-2 bg-gray-50 rounded text-xs hover:bg-gray-100 cursor-pointer" onclick="loadTemplate('pig-breeding')">
                                    <span><i class="fas fa-pig mr-1 text-pink-600"></i>Chăn nuôi heo</span>
                                    <i class="fas fa-download text-emerald-600"></i>
                                </div>
                                <div class="flex items-center justify-between p-2 bg-gray-50 rounded text-xs hover:bg-gray-100 cursor-pointer" onclick="loadTemplate('shrimp-farming')">
                                    <span><i class="fas fa-fish mr-1 text-blue-600"></i>Nuôi tôm</span>
                                    <i class="fas fa-download text-emerald-600"></i>
                                </div>
                                <div class="flex items-center justify-between p-2 bg-gray-50 rounded text-xs hover:bg-gray-100 cursor-pointer" onclick="loadTemplate('chicken-broiler')">
                                    <span><i class="fas fa-egg mr-1 text-orange-600"></i>Gà thịt</span>
                                    <i class="fas fa-download text-emerald-600"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Standards Info -->
                    <div class="card-modern">
                        <div class="p-4">
                            <h3 class="font-bold text-gray-800 mb-3 text-sm">Tiêu chuẩn áp dụng</h3>
                            <div class="space-y-2">
                                <div class="bg-green-50 border border-green-200 rounded-lg p-2">
                                    <div class="flex items-center space-x-2">
                                        <i class="fas fa-certificate text-green-600 text-xs"></i>
                                        <span class="font-medium text-green-800 text-xs">GAP - Thực hành Nông nghiệp Tốt</span>
                                    </div>
                                </div>
                                
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-2">
                                    <div class="flex items-center space-x-2">
                                        <i class="fas fa-globe text-blue-600 text-xs"></i>
                                        <span class="font-medium text-blue-800 text-xs">Tiêu chuẩn Xuất khẩu</span>
                                    </div>
                                </div>
                                
                                <div class="bg-purple-50 border border-purple-200 rounded-lg p-2">
                                    <div class="flex items-center space-x-2">
                                        <i class="fas fa-leaf text-purple-600 text-xs"></i>
                                        <span class="font-medium text-purple-800 text-xs">Sản xuất Bền vững</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions FAB -->
    <div class="quick-actions">
        <button class="fab" onclick="saveQuick()" title="Lưu nhanh">
            <i class="fas fa-save"></i>
        </button>
        <button class="fab" onclick="addNewPhase('recurring')" title="Thêm giai đoạn">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- Task Detail Modal -->
    <div class="modal-overlay" id="task-modal" style="display: none;">
        <div class="modal-content">
            <!-- Modal Header with Tabs -->
            <div class="form-section">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800">Chi tiết Công việc</h3>
                    <button class="text-gray-400 hover:text-gray-600" onclick="closeTaskModal()">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
                
                <!-- Tab Navigation -->
                <div class="flex border-b border-gray-200 mb-4">
                    <button class="tab-btn active" onclick="switchTab('basic')" data-tab="basic">
                        <i class="fas fa-info-circle mr-1"></i>Cơ bản
                    </button>
                    <button class="tab-btn" onclick="switchTab('schedule')" data-tab="schedule">
                        <i class="fas fa-calendar mr-1"></i>Lịch trình
                    </button>
                    <button class="tab-btn" onclick="switchTab('resources')" data-tab="resources">
                        <i class="fas fa-boxes mr-1"></i>Tài nguyên
                    </button>
                    <button class="tab-btn" onclick="switchTab('quality')" data-tab="quality">
                        <i class="fas fa-medal mr-1"></i>Chất lượng
                    </button>
                    <button class="tab-btn" onclick="switchTab('finance')" data-tab="finance">
                        <i class="fas fa-dollar-sign mr-1"></i>Chi phí
                    </button>
                    <button class="tab-btn" onclick="switchTab('advanced')" data-tab="advanced">
                        <i class="fas fa-cogs mr-1"></i>Nâng cao
                    </button>
                </div>
            </div>

            <!-- Tab Content -->
            <div class="tab-content active" id="basic-tab">
                <!-- Basic Information -->
                <div class="form-section">
                    <h4 class="font-semibold text-gray-700 mb-3 text-sm">Thông tin cơ bản</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Tên công việc *</label>
                            <input type="text" class="form-input text-sm" id="task-name" placeholder="VD: Bón phân NPK cho cây sầu riêng">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Mã công việc</label>
                            <input type="text" class="form-input text-sm" id="task-code" placeholder="VD: CR-001">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Loại công việc *</label>
                            <select class="form-input text-sm" id="task-type" onchange="updateTaskType()">
                                <option value="">Chọn loại</option>
                                <optgroup label="Cây trồng">
                                    <option value="soil-prep">Chuẩn bị đất</option>
                                    <option value="planting">Gieo trồng</option>
                                    <option value="fertilizing">Bón phân</option>
                                    <option value="watering">Tưới nước</option>
                                    <option value="pest-control">Phòng trừ sâu bệnh</option>
                                    <option value="pruning">Tỉa cành/trái</option>
                                    <option value="harvesting">Thu hoạch</option>
                                </optgroup>
                                <optgroup label="Chăn nuôi">
                                    <option value="feeding">Cho ăn</option>
                                    <option value="breeding">Phối giống</option>
                                    <option value="vaccination">Tiêm phòng</option>
                                    <option value="cleaning">Vệ sinh chuồng</option>
                                    <option value="health-check">Kiểm tra sức khỏe</option>
                                </optgroup>
                                <optgroup label="Thủy sản">
                                    <option value="water-quality">Kiểm soát nước</option>
                                    <option value="pond-prep">Chuẩn bị ao</option>
                                    <option value="stocking">Thả giống</option>
                                    <option value="fish-feeding">Cho cá ăn</option>
                                </optgroup>
                                <optgroup label="Chung">
                                    <option value="monitoring">Giám sát</option>
                                    <option value="maintenance">Bảo trì</option>
                                    <option value="documentation">Ghi chép</option>
                                    <option value="quality-control">Kiểm soát chất lượng</option>
                                    <option value="other">Khác</option>
                                </optgroup>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Mức độ ưu tiên</label>
                            <select class="form-input text-sm" id="task-priority">
                                <option value="low">Thấp</option>
                                <option value="medium" selected>Trung bình</option>
                                <option value="high">Cao</option>
                                <option value="critical">Cấp bách</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Trạng thái</label>
                            <select class="form-input text-sm" id="task-status">
                                <option value="planned">Đã lập kế hoạch</option>
                                <option value="ready">Sẵn sàng thực hiện</option>
                                <option value="in-progress">Đang thực hiện</option>
                                <option value="completed">Hoàn thành</option>
                                <option value="delayed">Trì hoãn</option>
                                <option value="cancelled">Hủy bỏ</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <label class="block text-xs font-medium text-gray-700 mb-1">Mô tả chi tiết *</label>
                        <textarea class="form-input text-sm" id="task-description" rows="3" 
                                placeholder="Mô tả chi tiết cách thực hiện công việc, mục tiêu cần đạt được..."></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Vị trí thực hiện</label>
                            <input type="text" class="form-input text-sm" id="task-location" placeholder="VD: Khu vực A, Lô 1-5">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Diện tích/Số lượng</label>
                            <div class="flex items-center space-x-2">
                                <input type="number" class="form-input text-sm flex-1" id="task-quantity" placeholder="100">
                                <select class="form-input text-sm w-20" id="task-unit">
                                    <option value="ha">ha</option>
                                    <option value="m2">m²</option>
                                    <option value="cây">cây</option>
                                    <option value="con">con</option>
                                    <option value="ao">ao</option>
                                    <option value="chuồng">chuồng</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dependencies -->
                <div class="form-section">
                    <h4 class="font-semibold text-gray-700 mb-3 text-sm">Phụ thuộc và Liên kết</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Công việc tiền điều kiện</label>
                            <select class="form-input text-sm" id="task-dependencies" multiple>
                                <option value="prev-1">Chuẩn bị đất</option>
                                <option value="prev-2">Kiểm tra hệ thống tưới</option>
                                <option value="prev-3">Mua vật tư</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Các công việc phải hoàn thành trước</p>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Công việc tiếp theo</label>
                            <select class="form-input text-sm" id="task-successors" multiple>
                                <option value="next-1">Tưới nước</option>
                                <option value="next-2">Theo dõi phát triển</option>
                                <option value="next-3">Ghi nhận kết quả</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Các công việc sẽ thực hiện sau</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Schedule Tab -->
            <div class="tab-content" id="schedule-tab">
                <div class="form-section">
                    <h4 class="font-semibold text-gray-700 mb-3 text-sm">Lập lịch thực hiện</h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Ngày bắt đầu dự kiến *</label>
                            <input type="date" class="form-input text-sm" id="task-start-date">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Ngày kết thúc dự kiến</label>
                            <input type="date" class="form-input text-sm" id="task-end-date">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Thời lượng (giờ)</label>
                            <input type="number" class="form-input text-sm" id="task-duration-hours" placeholder="8" step="0.5">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Tần suất thực hiện</label>
                            <select class="form-input text-sm" id="task-frequency" onchange="toggleFrequencyDetails()">
                                <option value="once">Một lần</option>
                                <option value="daily">Hàng ngày</option>
                                <option value="weekly">Hàng tuần</option>
                                <option value="monthly">Hàng tháng</option>
                                <option value="seasonal">Theo mùa</option>
                                <option value="custom">Tùy chỉnh</option>
                            </select>
                        </div>
                        <div id="frequency-details" style="display: none;">
                            <label class="block text-xs font-medium text-gray-700 mb-1">Chi tiết tần suất</label>
                            <input type="text" class="form-input text-sm" id="task-frequency-detail" placeholder="VD: Mỗi 3 ngày, vào sáng sớm">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Thời gian tốt nhất trong ngày</label>
                            <select class="form-input text-sm" id="task-best-time">
                                <option value="">Không yêu cầu</option>
                                <option value="early-morning">Sáng sớm (5-7h)</option>
                                <option value="morning">Buổi sáng (7-11h)</option>
                                <option value="noon">Giữa trưa (11-13h)</option>
                                <option value="afternoon">Chiều (13-17h)</option>
                                <option value="evening">Tối (17-19h)</option>
                                <option value="night">Ban đêm (19-22h)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Điều kiện thời tiết</label>
                            <select class="form-input text-sm" id="task-weather">
                                <option value="">Không yêu cầu</option>
                                <option value="sunny">Nắng</option>
                                <option value="cloudy">Nhiều mây</option>
                                <option value="no-rain">Không mưa</option>
                                <option value="after-rain">Sau mưa</option>
                                <option value="humid">Độ ẩm cao</option>
                                <option value="dry">Khô ráo</option>
                            </select>
                        </div>
                    </div>

                    <div class="mt-3">
                        <label class="block text-xs font-medium text-gray-700 mb-1">Ghi chú về thời gian</label>
                        <textarea class="form-input text-sm" rows="2" id="task-timing-notes" 
                                placeholder="VD: Không thực hiện trong mùa mưa, tránh thời gian nắng gắt..."></textarea>
                    </div>
                </div>

                <!-- Alerts and Reminders -->
                <div class="form-section">
                    <h4 class="font-semibold text-gray-700 mb-3 text-sm">Nhắc nhở và Cảnh báo</h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="w-4 h-4 text-emerald-600" id="enable-reminders">
                                <span class="text-sm">Kích hoạt nhắc nhở</span>
                            </label>
                            <div class="ml-6 mt-2 space-y-2" id="reminder-settings">
                                <div class="flex items-center space-x-2">
                                    <input type="number" class="form-input text-sm w-16" value="1" min="1">
                                    <select class="form-input text-sm w-20">
                                        <option value="days">ngày</option>
                                        <option value="hours">giờ</option>
                                    </select>
                                    <span class="text-sm text-gray-600">trước khi bắt đầu</span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Người nhận nhắc nhở</label>
                            <select class="form-input text-sm" id="reminder-recipients" multiple>
                                <option value="manager">Quản lý</option>
                                <option value="technician">Kỹ thuật viên</option>
                                <option value="worker">Công nhân</option>
                                <option value="owner">Chủ trang trại</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resources Tab -->
            <div class="tab-content" id="resources-tab">
                <!-- Materials and Supplies -->
                <div class="form-section">
                    <h4 class="font-semibold text-gray-700 mb-3 text-sm">Vật tư và Nguyên liệu</h4>
                    
                    <div id="materials-list" class="space-y-2">
                        <div class="material-item bg-gray-50 rounded p-3">
                            <div class="grid grid-cols-1 md:grid-cols-5 gap-2 items-center">
                                <input type="text" class="form-input text-sm" placeholder="Tên vật tư">
                                <input type="number" class="form-input text-sm" placeholder="Số lượng" step="0.1">
                                <select class="form-input text-sm">
                                    <option value="kg">kg</option>
                                    <option value="lit">lít</option>
                                    <option value="cai">cái</option>
                                    <option value="goi">gói</option>
                                    <option value="thung">thùng</option>
                                    <option value="tan">tấn</option>
                                </select>
                                <input type="number" class="form-input text-sm" placeholder="Đơn giá" step="1000">
                                <button class="btn-secondary text-xs" onclick="removeMaterial(this)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="mt-2">
                                <input type="text" class="form-input text-sm" placeholder="Nhà cung cấp (tùy chọn)">
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn-secondary mt-2 text-sm" onclick="addMaterial()">
                        <i class="fas fa-plus mr-2"></i>Thêm vật tư
                    </button>
                </div>

                <!-- Equipment and Tools -->
                <div class="form-section">
                    <h4 class="font-semibold text-gray-700 mb-3 text-sm">Thiết bị và Công cụ</h4>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2" id="equipment-list">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="w-4 h-4 text-emerald-600" value="hose">
                            <span class="text-sm">Ống nước</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="w-4 h-4 text-emerald-600" value="sprayer">
                            <span class="text-sm">Máy phun</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="w-4 h-4 text-emerald-600" value="tractor">
                            <span class="text-sm">Máy cày</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="w-4 h-4 text-emerald-600" value="ladder">
                            <span class="text-sm">Thang</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="w-4 h-4 text-emerald-600" value="scissors">
                            <span class="text-sm">Kéo tỉa</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="w-4 h-4 text-emerald-600" value="scale">
                            <span class="text-sm">Cân</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="w-4 h-4 text-emerald-600" value="thermometer">
                            <span class="text-sm">Nhiệt kế</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="w-4 h-4 text-emerald-600" value="ph-meter">
                            <span class="text-sm">Máy đo pH</span>
                        </label>
                    </div>
                    
                    <div class="mt-3">
                        <label class="block text-xs font-medium text-gray-700 mb-1">Thiết bị đặc biệt khác</label>
                        <input type="text" class="form-input text-sm" id="special-equipment" 
                               placeholder="VD: Máy đo độ ngọt, thiết bị GPS...">
                    </div>
                </div>

                <!-- Human Resources -->
                <div class="form-section">
                    <h4 class="font-semibold text-gray-700 mb-3 text-sm">Nhân lực</h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Tổng số người cần *</label>
                            <input type="number" class="form-input text-sm" id="task-workers" placeholder="2" min="1">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Kỹ năng yêu cầu</label>
                            <select class="form-input text-sm" id="task-skill">
                                <option value="basic">Cơ bản</option>
                                <option value="intermediate">Trung bình</option>
                                <option value="advanced">Nâng cao</option>
                                <option value="expert">Chuyên gia</option>
                                <option value="certified">Có chứng chỉ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Kinh nghiệm tối thiểu</label>
                            <select class="form-input text-sm" id="task-experience">
                                <option value="none">Không yêu cầu</option>
                                <option value="6m">6 tháng</option>
                                <option value="1y">1 năm</option>
                                <option value="2y">2 năm</option>
                                <option value="5y">5+ năm</option>
                            </select>
                        </div>
                    </div>

                    <div class="mt-3">
                        <label class="block text-xs font-medium text-gray-700 mb-1">Phân công chi tiết</label>
                        <div id="role-assignments" class="space-y-2">
                            <div class="flex items-center space-x-2">
                                <select class="form-input text-sm w-32">
                                    <option value="leader">Tổ trưởng</option>
                                    <option value="technician">Kỹ thuật viên</option>
                                    <option value="worker">Công nhân</option>
                                    <option value="operator">Thao tác viên</option>
                                </select>
                                <input type="number" class="form-input text-sm w-16" placeholder="1" min="1">
                                <span class="text-sm text-gray-600">người</span>
                                <input type="text" class="form-input text-sm flex-1" placeholder="Mô tả nhiệm vụ cụ thể">
                                <button class="btn-secondary text-xs" onclick="removeRole(this)">
                                    <i class="fas fa-minus"></i>
                                </button>
                            </div>
                        </div>
                        <button class="btn-secondary mt-2 text-sm" onclick="addRole()">
                            <i class="fas fa-plus mr-2"></i>Thêm vai trò
                        </button>
                    </div>
                </div>
            </div>

            <!-- Quality Tab -->
            <div class="tab-content" id="quality-tab">
                <!-- Quality Standards -->
                <div class="form-section">
                    <h4 class="font-semibold text-gray-700 mb-3 text-sm">Tiêu chuẩn Chất lượng</h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Tiêu chuẩn áp dụng</label>
                            <div class="space-y-2">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" class="w-4 h-4 text-emerald-600" checked>
                                    <span class="text-sm">VietGAP</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" class="w-4 h-4 text-emerald-600">
                                    <span class="text-sm">GlobalGAP</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" class="w-4 h-4 text-emerald-600">
                                    <span class="text-sm">Organic</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" class="w-4 h-4 text-emerald-600">
                                    <span class="text-sm">HACCP</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" class="w-4 h-4 text-emerald-600">
                                    <span class="text-sm">ISO 22000</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Chỉ số chất lượng cần đạt</label>
                            <div class="space-y-2">
                                <div class="flex items-center space-x-2">
                                    <input type="text" class="form-input text-sm w-24" placeholder="pH">
                                    <input type="number" class="form-input text-sm w-20" placeholder="6.5" step="0.1">
                                    <span class="text-sm text-gray-600">±</span>
                                    <input type="number" class="form-input text-sm w-16" placeholder="0.5" step="0.1">
                                </div>
                                <div class="flex items-center space-x-2">
                                    <input type="text" class="form-input text-sm w-24" placeholder="Độ ẩm">
                                    <input type="number" class="form-input text-sm w-20" placeholder="70" step="1">
                                    <span class="text-sm text-gray-600">%</span>
                                </div>
                            </div>
                            <button class="btn-secondary mt-2 text-xs" onclick="addQualityMetric()">
                                <i class="fas fa-plus mr-1"></i>Thêm chỉ số
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Documentation Requirements -->
                <div class="form-section">
                    <h4 class="font-semibold text-gray-700 mb-3 text-sm">Yêu cầu Ghi chép</h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Loại ghi chép bắt buộc</label>
                            <div class="space-y-2">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" class="w-4 h-4 text-emerald-600" checked>
                                    <span class="text-sm">Nhật ký công việc</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" class="w-4 h-4 text-emerald-600">
                                    <span class="text-sm">Chứng từ vật tư</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" class="w-4 h-4 text-emerald-600">
                                    <span class="text-sm">Ảnh minh chứng</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" class="w-4 h-4 text-emerald-600">
                                    <span class="text-sm">Video quy trình</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" class="w-4 h-4 text-emerald-600">
                                    <span class="text-sm">Chữ ký người thực hiện</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Template ghi chép</label>
                            <select class="form-input text-sm" id="documentation-template">
                                <option value="">Chọn template</option>
                                <option value="standard">Template chuẩn</option>
                                <option value="gap">Template GAP</option>
                                <option value="organic">Template hữu cơ</option>
                                <option value="custom">Tùy chỉnh</option>
                            </select>
                            
                            <div class="mt-2">
                                <label class="block text-xs font-medium text-gray-700 mb-1">Người phê duyệt</label>
                                <select class="form-input text-sm" id="approver">
                                    <option value="">Không cần phê duyệt</option>
                                    <option value="supervisor">Giám sát viên</option>
                                    <option value="manager">Quản lý</option>
                                    <option value="expert">Chuyên gia</option>
                                    <option value="owner">Chủ trang trại</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Success Criteria -->
                <div class="form-section">
                    <h4 class="font-semibold text-gray-700 mb-3 text-sm">Tiêu chí Hoàn thành</h4>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Tiêu chí thành công *</label>
                            <textarea class="form-input text-sm" rows="2" id="success-criteria" 
                                    placeholder="VD: 100% diện tích được bón phân đều, không có khu vực bị bỏ sót, đất ẩm 70-80%..."></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Tiêu chí không đạt (cần làm lại)</label>
                            <textarea class="form-input text-sm" rows="2" id="failure-criteria" 
                                    placeholder="VD: Còn > 10% diện tích chưa được xử lý, độ ẩm < 50%..."></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Phương pháp kiểm tra</label>
                            <select class="form-input text-sm" id="inspection-method">
                                <option value="visual">Quan sát trực tiếp</option>
                                <option value="measurement">Đo lường</option>
                                <option value="sampling">Lấy mẫu kiểm tra</option>
                                <option value="testing">Xét nghiệm</option>
                                <option value="photo">Chụp ảnh minh chứng</option>
                                <option value="checklist">Sử dụng checklist</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Finance Tab -->
            <div class="tab-content" id="finance-tab">
                <!-- Cost Estimation -->
                <div class="form-section">
                    <h4 class="font-semibold text-gray-700 mb-3 text-sm">Ước tính Chi phí</h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Chi phí vật tư (VNĐ)</label>
                                <input type="number" class="form-input text-sm" id="material-cost" placeholder="500000" step="1000">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Chi phí nhân công (VNĐ)</label>
                                <input type="number" class="form-input text-sm" id="labor-cost" placeholder="300000" step="1000">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Chi phí thiết bị (VNĐ)</label>
                                <input type="number" class="form-input text-sm" id="equipment-cost" placeholder="100000" step="1000">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Chi phí khác (VNĐ)</label>
                                <input type="number" class="form-input text-sm" id="other-cost" placeholder="50000" step="1000">
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded p-3">
                            <h5 class="font-semibold text-sm mb-2">Tổng kết chi phí</h5>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span>Vật tư:</span>
                                    <span id="material-cost-display">0 ₫</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Nhân công:</span>
                                    <span id="labor-cost-display">0 ₫</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Thiết bị:</span>
                                    <span id="equipment-cost-display">0 ₫</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Khác:</span>
                                    <span id="other-cost-display">0 ₫</span>
                                </div>
                                <hr>
                                <div class="flex justify-between font-semibold">
                                    <span>Tổng cộng:</span>
                                    <span id="total-cost-display">0 ₫</span>
                                </div>
                                <div class="flex justify-between text-gray-600">
                                    <span>Chi phí/đơn vị:</span>
                                    <span id="unit-cost-display">0 ₫</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Budget Control -->
                <div class="form-section">
                    <h4 class="font-semibold text-gray-700 mb-3 text-sm">Kiểm soát Ngân sách</h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Ngân sách cấp phát</label>
                            <input type="number" class="form-input text-sm" id="allocated-budget" placeholder="1000000" step="1000">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Mức cảnh báo (%)</label>
                            <input type="number" class="form-input text-sm" id="budget-warning" placeholder="80" min="50" max="100">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Người phê duyệt chi</label>
                            <select class="form-input text-sm" id="budget-approver">
                                <option value="">Không cần phê duyệt</option>
                                <option value="supervisor">Giám sát viên</option>
                                <option value="manager">Quản lý tài chính</option>
                                <option value="owner">Chủ trang trại</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="w-4 h-4 text-emerald-600" id="track-actual-cost">
                            <span class="text-sm">Theo dõi chi phí thực tế</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Advanced Tab -->
            <div class="tab-content" id="advanced-tab">
                <!-- Risk Management -->
                <div class="form-section">
                    <h4 class="font-semibold text-gray-700 mb-3 text-sm">Quản lý Rủi ro</h4>
                    
                    <div id="risk-list" class="space-y-2">
                        <div class="risk-item bg-yellow-50 border border-yellow-200 rounded p-3">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                                <input type="text" class="form-input text-sm" placeholder="Rủi ro (VD: Mưa to)">
                                <select class="form-input text-sm">
                                    <option value="low">Thấp</option>
                                    <option value="medium">Trung bình</option>
                                    <option value="high">Cao</option>
                                </select>
                                <button class="btn-secondary text-xs" onclick="removeRisk(this)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <input type="text" class="form-input text-sm mt-2" placeholder="Biện pháp phòng ngừa">
                        </div>
                    </div>
                    
                    <button class="btn-secondary mt-2 text-sm" onclick="addRisk()">
                        <i class="fas fa-plus mr-2"></i>Thêm rủi ro
                    </button>
                </div>

                <!-- Environmental Conditions -->
                <div class="form-section">
                    <h4 class="font-semibold text-gray-700 mb-3 text-sm">Điều kiện Môi trường</h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Nhiệt độ tối ưu (°C)</label>
                            <div class="flex items-center space-x-2">
                                <input type="number" class="form-input text-sm w-20" placeholder="25" step="0.5">
                                <span class="text-sm text-gray-600">đến</span>
                                <input type="number" class="form-input text-sm w-20" placeholder="30" step="0.5">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Độ ẩm tối ưu (%)</label>
                            <div class="flex items-center space-x-2">
                                <input type="number" class="form-input text-sm w-20" placeholder="60" step="5">
                                <span class="text-sm text-gray-600">đến</span>
                                <input type="number" class="form-input text-sm w-20" placeholder="80" step="5">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <label class="block text-xs font-medium text-gray-700 mb-1">Điều kiện đặc biệt</label>
                        <textarea class="form-input text-sm" rows="2" id="special-conditions" 
                                placeholder="VD: Tránh gió mạnh, cần ánh sáng tự nhiên, không tiếp xúc với hóa chất..."></textarea>
                    </div>
                </div>

                <!-- Safety Requirements -->
                <div class="form-section">
                    <h4 class="font-semibold text-gray-700 mb-3 text-sm">Yêu cầu An toàn</h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Thiết bị bảo hộ bắt buộc</label>
                            <div class="space-y-2">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" class="w-4 h-4 text-emerald-600">
                                    <span class="text-sm">Găng tay</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" class="w-4 h-4 text-emerald-600">
                                    <span class="text-sm">Khẩu trang</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" class="w-4 h-4 text-emerald-600">
                                    <span class="text-sm">Kính bảo hộ</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" class="w-4 h-4 text-emerald-600">
                                    <span class="text-sm">Giày bảo hộ</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" class="w-4 h-4 text-emerald-600">
                                    <span class="text-sm">Áo phản quang</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Lưu ý an toàn</label>
                            <textarea class="form-input text-sm" rows="4" id="safety-notes" 
                                    placeholder="VD: Không hút thuốc khi sử dụng hóa chất, rửa tay sau khi làm việc, tránh tiếp xúc trực tiếp với da..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Integration -->
                <div class="form-section">
                    <h4 class="font-semibold text-gray-700 mb-3 text-sm">Tích hợp Hệ thống</h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="w-4 h-4 text-emerald-600" id="sync-weather">
                                <span class="text-sm">Đồng bộ dữ liệu thời tiết</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="w-4 h-4 text-emerald-600" id="sync-inventory">
                                <span class="text-sm">Đồng bộ kho vật tư</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" class="w-4 h-4 text-emerald-600" id="sync-finance">
                                <span class="text-sm">Đồng bộ hệ thống tài chính</span>
                            </label>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">API endpoint (tùy chọn)</label>
                            <input type="url" class="form-input text-sm" id="api-endpoint" 
                                   placeholder="https://api.example.com/tasks">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="form-section">
                <div class="flex justify-between">
                    <button class="btn-secondary text-sm" onclick="closeTaskModal()">
                        <i class="fas fa-times mr-2"></i>Hủy
                    </button>
                    <div class="space-x-2">
                        <button class="btn-secondary text-sm" onclick="saveAsDraft()">
                            <i class="fas fa-file-alt mr-2"></i>Lưu nháp
                        </button>
                        <button class="btn-secondary text-sm" onclick="duplicateTask()">
                            <i class="fas fa-copy mr-2"></i>Sao chép
                        </button>
                        <button class="btn-primary text-sm" onclick="saveTask()">
                            <i class="fas fa-save mr-2"></i>Lưu công việc
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPhase = null;
        let currentTask = null;
        
        // Template configurations with detailed phases and tasks
        const phaseTemplates = {
            'crops': {
                setupPhases: [
                    {
                        id: 1,
                        title: 'Khảo sát và Lập kế hoạch',
                        description: 'Đánh giá điều kiện và thiết kế quy hoạch sản xuất',
                        icon: 'fa-search',
                        tasks: [
                            'Khảo sát địa hình và thổ nhưỡng',
                            'Lập kế hoạch quy hoạch sản xuất', 
                            'Xin phép và thủ tục pháp lý',
                            'Lập dự toán chi phí đầu tư'
                        ]
                    },
                    {
                        id: 2,
                        title: 'Xây dựng Cơ sở hạ tầng',
                        description: 'Xây dựng và lắp đặt các hệ thống cần thiết',
                        icon: 'fa-hammer',
                        tasks: [
                            'Chuẩn bị mặt bằng',
                            'Xây dựng hệ thống tưới tiêu',
                            'Xây dựng nhà kho và công trình',
                            'Lắp đặt điện và hệ thống điều khiển'
                        ]
                    },
                    {
                        id: 3,
                        title: 'Chuẩn bị Đất và Gieo trồng',
                        description: 'Chuẩn bị đất và thực hiện gieo trồng',
                        icon: 'fa-seedling',
                        tasks: [
                            'Làm đất và cải tạo thổ nhưỡng',
                            'Chọn và mua giống chất lượng',
                            'Thực hiện gieo trồng đúng kỹ thuật',
                            'Chăm sóc cây non ban đầu'
                        ]
                    }
                ],
                recurringPhases: [
                    {
                        id: 4,
                        title: 'Tăng trưởng và Phát triển',
                        description: 'Chăm sóc cây trong giai đoạn phát triển',
                        icon: 'fa-chart-line',
                        tasks: [
                            'Tưới nước theo định kỳ',
                            'Bón phân định kỳ',
                            'Phòng trừ sâu bệnh',
                            'Tỉa cành và tạo tán',
                            'Giám sát tăng trưởng'
                        ]
                    },
                    {
                        id: 5,
                        title: 'Ra hoa và Thụ phấn',
                        description: 'Giai đoạn ra hoa và thụ phấn',
                        icon: 'fa-flower',
                        tasks: [
                            'Kích thích ra hoa',
                            'Điều chỉnh dinh dưỡng',
                            'Hỗ trợ thụ phấn',
                            'Chăm sóc hoa đặc biệt'
                        ]
                    },
                    {
                        id: 6,
                        title: 'Phát triển Quả',
                        description: 'Nuôi dưỡng quả đến khi thu hoạch',
                        icon: 'fa-apple-alt',
                        tasks: [
                            'Tỉa quả và chọn lọc',
                            'Bón phân nuôi quả',
                            'Bảo vệ quả',
                            'Theo dõi độ chín'
                        ]
                    },
                    {
                        id: 7,
                        title: 'Thu hoạch và Chế biến',
                        description: 'Thu hoạch và xử lý sơ bộ',
                        icon: 'fa-warehouse',
                        tasks: [
                            'Thu hoạch đúng kỹ thuật',
                            'Phân loại và đóng gói',
                            'Bảo quản và vận chuyển'
                        ]
                    }
                ]
            },
            'livestock': {
                setupPhases: [
                    {
                        id: 1,
                        title: 'Quy hoạch và Thiết kế',
                        description: 'Lập kế hoạch và thiết kế trang trại',
                        icon: 'fa-search',
                        tasks: [
                            'Khảo sát địa điểm',
                            'Thiết kế layout trang trại',
                            'Xin phép kinh doanh',
                            'Lập kế hoạch tài chính'
                        ]
                    },
                    {
                        id: 2,
                        title: 'Xây dựng Chuồng trại',
                        description: 'Xây dựng cơ sở vật chất',
                        icon: 'fa-hammer',
                        tasks: [
                            'Xây dựng chuồng nuôi',
                            'Lắp đặt hệ thống thông gió',
                            'Xây dựng hệ thống cấp thoát nước',
                            'Lắp đặt thiết bị chăn nuôi'
                        ]
                    },
                    {
                        id: 3,
                        title: 'Nhập đàn Giống',
                        description: 'Lựa chọn và nhập đàn giống',
                        icon: 'fa-horse',
                        tasks: [
                            'Chọn nhà cung cấp giống',
                            'Kiểm tra sức khỏe đàn giống',
                            'Vận chuyển và nhập chuồng',
                            'Thích nghi môi trường mới'
                        ]
                    }
                ],
                recurringPhases: [
                    {
                        id: 4,
                        title: 'Nuôi dưỡng và Chăm sóc',
                        description: 'Chăm sóc hàng ngày',
                        icon: 'fa-heart',
                        tasks: [
                            'Cho ăn định kỳ',
                            'Cung cấp nước sạch',
                            'Vệ sinh chuồng trại',
                            'Theo dõi sức khỏe'
                        ]
                    },
                    {
                        id: 5,
                        title: 'Sinh sản và Phối giống',
                        description: 'Quản lý sinh sản',
                        icon: 'fa-dna',
                        tasks: [
                            'Chọn lọc đực giống',
                            'Phối giống theo kế hoạch',
                            'Chăm sóc con cái mang thai',
                            'Hỗ trợ sinh nở'
                        ]
                    },
                    {
                        id: 6,
                        title: 'Nuôi con non',
                        description: 'Chăm sóc thế hệ mới',
                        icon: 'fa-baby',
                        tasks: [
                            'Chăm sóc con non',
                            'Cho ăn sữa/thức ăn đặc biệt',
                            'Tiêm phòng vaccine',
                            'Theo dõi tăng trọng'
                        ]
                    },
                    {
                        id: 7,
                        title: 'Xuất bán và Tái đàn',
                        description: 'Xuất bán và chuẩn bị đàn mới',
                        icon: 'fa-truck',
                        tasks: [
                            'Đánh giá và phân loại',
                            'Chuẩn bị xuất bán',
                            'Vận chuyển đến lò mổ/thị trường',
                            'Chuẩn bị đàn giống mới'
                        ]
                    }
                ]
            },
            'aquaculture': {
                setupPhases: [
                    {
                        id: 1,
                        title: 'Thiết kế Hệ thống',
                        description: 'Thiết kế và quy hoạch ao nuôi',
                        icon: 'fa-water',
                        tasks: [
                            'Khảo sát nguồn nước',
                            'Thiết kế hệ thống ao',
                            'Lập thủ tục pháp lý',
                            'Tính toán chi phí đầu tư'
                        ]
                    },
                    {
                        id: 2,
                        title: 'Xây dựng Ao và Hệ thống',
                        description: 'Thi công ao nuôi và thiết bị',
                        icon: 'fa-hammer',
                        tasks: [
                            'Đào và gia cố ao',
                            'Lắp đặt hệ thống sục khí',
                            'Xây dựng hệ thống cấp thoát nước',
                            'Lắp đặt thiết bị giám sát'
                        ]
                    },
                    {
                        id: 3,
                        title: 'Chuẩn bị Môi trường',
                        description: 'Chuẩn bị nước và môi trường nuôi',
                        icon: 'fa-flask',
                        tasks: [
                            'Xử lý và khử trùng ao',
                            'Cân bằng hệ sinh thái',
                            'Thả giống thử nghiệm',
                            'Ổn định các thông số nước'
                        ]
                    }
                ],
                recurringPhases: [
                    {
                        id: 4,
                        title: 'Thả giống và Nuôi ương',
                        description: 'Thả giống và giai đoạn ương',
                        icon: 'fa-fish',
                        tasks: [
                            'Chọn mua giống chất lượng',
                            'Thả giống đúng mật độ',
                            'Cho ăn giai đoạn ương',
                            'Giám sát tỷ lệ sống'
                        ]
                    },
                    {
                        id: 5,
                        title: 'Nuôi thương phẩm',
                        description: 'Nuôi lớn đến kích cỡ thương phẩm',
                        icon: 'fa-chart-line',
                        tasks: [
                            'Cho ăn định kỳ',
                            'Kiểm soát chất lượng nước',
                            'Phòng trừ dịch bệnh',
                            'Theo dõi tăng trưởng'
                        ]
                    },
                    {
                        id: 6,
                        title: 'Thu hoạch và Chế biến',
                        description: 'Thu hoạch và sơ chế',
                        icon: 'fa-warehouse',
                        tasks: [
                            'Chuẩn bị thu hoạch',
                            'Đánh bắt và phân loại',
                            'Bảo quản tươi sống',
                            'Vận chuyển đến thị trường'
                        ]
                    },
                    {
                        id: 7,
                        title: 'Vệ sinh và Chuẩn bị vụ mới',
                        description: 'Làm sạch và chuẩn bị chu kỳ mới',
                        icon: 'fa-broom',
                        tasks: [
                            'Vệ sinh và khử trùng ao',
                            'Sửa chữa thiết bị',
                            'Đánh giá hiệu quả vụ nuôi',
                            'Chuẩn bị cho vụ mới'
                        ]
                    }
                ]
            }
        };

        // Task detail templates
        const taskTemplates = {
            // Crop tasks
            'Khảo sát địa hình và thổ nhưỡng': {
                description: 'Đo đạc, phân tích đất, đánh giá nguồn nước và điều kiện khí hậu',
                resources: ['GPS, máy đo', 'Kit phân tích đất'],
                workers: '2-3 chuyên gia',
                skill: 'Chuyên gia'
            },
            'Tưới nước theo định kỳ': {
                description: 'Tưới nước đều đặn theo nhu cầu của cây trồng',
                resources: ['Hệ thống tưới', 'Máy bơm'],
                workers: '1-2 người',
                skill: 'Cơ bản'
            },
            // Livestock tasks  
            'Cho ăn định kỳ': {
                description: 'Cung cấp thức ăn theo định lượng và thời gian',
                resources: ['Thức ăn chăn nuôi', 'Thiết bị cho ăn'],
                workers: '2-3 người',
                skill: 'Cơ bản'
            },
            // Aquaculture tasks
            'Kiểm soát chất lượng nước': {
                description: 'Theo dõi và điều chỉnh các thông số chất lượng nước',
                resources: ['Kit test nước', 'Thiết bị sục khí'],
                workers: '1-2 người',
                skill: 'Trung bình'
            }
        };

        // Production type configurations
        const productionConfigs = {
            'crops': {
                objects: ['durian', 'mango', 'coffee', 'rice', 'vegetables'],
                varieties: {
                    'durian': ['dona', 'ri6', 'monthong', 'chanee'],
                    'mango': ['catchu', 'catngu', 'kensington'],
                    'coffee': ['arabica', 'robusta', 'liberica'],
                    'rice': ['st5', 'ir64', 'jasmine', 'organic']
                }
            },
            'livestock': {
                objects: ['pig', 'chicken', 'cattle', 'goat'],
                varieties: {
                    'pig': ['yorkshire', 'landrace', 'duroc', 'commercial'],
                    'chicken': ['broiler', 'layer', 'native', 'organic'],
                    'cattle': ['dairy', 'beef', 'mixed'],
                    'goat': ['dairy', 'meat', 'mixed']
                }
            },
            'aquaculture': {
                objects: ['fish', 'shrimp', 'crab', 'oyster'],
                varieties: {
                    'fish': ['tilapia', 'catfish', 'carp', 'seabass'],
                    'shrimp': ['vannamei', 'tiger', 'freshwater'],
                    'crab': ['mud', 'swimming', 'soft-shell'],
                    'oyster': ['pacific', 'kumamoto', 'native']
                }
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
            updateCycleType();
            updateProductionType();
            updateProgress();
            
            // Add event listeners for dynamic updates
            document.getElementById('process-description').addEventListener('input', updateProgress);
            document.getElementById('process-title').addEventListener('DOMSubtreeModified', updateProgress);
            
            // Show welcome message
            setTimeout(() => {
                const progress = updateProgress();
                if (progress < 50) {
                    console.log('💡 Gợi ý: Hãy thử chức năng "Tự động tạo giai đoạn" để bắt đầu nhanh!');
                }
            }, 1000);
        });

        // Template management
        function updateProductionType() {
            const productionType = document.getElementById('production-type').value;
            const specificObjectSelect = document.getElementById('specific-object');
            const varietySelect = document.getElementById('variety');
            
            // Update specific objects
            specificObjectSelect.innerHTML = '';
            if (productionConfigs[productionType]) {
                productionConfigs[productionType].objects.forEach(obj => {
                    const option = new Option(getObjectDisplayName(obj), obj);
                    specificObjectSelect.add(option);
                });
                updateSpecificObject();
            }
        }

        function updateSpecificObject() {
            const productionType = document.getElementById('production-type').value;
            const specificObject = document.getElementById('specific-object').value;
            const varietySelect = document.getElementById('variety');
            
            // Update varieties
            varietySelect.innerHTML = '';
            if (productionConfigs[productionType] && productionConfigs[productionType].varieties[specificObject]) {
                productionConfigs[productionType].varieties[specificObject].forEach(variety => {
                    const option = new Option(getVarietyDisplayName(variety), variety);
                    varietySelect.add(option);
                });
            }
            
            // Update process title
            updateProcessTitle();
        }

        function updateProcessTitle() {
            const specificObject = document.getElementById('specific-object').value;
            const variety = document.getElementById('variety').value;
            const scale = document.getElementById('scale').value;
            
            const objectName = getObjectDisplayName(specificObject);
            const varietyName = getVarietyDisplayName(variety);
            const scaleName = getScaleDisplayName(scale);
            
            const title = `Quy trình Sản xuất ${objectName} ${varietyName}`;
            const subtitle = `${scaleName} - Áp dụng tiêu chuẩn chất lượng cao`;
            
            document.getElementById('process-title').textContent = title;
            document.getElementById('process-subtitle').textContent = subtitle;
        }

        function getObjectDisplayName(obj) {
            const names = {
                'durian': 'Sầu riêng', 'mango': 'Xoài', 'coffee': 'Cà phê', 'rice': 'Lúa gạo',
                'pig': 'Heo', 'chicken': 'Gà', 'cattle': 'Bò', 'goat': 'Dê',
                'fish': 'Cá', 'shrimp': 'Tôm', 'crab': 'Cua', 'oyster': 'Hàu'
            };
            return names[obj] || obj;
        }

        function getVarietyDisplayName(variety) {
            const names = {
                'dona': 'Dona', 'ri6': 'Ri6', 'monthong': 'Monthong',
                'arabica': 'Arabica', 'robusta': 'Robusta',
                'yorkshire': 'Yorkshire', 'landrace': 'Landrace',
                'commercial': 'Thương phẩm', 'organic': 'Hữu cơ'
            };
            return names[variety] || variety;
        }

        function getScaleDisplayName(scale) {
            const names = {
                'small': 'Quy mô nhỏ', 'medium': 'Quy mô trung bình',
                'large': 'Quy mô lớn', 'industrial': 'Quy mô công nghiệp'
            };
            return names[scale] || scale;
        }

        function updateCycleType() {
            const cycleType = document.getElementById('cycle-type').value;
            // Update cycle configuration based on type
        }

        function toggleRecurringCycle() {
            const recurringPhases = document.querySelectorAll('.recurring-phase');
            const isEnabled = event.target.checked;
            
            recurringPhases.forEach(phase => {
                phase.style.opacity = isEnabled ? '1' : '0.6';
            });
        }

        function toggleCompactMode() {
            document.body.classList.toggle('compact-mode');
        }

        // Template operations
        function loadTemplate(templateId) {
            if (templates[templateId]) {
                const template = templates[templateId];
                
                document.getElementById('process-title').textContent = template.title;
                document.getElementById('process-subtitle').textContent = template.subtitle;
                document.getElementById('process-description').value = template.description;
                document.getElementById('production-type').value = template.productionType;
                document.getElementById('specific-object').value = template.specificObject;
                
                updateProductionType();
                
                alert(`Đã tải template: ${template.title}`);
            }
        }

        function exportTemplate() {
            const template = {
                title: document.getElementById('process-title').textContent,
                subtitle: document.getElementById('process-subtitle').textContent,
                description: document.getElementById('process-description').value,
                productionType: document.getElementById('production-type').value,
                specificObject: document.getElementById('specific-object').value,
                variety: document.getElementById('variety').value,
                phases: [], // Collect all phases data
                tasks: []   // Collect all tasks data
            };
            
            const dataStr = JSON.stringify(template, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = 'quy-trinh-template.json';
            link.click();
            
            URL.revokeObjectURL(url);
        }

        function importTemplate() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const template = JSON.parse(e.target.result);
                            // Apply template data to current form
                            document.getElementById('process-title').textContent = template.title;
                            document.getElementById('process-subtitle').textContent = template.subtitle;
                            document.getElementById('process-description').value = template.description;
                            
                            alert('Đã nhập template thành công!');
                        } catch (error) {
                            alert('Lỗi: File template không hợp lệ!');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            
            input.click();
        }

        // Auto generation functions
        function autoGeneratePhases() {
            const productionType = document.getElementById('production-type').value;
            const specificObject = document.getElementById('specific-object').value;
            
            if (confirm('Tự động tạo các giai đoạn chuẩn cho loại sản xuất này?\n\nLưu ý: Thao tác này sẽ xóa tất cả giai đoạn hiện tại.')) {
                // Clear existing phases
                document.getElementById('setup-phases').innerHTML = '';
                document.getElementById('recurring-phases').innerHTML = '';
                
                // Generate phases based on production type
                const template = phaseTemplates[productionType];
                if (template) {
                    generateSetupPhases(template.setupPhases);
                    generateRecurringPhases(template.recurringPhases);
                    updateStats();
                    alert(`✅ Đã tự động tạo ${template.setupPhases.length} giai đoạn thiết lập và ${template.recurringPhases.length} giai đoạn lặp lại!`);
                } else {
                    alert('Chưa có template cho loại sản xuất này!');
                }
            }
        }

        function generateSetupPhases(phases) {
            const container = document.getElementById('setup-phases');
            
            phases.forEach((phase, index) => {
                const phaseDiv = createPhaseElement(phase, 'setup', index + 1);
                container.appendChild(phaseDiv);
            });
        }

        function generateRecurringPhases(phases) {
            const container = document.getElementById('recurring-phases');
            
            phases.forEach((phase, index) => {
                const phaseDiv = createPhaseElement(phase, 'recurring', index + 4); // Start from phase 4
                container.appendChild(phaseDiv);
            });
        }

        function createPhaseElement(phase, type, phaseNumber) {
            const phaseDiv = document.createElement('div');
            phaseDiv.className = `phase-card ${type}-phase`;
            phaseDiv.setAttribute('data-phase', phaseNumber);
            
            const indicatorText = type === 'setup' ? 'Một lần' : 'Lặp lại';
            const indicatorClass = type === 'setup' ? 'setup-indicator' : '';
            
            let tasksHTML = '';
            phase.tasks.forEach((taskName, taskIndex) => {
                const taskDetail = taskTemplates[taskName] || {
                    description: 'Thực hiện theo quy trình chuẩn',
                    resources: ['Dụng cụ cơ bản'],
                    workers: '1-2 người',
                    skill: 'Trung bình'
                };
                
                tasksHTML += `
                    <div class="task-card" onclick="editTask(${phaseNumber}, ${taskIndex + 1})">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800 text-sm">${taskName}</h4>
                                <p class="text-xs text-gray-600 mt-1">${taskDetail.description}</p>
                                
                                <div class="flex flex-wrap mt-2">
                                    ${taskDetail.resources.map(resource => `
                                        <span class="resource-tag text-xs">
                                            <i class="fas fa-tools mr-1"></i>${resource}
                                        </span>
                                    `).join('')}
                                    <span class="resource-tag text-xs">
                                        <i class="fas fa-users mr-1"></i>${taskDetail.workers}
                                    </span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="skill-tag text-xs">${taskDetail.skill}</span>
                                <i class="fas fa-chevron-right text-gray-400 text-sm"></i>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            phaseDiv.innerHTML = `
                <div class="cycle-indicator ${indicatorClass}">${indicatorText}</div>
                <div class="phase-header phase-${phaseNumber}">
                    <div class="flex items-center flex-1">
                        <i class="fas ${phase.icon} mr-3 text-xl"></i>
                        <div>
                            <h3 class="text-base font-bold">Giai đoạn ${phaseNumber}: ${phase.title}</h3>
                            <p class="text-sm opacity-90">${phase.description}</p>
                        </div>
                    </div>
                    <div class="flex space-x-1">
                        <button class="text-white hover:text-red-200 p-2 text-sm" onclick="editPhase(${phaseNumber})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-white hover:text-red-200 p-2 text-sm" onclick="duplicatePhase(${phaseNumber})">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="text-white hover:text-red-200 p-2 text-sm" onclick="deletePhase(${phaseNumber})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="phase-content">
                    ${tasksHTML}
                    <div class="add-task-btn" onclick="addTask(${phaseNumber})">
                        <i class="fas fa-plus mr-2"></i>
                        <span class="text-sm">Thêm công việc</span>
                    </div>
                </div>
            `;
            
            return phaseDiv;
        }

        // Load template function with phases generation
        function loadTemplate(templateId) {
            const templates = {
                'durian-dona': {
                    title: 'Quy trình Canh tác Sầu riêng Dona',
                    subtitle: 'Dự án Nông Nghiệp Liên kết - SVIFARM',
                    description: 'Quy trình canh tác sầu riêng Dona quy chuẩn xuất khẩu',
                    productionType: 'crops',
                    specificObject: 'durian',
                    variety: 'dona'
                },
                'coffee-arabica': {
                    title: 'Quy trình Canh tác Cà phê Arabica',
                    subtitle: 'Sản xuất cà phê đặc sản chất lượng cao',
                    description: 'Quy trình sản xuất cà phê Arabica theo tiêu chuẩn quốc tế',
                    productionType: 'crops',
                    specificObject: 'coffee',
                    variety: 'arabica'
                },
                'rice-organic': {
                    title: 'Quy trình Sản xuất Lúa Hữu cơ',
                    subtitle: 'Nông nghiệp bền vững và thân thiện môi trường',
                    description: 'Quy trình sản xuất lúa hữu cơ không sử dụng hóa chất',
                    productionType: 'crops',
                    specificObject: 'rice',
                    variety: 'organic'
                },
                'pig-breeding': {
                    title: 'Quy trình Chăn nuôi Heo Thương phẩm',
                    subtitle: 'Chăn nuôi hiệu quả và an toàn sinh học',
                    description: 'Quy trình chăn nuôi heo thương phẩm quy mô công nghiệp',
                    productionType: 'livestock',
                    specificObject: 'pig',
                    variety: 'commercial'
                },
                'shrimp-farming': {
                    title: 'Quy trình Nuôi Tôm Thẻ Chân Trắng',
                    subtitle: 'Nuôi tôm công nghệ cao và bền vững',
                    description: 'Quy trình nuôi tôm thẻ chân trắng theo tiêu chuẩn ASC và BAP',
                    productionType: 'aquaculture',
                    specificObject: 'shrimp',
                    variety: 'vannamei'
                },
                'chicken-broiler': {
                    title: 'Quy trình Chăn nuôi Gà Thịt',
                    subtitle: 'Chăn nuôi gà thịt hiệu quả và an toàn thực phẩm',
                    description: 'Quy trình chăn nuôi gà thịt công nghiệp với chu kỳ 35-42 ngày',
                    productionType: 'livestock',
                    specificObject: 'chicken',
                    variety: 'broiler'
                }
            };
            
            if (templates[templateId]) {
                const template = templates[templateId];
                
                document.getElementById('process-title').textContent = template.title;
                document.getElementById('process-subtitle').textContent = template.subtitle;
                document.getElementById('process-description').value = template.description;
                document.getElementById('production-type').value = template.productionType;
                
                updateProductionType();
                
                document.getElementById('specific-object').value = template.specificObject;
                updateSpecificObject();
                
                // Auto generate phases after loading template
                setTimeout(() => {
                    autoGeneratePhases();
                }, 500);
                
                alert(`Đã tải template: ${template.title}`);
            }
        }

        function validateProcess() {
            // Validate the current process
            const issues = [];
            const warnings = [];
            const suggestions = [];
            
            const totalPhases = document.querySelectorAll('.phase-card').length;
            const setupPhases = document.querySelectorAll('.setup-phase').length;
            const recurringPhases = document.querySelectorAll('.recurring-phase').length;
            const totalTasks = document.querySelectorAll('.task-card').length;
            
            // Basic validation
            if (totalPhases < 3) {
                issues.push('❌ Cần ít nhất 3 giai đoạn cho quy trình hoàn chỉnh');
            }
            
            if (setupPhases < 1) {
                issues.push('❌ Cần ít nhất 1 giai đoạn thiết lập ban đầu');
            }
            
            if (recurringPhases < 2) {
                issues.push('❌ Cần ít nhất 2 giai đoạn lặp lại cho chu kỳ sản xuất');
            }
            
            if (totalTasks < 5) {
                issues.push('❌ Cần ít nhất 5 công việc cụ thể');
            }
            
            // Content validation
            const processTitle = document.getElementById('process-title').textContent;
            const processDescription = document.getElementById('process-description').value;
            
            if (processTitle.includes('Template') || processTitle.includes('Mẫu')) {
                warnings.push('⚠️ Nên đổi tên quy trình thành tên cụ thể');
            }
            
            if (processDescription.length < 50) {
                warnings.push('⚠️ Mô tả quy trình quá ngắn, nên mở rộng thêm');
            }
            
            // Advanced suggestions
            if (totalPhases >= 3 && totalTasks >= 10) {
                suggestions.push('✨ Quy trình đã khá đầy đủ, có thể bổ sung kiểm soát chất lượng');
            }
            
            if (recurringPhases >= 4) {
                suggestions.push('✨ Có thể thêm giai đoạn đánh giá hiệu quả định kỳ');
            }
            
            // Production type specific validation
            const productionType = document.getElementById('production-type').value;
            
            if (productionType === 'crops') {
                const hasGrowthPhase = Array.from(document.querySelectorAll('.phase-card h3')).some(h3 => 
                    h3.textContent.toLowerCase().includes('tăng trưởng') || 
                    h3.textContent.toLowerCase().includes('phát triển')
                );
                if (!hasGrowthPhase) {
                    warnings.push('⚠️ Cây trồng nên có giai đoạn "Tăng trưởng và Phát triển"');
                }
                
                const hasHarvestPhase = Array.from(document.querySelectorAll('.phase-card h3')).some(h3 => 
                    h3.textContent.toLowerCase().includes('thu hoạch')
                );
                if (!hasHarvestPhase) {
                    warnings.push('⚠️ Cây trồng nên có giai đoạn "Thu hoạch"');
                }
            }
            
            if (productionType === 'livestock') {
                const hasBreedingPhase = Array.from(document.querySelectorAll('.phase-card h3')).some(h3 => 
                    h3.textContent.toLowerCase().includes('sinh sản') || 
                    h3.textContent.toLowerCase().includes('phối giống')
                );
                if (!hasBreedingPhase) {
                    warnings.push('⚠️ Chăn nuôi nên có giai đoạn "Sinh sản/Phối giống"');
                }
            }
            
            if (productionType === 'aquaculture') {
                const hasWaterQualityTask = Array.from(document.querySelectorAll('.task-card h4')).some(h4 => 
                    h4.textContent.toLowerCase().includes('chất lượng nước')
                );
                if (!hasWaterQualityTask) {
                    warnings.push('⚠️ Thủy sản nên có công việc "Kiểm soát chất lượng nước"');
                }
            }
            
            // Show results
            let message = '';
            
            if (issues.length > 0) {
                message += '🔍 CÁC VẤN ĐỀ CẦN KHẮC PHỤC:\n' + issues.join('\n') + '\n\n';
            }
            
            if (warnings.length > 0) {
                message += '💡 KHUYẾN NGHỊ CẢI TIẾN:\n' + warnings.join('\n') + '\n\n';
            }
            
            if (suggestions.length > 0) {
                message += '🌟 GỢI Ý NÂNG CAO:\n' + suggestions.join('\n') + '\n\n';
            }
            
            if (issues.length === 0) {
                message += '✅ QUY TRÌNH HỢP LỆ VÀ SẴN SÀNG XUẤT BẢN!\n\n';
                message += `📊 Thống kê:\n`;
                message += `• Tổng: ${totalPhases} giai đoạn, ${totalTasks} công việc\n`;
                message += `• Thiết lập: ${setupPhases} giai đoạn\n`;
                message += `• Lặp lại: ${recurringPhases} giai đoạn\n`;
                
                // Calculate completeness score
                let score = 0;
                if (totalPhases >= 5) score += 25;
                if (totalTasks >= 15) score += 25;
                if (warnings.length === 0) score += 25;
                if (suggestions.length > 0) score += 25;
                
                message += `• Điểm chất lượng: ${score}/100\n`;
            }
            
            alert(message || '✅ Quy trình cơ bản hợp lệ!');
        }

        function previewProcess() {
            // Generate a preview summary
            const totalPhases = document.querySelectorAll('.phase-card').length;
            const totalTasks = document.querySelectorAll('.task-card').length;
            const progress = updateProgress();
            
            const productionType = document.getElementById('production-type').value;
            const specificObject = document.getElementById('specific-object').value;
            const processTitle = document.getElementById('process-title').textContent;
            
            const summary = `
📋 XEM TRƯỚC QUY TRÌNH

🎯 Tiêu đề: ${processTitle}
📊 Loại sản xuất: ${getObjectDisplayName(specificObject)} (${productionType})
⚡ Tiến độ hoàn thành: ${progress}%

📈 Thống kê:
• Tổng giai đoạn: ${totalPhases}
• Tổng công việc: ${totalTasks}
• Giai đoạn thiết lập: ${document.querySelectorAll('.setup-phase').length}
• Giai đoạn lặp lại: ${document.querySelectorAll('.recurring-phase').length}

🎯 Trạng thái: ${progress >= 80 ? '✅ Sẵn sàng xuất bản' : progress >= 60 ? '⚠️ Cần hoàn thiện thêm' : '❌ Cần bổ sung nhiều nội dung'}

💡 Để xem chi tiết đầy đủ, hãy xuất file hoặc xuất bản quy trình.
            `;
            
            alert(summary);
        }

        // Enhanced export function with more detailed data
        function exportTemplate() {
            const template = {
                metadata: {
                    title: document.getElementById('process-title').textContent,
                    subtitle: document.getElementById('process-subtitle').textContent,
                    description: document.getElementById('process-description').value,
                    productionType: document.getElementById('production-type').value,
                    specificObject: document.getElementById('specific-object').value,
                    variety: document.getElementById('variety').value,
                    scale: document.getElementById('scale').value,
                    cycleType: document.getElementById('cycle-type').value,
                    createdDate: new Date().toISOString(),
                    version: '1.0'
                },
                statistics: {
                    totalPhases: document.querySelectorAll('.phase-card').length,
                    setupPhases: document.querySelectorAll('.setup-phase').length,
                    recurringPhases: document.querySelectorAll('.recurring-phase').length,
                    totalTasks: document.querySelectorAll('.task-card').length,
                    completionProgress: updateProgress()
                },
                phases: [],
                configuration: {
                    recurringEnabled: document.querySelector('input[type="checkbox"]').checked,
                    startRecurringFrom: document.getElementById('start-recurring').value
                }
            };
            
            // Collect all phases and tasks data
            document.querySelectorAll('.phase-card').forEach((phaseEl, index) => {
                const phaseTitle = phaseEl.querySelector('h3').textContent;
                const phaseDescription = phaseEl.querySelector('p').textContent;
                const phaseType = phaseEl.classList.contains('setup-phase') ? 'setup' : 'recurring';
                
                const tasks = [];
                phaseEl.querySelectorAll('.task-card').forEach((taskEl, taskIndex) => {
                    const taskTitle = taskEl.querySelector('h4').textContent;
                    const taskDescription = taskEl.querySelector('p').textContent;
                    const resources = Array.from(taskEl.querySelectorAll('.resource-tag')).map(tag => tag.textContent.trim());
                    const skill = taskEl.querySelector('.skill-tag')?.textContent || 'Trung bình';
                    
                    tasks.push({
                        id: taskIndex + 1,
                        title: taskTitle,
                        description: taskDescription,
                        resources: resources,
                        skillLevel: skill
                    });
                });
                
                template.phases.push({
                    id: index + 1,
                    title: phaseTitle,
                    description: phaseDescription,
                    type: phaseType,
                    tasks: tasks
                });
            });
            
            const dataStr = JSON.stringify(template, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `quy-trinh-${template.metadata.specificObject}-${Date.now()}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            
            alert(`✅ Đã xuất file template thành công!\n\nFile: quy-trinh-${template.metadata.specificObject}-${Date.now()}.json\nBao gồm: ${template.statistics.totalPhases} giai đoạn, ${template.statistics.totalTasks} công việc`);
        }

        // Phase and task management
        function editPhase(phaseId) {
            alert(`Chỉnh sửa giai đoạn ${phaseId}`);
        }

        function duplicatePhase(phaseId) {
            if (confirm('Sao chép giai đoạn này?')) {
                alert('Đã sao chép giai đoạn');
                updateStats();
            }
        }

        function deletePhase(phaseId) {
            if (confirm('Xóa giai đoạn này?')) {
                document.querySelector(`[data-phase="${phaseId}"]`).remove();
                updateStats();
            }
        }

        function addNewPhase(type = 'recurring') {
            const newPhaseId = Date.now();
            const container = type === 'setup' ? 
                document.getElementById('setup-phases') : 
                document.getElementById('recurring-phases');
            
            const phaseDiv = document.createElement('div');
            phaseDiv.className = `phase-card ${type}-phase`;
            phaseDiv.setAttribute('data-phase', newPhaseId);
            
            phaseDiv.innerHTML = `
                <div class="cycle-indicator ${type === 'setup' ? 'setup-indicator' : ''}">
                    ${type === 'setup' ? 'Một lần' : 'Lặp lại'}
                </div>
                <div class="phase-header phase-3">
                    <div class="flex items-center flex-1">
                        <i class="fas fa-cog mr-3 text-xl"></i>
                        <div>
                            <h3 class="text-base font-bold">Giai đoạn mới</h3>
                            <p class="text-sm opacity-90">Nhấp để chỉnh sửa</p>
                        </div>
                    </div>
                    <div class="flex space-x-1">
                        <button class="text-white hover:text-red-200 p-2 text-sm" onclick="editPhase(${newPhaseId})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-white hover:text-red-200 p-2 text-sm" onclick="deletePhase(${newPhaseId})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="phase-content">
                    <div class="add-task-btn" onclick="addTask(${newPhaseId})">
                        <i class="fas fa-plus mr-2"></i>
                        <span class="text-sm">Thêm công việc</span>
                    </div>
                </div>
            `;
            
            container.appendChild(phaseDiv);
            updateStats();
        }

        function addTask(phaseId) {
            currentPhase = phaseId;
            currentTask = 'new';
            document.getElementById('task-modal').style.display = 'flex';
        }

        function editTask(phaseId, taskId) {
            currentPhase = phaseId;
            currentTask = taskId;
            document.getElementById('task-modal').style.display = 'flex';
        }

        function closeTaskModal() {
            document.getElementById('task-modal').style.display = 'none';
            currentPhase = null;
            currentTask = null;
        }

        function saveTask() {
            const taskName = document.getElementById('task-name').value;
            if (!taskName) {
                alert('Vui lòng nhập tên công việc!');
                return;
            }
            
            alert(`Đã lưu công việc: ${taskName}`);
            closeTaskModal();
            updateStats();
        }

        // Task modal management
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to selected tab button
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        }

        function updateTaskType() {
            const taskType = document.getElementById('task-type').value;
            
            // Auto-update task code based on type
            const codeInput = document.getElementById('task-code');
            if (!codeInput.value) {
                const codes = {
                    'soil-prep': 'SP',
                    'planting': 'PL',
                    'fertilizing': 'FT',
                    'watering': 'WT',
                    'pest-control': 'PC',
                    'pruning': 'PR',
                    'harvesting': 'HV',
                    'feeding': 'FD',
                    'breeding': 'BR',
                    'vaccination': 'VC',
                    'cleaning': 'CL',
                    'health-check': 'HC',
                    'water-quality': 'WQ',
                    'pond-prep': 'PP',
                    'stocking': 'ST',
                    'fish-feeding': 'FF'
                };
                
                if (codes[taskType]) {
                    const timestamp = Date.now().toString().substr(-3);
                    codeInput.value = codes[taskType] + '-' + timestamp;
                }
            }
        }

        function toggleFrequencyDetails() {
            const frequency = document.getElementById('task-frequency').value;
            const detailsDiv = document.getElementById('frequency-details');
            
            if (frequency === 'custom') {
                detailsDiv.style.display = 'block';
            } else {
                detailsDiv.style.display = 'none';
            }
        }

        // Material management
        function addMaterial() {
            const materialsList = document.getElementById('materials-list');
            const newMaterial = document.createElement('div');
            newMaterial.className = 'material-item bg-gray-50 rounded p-3';
            
            newMaterial.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-5 gap-2 items-center">
                    <input type="text" class="form-input text-sm" placeholder="Tên vật tư">
                    <input type="number" class="form-input text-sm" placeholder="Số lượng" step="0.1">
                    <select class="form-input text-sm">
                        <option value="kg">kg</option>
                        <option value="lit">lít</option>
                        <option value="cai">cái</option>
                        <option value="goi">gói</option>
                        <option value="thung">thùng</option>
                        <option value="tan">tấn</option>
                    </select>
                    <input type="number" class="form-input text-sm" placeholder="Đơn giá" step="1000">
                    <button class="btn-secondary text-xs" onclick="removeMaterial(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="mt-2">
                    <input type="text" class="form-input text-sm" placeholder="Nhà cung cấp (tùy chọn)">
                </div>
            `;
            
            materialsList.appendChild(newMaterial);
        }

        function removeMaterial(button) {
            button.closest('.material-item').remove();
            updateCostCalculation();
        }

        // Role management
        function addRole() {
            const roleAssignments = document.getElementById('role-assignments');
            const newRole = document.createElement('div');
            newRole.className = 'flex items-center space-x-2';
            
            newRole.innerHTML = `
                <select class="form-input text-sm w-32">
                    <option value="leader">Tổ trưởng</option>
                    <option value="technician">Kỹ thuật viên</option>
                    <option value="worker">Công nhân</option>
                    <option value="operator">Thao tác viên</option>
                </select>
                <input type="number" class="form-input text-sm w-16" placeholder="1" min="1">
                <span class="text-sm text-gray-600">người</span>
                <input type="text" class="form-input text-sm flex-1" placeholder="Mô tả nhiệm vụ cụ thể">
                <button class="btn-secondary text-xs" onclick="removeRole(this)">
                    <i class="fas fa-minus"></i>
                </button>
            `;
            
            roleAssignments.appendChild(newRole);
        }

        function removeRole(button) {
            button.parentElement.remove();
        }

        // Quality management
        function addQualityMetric() {
            // Implementation for adding quality metrics
            console.log('Add quality metric');
        }

        // Risk management
        function addRisk() {
            const riskList = document.getElementById('risk-list');
            const newRisk = document.createElement('div');
            newRisk.className = 'risk-item bg-yellow-50 border border-yellow-200 rounded p-3';
            
            newRisk.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                    <input type="text" class="form-input text-sm" placeholder="Rủi ro (VD: Mưa to)">
                    <select class="form-input text-sm">
                        <option value="low">Thấp</option>
                        <option value="medium">Trung bình</option>
                        <option value="high">Cao</option>
                    </select>
                    <button class="btn-secondary text-xs" onclick="removeRisk(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <input type="text" class="form-input text-sm mt-2" placeholder="Biện pháp phòng ngừa">
            `;
            
            riskList.appendChild(newRisk);
        }

        function removeRisk(button) {
            button.closest('.risk-item').remove();
        }

        // Cost calculation
        function updateCostCalculation() {
            const materialCost = parseFloat(document.getElementById('material-cost')?.value || 0);
            const laborCost = parseFloat(document.getElementById('labor-cost')?.value || 0);
            const equipmentCost = parseFloat(document.getElementById('equipment-cost')?.value || 0);
            const otherCost = parseFloat(document.getElementById('other-cost')?.value || 0);
            
            const totalCost = materialCost + laborCost + equipmentCost + otherCost;
            const quantity = parseFloat(document.getElementById('task-quantity')?.value || 1);
            const unitCost = quantity > 0 ? totalCost / quantity : totalCost;
            
            // Update display
            if (document.getElementById('material-cost-display')) {
                document.getElementById('material-cost-display').textContent = formatCurrency(materialCost);
                document.getElementById('labor-cost-display').textContent = formatCurrency(laborCost);
                document.getElementById('equipment-cost-display').textContent = formatCurrency(equipmentCost);
                document.getElementById('other-cost-display').textContent = formatCurrency(otherCost);
                document.getElementById('total-cost-display').textContent = formatCurrency(totalCost);
                document.getElementById('unit-cost-display').textContent = formatCurrency(unitCost);
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Enhanced task saving
        function saveTask() {
            const taskName = document.getElementById('task-name').value;
            if (!taskName) {
                alert('Vui lòng nhập tên công việc!');
                return;
            }
            
            const taskData = {
                basic: {
                    name: taskName,
                    code: document.getElementById('task-code').value,
                    type: document.getElementById('task-type').value,
                    priority: document.getElementById('task-priority').value,
                    status: document.getElementById('task-status').value,
                    description: document.getElementById('task-description').value,
                    location: document.getElementById('task-location').value,
                    quantity: document.getElementById('task-quantity').value,
                    unit: document.getElementById('task-unit').value
                },
                schedule: {
                    startDate: document.getElementById('task-start-date').value,
                    endDate: document.getElementById('task-end-date').value,
                    duration: document.getElementById('task-duration-hours').value,
                    frequency: document.getElementById('task-frequency').value,
                    bestTime: document.getElementById('task-best-time').value,
                    weather: document.getElementById('task-weather').value
                },
                resources: {
                    workers: document.getElementById('task-workers').value,
                    skill: document.getElementById('task-skill').value,
                    materials: collectMaterials(),
                    equipment: collectEquipment()
                },
                finance: {
                    materialCost: document.getElementById('material-cost')?.value || 0,
                    laborCost: document.getElementById('labor-cost')?.value || 0,
                    equipmentCost: document.getElementById('equipment-cost')?.value || 0,
                    otherCost: document.getElementById('other-cost')?.value || 0
                },
                quality: {
                    successCriteria: document.getElementById('success-criteria')?.value || '',
                    failureCriteria: document.getElementById('failure-criteria')?.value || '',
                    inspectionMethod: document.getElementById('inspection-method')?.value || ''
                }
            };
            
            // Validation
            const errors = validateTaskData(taskData);
            if (errors.length > 0) {
                alert('Vui lòng kiểm tra lại:\n' + errors.join('\n'));
                return;
            }
            
            // Calculate completeness score
            const completeness = calculateTaskCompleteness(taskData);
            
            alert(`✅ Đã lưu công việc: ${taskName}\n\nĐộ hoàn thiện: ${completeness}%\nMã công việc: ${taskData.basic.code || 'Tự động tạo'}`);
            closeTaskModal();
            updateStats();
        }

        function collectMaterials() {
            const materials = [];
            document.querySelectorAll('.material-item').forEach(item => {
                const inputs = item.querySelectorAll('input, select');
                if (inputs[0].value) { // If material name is filled
                    materials.push({
                        name: inputs[0].value,
                        quantity: inputs[1].value,
                        unit: inputs[2].value,
                        price: inputs[3].value,
                        supplier: inputs[4].value
                    });
                }
            });
            return materials;
        }

        function collectEquipment() {
            const equipment = [];
            document.querySelectorAll('#equipment-list input:checked').forEach(checkbox => {
                equipment.push(checkbox.value);
            });
            return equipment;
        }

        function validateTaskData(data) {
            const errors = [];
            
            if (!data.basic.name) errors.push('- Tên công việc là bắt buộc');
            if (!data.basic.type) errors.push('- Loại công việc là bắt buộc');
            if (!data.basic.description) errors.push('- Mô tả công việc là bắt buộc');
            if (!data.schedule.startDate) errors.push('- Ngày bắt đầu là bắt buộc');
            if (!data.resources.workers || data.resources.workers < 1) errors.push('- Số người cần phải ≥ 1');
            
            // Validate schedule logic
            if (data.schedule.startDate && data.schedule.endDate) {
                if (new Date(data.schedule.startDate) > new Date(data.schedule.endDate)) {
                    errors.push('- Ngày kết thúc phải sau ngày bắt đầu');
                }
            }
            
            return errors;
        }

        function calculateTaskCompleteness(data) {
            let score = 0;
            
            // Basic info (30%)
            if (data.basic.name) score += 5;
            if (data.basic.type) score += 5;
            if (data.basic.description && data.basic.description.length > 20) score += 10;
            if (data.basic.location) score += 5;
            if (data.basic.quantity) score += 5;
            
            // Schedule (25%)
            if (data.schedule.startDate) score += 10;
            if (data.schedule.endDate) score += 5;
            if (data.schedule.duration) score += 5;
            if (data.schedule.frequency) score += 5;
            
            // Resources (25%)
            if (data.resources.workers) score += 10;
            if (data.resources.skill) score += 5;
            if (data.resources.materials.length > 0) score += 5;
            if (data.resources.equipment.length > 0) score += 5;
            
            // Quality (10%)
            if (data.quality.successCriteria) score += 5;
            if (data.quality.inspectionMethod) score += 5;
            
            // Finance (10%)
            if (data.finance.materialCost > 0 || data.finance.laborCost > 0) score += 10;
            
            return Math.min(score, 100);
        }

        function saveAsDraft() {
            const taskName = document.getElementById('task-name').value || 'Công việc chưa đặt tên';
            alert(`💾 Đã lưu nháp: ${taskName}\n\nBạn có thể tiếp tục chỉnh sửa sau.`);
        }

        function duplicateTask() {
            alert('📋 Sao chép công việc\n\nTính năng này sẽ tạo một công việc mới với thông tin tương tự.');
        }

        // Add event listeners for cost calculation
        document.addEventListener('DOMContentLoaded', function() {
            // Cost calculation listeners
            ['material-cost', 'labor-cost', 'equipment-cost', 'other-cost', 'task-quantity'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', updateCostCalculation);
                }
            });
        });

        function saveQuick() {
            alert('Đã lưu nhanh quy trình!');
        }

        function publishProcess() {
            if (confirm('Xuất bản quy trình này?')) {
                alert('✅ Đã xuất bản quy trình thành công!');
            }
        }

        function updateStats() {
            const totalPhases = document.querySelectorAll('.phase-card').length;
            const setupPhases = document.querySelectorAll('.setup-phase').length;
            const recurringPhases = document.querySelectorAll('.recurring-phase').length;
            const totalTasks = document.querySelectorAll('.task-card').length;
            
            document.getElementById('total-phases').textContent = totalPhases;
            document.getElementById('setup-phases-count').textContent = setupPhases;
            document.getElementById('recurring-phases-count').textContent = recurringPhases;
            document.getElementById('task-count').textContent = totalTasks;
            
            updateProgress();
        }

        function updateProgress() {
            const totalPhases = document.querySelectorAll('.phase-card').length;
            const totalTasks = document.querySelectorAll('.task-card').length;
            const hasDescription = document.getElementById('process-description').value.length > 20;
            const hasTitle = !document.getElementById('process-title').textContent.includes('Template');
            
            // Calculate progress based on completeness
            let progress = 0;
            
            // Basic structure (40%)
            if (totalPhases >= 3) progress += 20;
            if (totalPhases >= 5) progress += 20;
            
            // Content richness (30%)
            if (totalTasks >= 5) progress += 15;
            if (totalTasks >= 10) progress += 15;
            
            // Configuration (20%)
            if (hasDescription) progress += 10;
            if (hasTitle) progress += 10;
            
            // Quality indicators (10%)
            const setupCount = document.querySelectorAll('.setup-phase').length;
            const recurringCount = document.querySelectorAll('.recurring-phase').length;
            if (setupCount >= 2 && recurringCount >= 3) progress += 10;
            
            // Cap at 100%
            progress = Math.min(progress, 100);
            
            // Update progress bar
            const progressBar = document.querySelector('.progress-fill');
            if (progressBar) {
                progressBar.style.width = progress + '%';
            }
            
            // Update progress text
            const progressText = document.querySelector('.progress-bar + p');
            if (progressText) {
                progressText.textContent = `${progress}% hoàn thành`;
            }
            
            return progress;
        }

        function previewProcess() {
            // Generate a preview summary
            const totalPhases = document.querySelectorAll('.phase-card').length;
            const totalTasks = document.querySelectorAll('.task-card').length;
            const progress = updateProgress();
            
            const productionType = document.getElementById('production-type').value;
            const specificObject = document.getElementById('specific-object').value;
            const processTitle = document.getElementById('process-title').textContent;
            
            const summary = `
📋 XEM TRƯỚC QUY TRÌNH

🎯 Tiêu đề: ${processTitle}
📊 Loại sản xuất: ${getObjectDisplayName(specificObject)} (${productionType})
⚡ Tiến độ hoàn thành: ${progress}%

📈 Thống kê:
• Tổng giai đoạn: ${totalPhases}
• Tổng công việc: ${totalTasks}
• Giai đoạn thiết lập: ${document.querySelectorAll('.setup-phase').length}
• Giai đoạn lặp lại: ${document.querySelectorAll('.recurring-phase').length}

🎯 Trạng thái: ${progress >= 80 ? '✅ Sẵn sàng xuất bản' : progress >= 60 ? '⚠️ Cần hoàn thiện thêm' : '❌ Cần bổ sung nhiều nội dung'}

💡 Để xem chi tiết đầy đủ, hãy xuất file hoặc xuất bản quy trình.
            `;
            
            alert(summary);
        }
    </script>
</body>
</html>